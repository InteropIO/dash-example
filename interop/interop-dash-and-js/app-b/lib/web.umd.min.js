!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).web=e.web||{},e.web.min=t())}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function e(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))}const t={logger:"trace",gateway:{webPlatform:{}},libraries:[]};var n=function(e){return{ok:!0,result:e}},i=function(e){return{ok:!1,error:e}},r=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},o=function(e,t){return!0===t.ok?t.result:e},s=function(e){if(!0===e.ok)return e.result;throw e.error},a=function(e,t){return!0===t.ok?n(e(t.result)):t},c=function(e,t,i){return!1===t.ok?t:!1===i.ok?i:n(e(t.result,i.result))},d=function(e,t){return!0===t.ok?t:i(e(t.error))},u=function(e,t){return!0===t.ok?e(t.result):t},h=(Object.freeze({ok:n,isOk:function(e){return!0===e.ok},err:i,isErr:function(e){return!1===e.ok},asPromise:r,withDefault:o,withException:s,successes:function(e){return e.reduce((function(e,t){return!0===t.ok?e.concat(t.result):e}),[])},map:a,map2:c,mapError:d,andThen:u}),function(){return(h=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)});var l=function(e){return Array.isArray(e)},p=function(e){return"object"==typeof e&&null!==e&&!l(e)},f=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},g=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},m=function(e,t){var n=t.at,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(t,["at"]);return h({at:e+(n||"")},i)},v=function(){function e(t){var n=this;this.decode=t,this.run=function(e){return d((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),n.decode(e))},this.runPromise=function(e){return r(n.run(e))},this.runWithException=function(e){return s(n.run(e))},this.map=function(t){return new e((function(e){return a(t,n.decode(e))}))},this.andThen=function(t){return new e((function(e){return u((function(n){return t(n).decode(e)}),n.decode(e))}))},this.where=function(t,i){return n.andThen((function(n){return t(n)?e.succeed(n):e.fail(i)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?n(e):i({message:f("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?n(e):i({message:f("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?n(e):i({message:f("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return function e(t,n){if(t===n)return!0;if(null===t&&null===n)return!0;if(typeof t!=typeof n)return!1;if("object"==typeof t){if(Array.isArray(t)){if(!Array.isArray(n))return!1;if(t.length!==n.length)return!1;for(var i=0;i<t.length;i++)if(!e(t[i],n[i]))return!1;return!0}var r=Object.keys(t);if(r.length!==Object.keys(n).length)return!1;for(i=0;i<r.length;i++){if(!n.hasOwnProperty(r[i]))return!1;if(!e(t[r[i]],n[r[i]]))return!1}return!0}}(e,t)?n(t):i({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(p(e)&&t){var r={};for(var o in t)if(t.hasOwnProperty(o)){var s=t[o].decode(e[o]);if(!0!==s.ok)return void 0===e[o]?i({message:"the key '"+o+"' is required but was not present"}):i(m("."+o,s.error));void 0!==s.result&&(r[o]=s.result)}return n(r)}return p(e)?n(e):i({message:f("an object",e)})}))},e.array=function(t){return new e((function(e){if(l(e)&&t){return e.reduce((function(e,n,i){return c((function(e,t){return e.concat([t])}),e,function(e,n){return d((function(e){return m("["+n+"]",e)}),t.decode(e))}(n,i))}),n([]))}return l(e)?n(e):i({message:f("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(l(e)){if(e.length!==t.length)return i({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],o=0;o<t.length;o++){var s=t[o].decode(e[o]);if(!s.ok)return i(m("["+o+"]",s.error));r[o]=s.result}return n(r)}return i({message:f("a tuple of length "+t.length,e)})}))},e.union=function(t,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return e.oneOf.apply(e,[t,n].concat(i))},e.intersection=function(t,i){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return new e((function(e){return[t,i].concat(r).reduce((function(t,n){return c(Object.assign,t,n.decode(e))}),n({}))}))},e.anyJson=function(){return new e((function(e){return n(e)}))},e.unknownJson=function(){return new e((function(e){return n(e)}))},e.dict=function(t){return new e((function(e){if(p(e)){var r={};for(var o in e)if(e.hasOwnProperty(o)){var s=t.decode(e[o]);if(!0!==s.ok)return i(m("."+o,s.error));r[o]=s.result}return n(r)}return i({message:f("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?n(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e((function(e){for(var n=[],r=0;r<t.length;r++){var o=t[r].decode(e);if(!0===o.ok)return o;n[r]=o.error}var s=n.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return i({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,i){return new e((function(e){return n(o(t,i.decode(e)))}))},e.valueAt=function(t,n){return new e((function(e){for(var r=e,o=0;o<t.length;o++){if(void 0===r)return i({at:g(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!p(r))return i({at:g(t.slice(0,o+1)),message:f("an object",r)});if("number"==typeof t[o]&&!l(r))return i({at:g(t.slice(0,o+1)),message:f("an array",r)});r=r[t[o]]}return d((function(e){return void 0===r?{at:g(t),message:"path does not exist"}:m(g(t),e)}),n.decode(r))}))},e.succeed=function(t){return new e((function(e){return n(t)}))},e.fail=function(t){return new e((function(e){return i({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),y=v.string,b=v.number,w=v.boolean,I=v.anyJson,x=v.constant,S=v.object,_=v.array,k=v.optional,M=v.oneOf,C=v.lazy;const T=y().where(e=>e.length>0,"Expected a non-empty string"),j=b().where(e=>e>=0,"Expected a non-negative number"),P=M(x("windows"),x("appManager"),x("layouts"),x("intents")),A=M(x("openWindow"),x("windowHello"),x("windowAdded"),x("windowRemoved"),x("getBounds"),x("getUrl"),x("moveResize"),x("focus"),x("close"),x("getTitle"),x("setTitle")),R=M(x("appHello"),x("applicationAdded"),x("applicationRemoved"),x("applicationChanged"),x("instanceStarted"),x("instanceStopped"),x("applicationStart"),x("instanceStop"),x("clear")),O=M(x("layoutAdded"),x("layoutChanged"),x("layoutRemoved"),x("get"),x("getAll"),x("export"),x("import"),x("remove")),E=M(x("top"),x("left"),x("right"),x("bottom")),N=k(S({top:k(b()),left:k(b()),width:k(j),height:k(j),context:k(I()),relativeTo:k(T),relativeDirection:k(E),windowId:k(T)})),D=S({name:T,url:T,options:N}),L=S({windowId:k(T)}),W=S({windowId:T,name:T}),q=S({windowId:T}),F=S({windows:_(W),isWorkspaceFrame:w()}),U=S({windowId:T,title:y()}),B=S({windowId:T,top:k(b()),left:k(b()),width:k(j),height:k(j),relative:k(w())}),H=S({windowId:T,bounds:S({top:b(),left:b(),width:j,height:j})}),J=S({windowId:T,url:T}),G=I(),K=S({top:k(b()),left:k(b()),width:k(j),height:k(j)}),V=S({id:T,applicationName:T}),z=S({url:T,top:k(b()),left:k(b()),width:k(j),height:k(j)}),$=S({name:T,displayName:k(y()),contexts:k(_(y())),customConfig:k(S())}),Y=S({name:T,title:k(T),version:k(T),appId:T,manifest:T,manifestType:T,tooltip:k(T),description:k(T),contactEmail:k(T),supportEmail:k(T),publisher:k(T),images:k(_(S({url:k(T)}))),icons:k(_(S({icon:k(T)}))),customConfig:I(),intents:k(_($))}),X=S({name:T,type:T.where(e=>"window"===e,"Expected a value of window"),title:k(T),version:k(T),customProperties:k(I()),icon:k(T),caption:k(T),details:z,intents:k(_($))}),Q=M(X,Y),Z=(S({definitions:_(Q),mode:M(x("replace"),x("merge"))}),S({name:T})),ee=S({definitions:_(X)}),te=S({name:T,type:T.where(e=>"window"===e,"Expected a value of window"),instances:_(V),userProperties:k(I()),title:k(T),version:k(T),icon:k(T),caption:k(T)}),ne=S({name:T,type:T.where(e=>"window"===e,"Expected a value of window"),userProperties:I(),title:k(T),version:k(T),icon:k(T),caption:k(T)}),ie=S({apps:_(te)}),re=S({id:T}),oe=S({name:T,waitForAGMReady:w(),context:k(I()),top:k(b()),left:k(b()),width:k(j),height:k(j),relativeTo:k(T),relativeDirection:k(M(x("top"),x("left"),x("right"),x("bottom")))}),se=M(x("Global"),x("Activity"),x("ApplicationDefault"),x("Swimlane"),x("Workspace")),ae=M(x("application"),x("activity")),ce=S({type:T.where(e=>"window"===e,"Expected a value of window"),componentType:k(ae),state:S({name:I(),context:I(),url:T,bounds:I(),id:T,parentId:k(T),main:w()})}),de=S({type:x("window"),config:S({appName:T,url:k(T)})}),ue=S({type:x("group"),config:I(),children:_(M(de))}),he=S({type:x("column"),config:I(),children:_(M(ue,de,C(()=>he),C(()=>le)))}),le=S({type:x("row"),config:I(),children:_(M(he,ue,de,C(()=>le)))}),pe=S({type:x("Workspace"),state:S({config:I(),context:I(),children:_(M(le,he,ue,de))})}),fe=S({name:T,type:se,components:_(M(ce,pe)),version:k(T),context:k(I()),metadata:k(I())}),ge=S({name:T,context:k(I()),metadata:k(I())}),me=S({name:T,context:k(I()),closeRunningInstance:k(w())}),ve=S({name:T,type:se,context:k(I()),metadata:k(I())}),ye=S({name:T,type:se}),be=S({type:se}),we=S({layouts:_(fe)}),Ie=M(x("replace"),x("merge")),xe=S({layouts:_(fe),mode:Ie}),Se=S({summaries:_(ve)}),_e=(S({layout:fe}),S({layout:k(fe)})),ke=M(x("findIntent"),x("getIntents"),x("raiseIntent")),Me=S({applicationName:T,applicationTitle:y(),applicationDescription:k(y()),applicationIcon:k(y()),type:M(x("app"),x("instance")),displayName:k(y()),contextTypes:k(_(T)),instanceId:k(y()),instanceTitle:k(y())}),Ce=S({name:T,handlers:_(Me)}),Te=M(x("startNew"),x("reuse"),S({app:k(T),instance:k(T)})),je=S({type:k(T),data:k(S())}),Pe=S({intents:_(Ce)}),Ae=S({name:k(T),contextType:k(T)}),Re=M(T,Ae),Oe=S({filter:k(Ae)}),Ee=S({intent:T,target:k(Te),context:k(je),options:k(N)}),Ne=M(T,Ee),De=S({request:Ee,handler:Me,result:I()}),Le=S({intent:T,contextTypes:k(_(T)),displayName:k(y()),icon:k(y()),description:k(y())}),We=M(T,Le),qe=e=>T.where(t=>e.includes(t),"Expected a valid channel name"),Fe={openWindow:{name:"openWindow",dataDecoder:D,resultDecoder:W},windowHello:{name:"windowHello",dataDecoder:L,resultDecoder:F},windowAdded:{name:"windowAdded",dataDecoder:W},windowRemoved:{name:"windowRemoved",dataDecoder:q},getBounds:{name:"getBounds",dataDecoder:q,resultDecoder:H},getUrl:{name:"getUrl",dataDecoder:q,resultDecoder:J},moveResize:{name:"moveResize",dataDecoder:B},focus:{name:"focus",dataDecoder:q},close:{name:"close",dataDecoder:q},getTitle:{name:"getTitle",dataDecoder:q,resultDecoder:U},setTitle:{name:"setTitle",dataDecoder:U}};function Ue(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(t)t(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,r){var o=n[e];return o||(o=[],n[e]=o),o.push(t),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(r)?t.apply(void 0,r):t.apply(void 0,[r])}catch(t){i(t,e)}}))}),0),function(){var i=n[e];i&&(i=i.reduce((function(e,n,i){return n===t&&e.length===i||e.push(n),e}),[]),n[e]=i)}},execute:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var o=n[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,t);s.push(r)}catch(t){s.push(void 0),i(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}Ue.default=Ue;var Be=Ue;class He{constructor(e,t,n){this._id=e,this._name=t,this._bridge=n,this.registry=Be(),this.myCtxKey="___window___"+this.id}get id(){return this._id.slice()}get name(){return this._name.slice()}clean(){this.ctxUnsubscribe&&this.ctxUnsubscribe()}toApi(){return e(this,void 0,void 0,(function*(){this.ctxUnsubscribe=yield this._bridge.contextLib.subscribe(this.myCtxKey,e=>this.registry.execute("context-updated",e));const e={id:this.id,name:this.name,getURL:this.getURL.bind(this),moveResize:this.moveResize.bind(this),resizeTo:this.resizeTo.bind(this),moveTo:this.moveTo.bind(this),focus:this.focus.bind(this),close:this.close.bind(this),getTitle:this.getTitle.bind(this),setTitle:this.setTitle.bind(this),getBounds:this.getBounds.bind(this),getContext:this.getContext.bind(this),updateContext:this.updateContext.bind(this),setContext:this.setContext.bind(this),onContextUpdated:this.onContextUpdated.bind(this)};return this.me=Object.freeze(e),this.me}))}getURL(){return e(this,void 0,void 0,(function*(){return(yield this._bridge.send("windows",Fe.getUrl,{windowId:this.id})).url}))}moveResize(t){return e(this,void 0,void 0,(function*(){const e=K.runWithException(t),n=Object.assign({},e,{windowId:this.id,relative:!1});return yield this._bridge.send("windows",Fe.moveResize,n),this.me}))}resizeTo(t,n){return e(this,void 0,void 0,(function*(){if(void 0===t&&void 0===n)return this.me;void 0!==t&&j.runWithException(t),void 0!==n&&j.runWithException(n);const e=Object.assign({},{width:t,height:n},{windowId:this.id,relative:!0});return yield this._bridge.send("windows",Fe.moveResize,e),this.me}))}moveTo(t,n){return e(this,void 0,void 0,(function*(){if(void 0===t&&void 0===n)return this.me;void 0!==t&&b().runWithException(t),void 0!==n&&b().runWithException(n);const e=Object.assign({},{top:t,left:n},{windowId:this.id,relative:!0});return yield this._bridge.send("windows",Fe.moveResize,e),this.me}))}focus(){return e(this,void 0,void 0,(function*(){return yield this._bridge.send("windows",Fe.focus,{windowId:this.id}),this.me}))}close(){return e(this,void 0,void 0,(function*(){return yield this._bridge.send("windows",Fe.close,{windowId:this.id}),this.me}))}getTitle(){return e(this,void 0,void 0,(function*(){return(yield this._bridge.send("windows",Fe.getTitle,{windowId:this.id})).title}))}setTitle(t){return e(this,void 0,void 0,(function*(){const e=T.runWithException(t);return yield this._bridge.send("windows",Fe.setTitle,{windowId:this.id,title:e}),this.me}))}getBounds(){return e(this,void 0,void 0,(function*(){return(yield this._bridge.send("windows",Fe.getBounds,{windowId:this.id})).bounds}))}getContext(){return e(this,void 0,void 0,(function*(){return yield this._bridge.contextLib.get(this.myCtxKey)}))}updateContext(t){return e(this,void 0,void 0,(function*(){const e=G.runWithException(t);return yield this._bridge.contextLib.update(this.myCtxKey,e),this.me}))}setContext(t){return e(this,void 0,void 0,(function*(){const e=G.runWithException(t);return yield this._bridge.contextLib.set(this.myCtxKey,e),this.me}))}onContextUpdated(e){if("function"!=typeof e)throw new Error("Cannot subscribe to context changes, because the provided callback is not a function!");return this.registry.add("context-updated",t=>{e(t,this.me)})}}class Je{constructor(){this.registry=Be(),this.allWindowProjections=[]}start(t,n){return e(this,void 0,void 0,(function*(){this.logger=t.logger.subLogger("windows.controller.web"),this.logger.trace("starting the web windows controller"),this.publicWindowId=t.connection.transport.publicWindowId,this.actualWindowId=t.interop.instance.windowId,this.addWindowOperationExecutors(),this.ioc=n,this.bridge=n.bridge,this.logger.trace(`set the public window id: ${this.publicWindowId} and actual window id: ${this.actualWindowId}, set the bridge operations and ioc, registering with the platform now`),this.platformRegistration=this.registerWithPlatform(),yield this.platformRegistration,this.logger.trace("registration with the platform successful, attaching the windows property to glue and returning");const e=this.toApi();t.windows=e}))}handleBridgeMessage(t){return e(this,void 0,void 0,(function*(){yield this.platformRegistration;const e=A.runWithException(t.operation),n=Fe[e];if(!n.execute)return;let i=t.data;return n.dataDecoder&&(i=n.dataDecoder.runWithException(t.data)),yield n.execute(i)}))}open(t,n,i){return e(this,void 0,void 0,(function*(){T.runWithException(t),T.runWithException(n);const e=N.runWithException(i),r=yield this.bridge.send("windows",Fe.openWindow,{name:t,url:n,options:e});return(yield this.ioc.buildWebWindow(r.windowId,r.name)).api}))}list(){return this.allWindowProjections.map(e=>e.api)}findById(e){var t;return T.runWithException(e),null===(t=this.allWindowProjections.find(t=>t.id===e))||void 0===t?void 0:t.api}toApi(){return{open:this.open.bind(this),my:this.my.bind(this),list:this.list.bind(this),findById:this.findById.bind(this),onWindowAdded:this.onWindowAdded.bind(this),onWindowRemoved:this.onWindowRemoved.bind(this)}}addWindowOperationExecutors(){Fe.windowAdded.execute=this.handleWindowAdded.bind(this),Fe.windowRemoved.execute=this.handleWindowRemoved.bind(this),Fe.getBounds.execute=this.handleGetBounds.bind(this),Fe.getTitle.execute=this.handleGetTitle.bind(this),Fe.getUrl.execute=this.handleGetUrl.bind(this),Fe.moveResize.execute=this.handleMoveResize.bind(this),Fe.setTitle.execute=this.handleSetTitle.bind(this)}my(){return Object.assign({},this.me)}onWindowAdded(e){if("function"!=typeof e)throw new Error("Cannot subscribe to window added, because the provided callback is not a function!");return this.registry.add("window-added",e)}onWindowRemoved(e){if("function"!=typeof e)throw new Error("Cannot subscribe to window removed, because the provided callback is not a function!");return this.registry.add("window-removed",e)}sayHello(){return e(this,void 0,void 0,(function*(){return yield this.bridge.send("windows",Fe.windowHello,{windowId:this.actualWindowId})}))}registerWithPlatform(){return e(this,void 0,void 0,(function*(){const{windows:e,isWorkspaceFrame:t}=yield this.sayHello();if(this.logger.trace("the platform responded to the hello message"),!t){this.logger.trace("i am not treated as a workspace frame, setting my window");const t=e.find(e=>e.windowId===this.publicWindowId);if(!t)throw new Error("Cannot initialize the window library, because I received no information about me from the platform");this.me=(yield this.ioc.buildWebWindow(this.publicWindowId,t.name)).api}const n=yield Promise.all(e.map(e=>this.ioc.buildWebWindow(e.windowId,e.name)));this.logger.trace("all windows projections are completed, building the list collection"),this.allWindowProjections.push(...n)}))}handleWindowAdded(t){return e(this,void 0,void 0,(function*(){if(this.allWindowProjections.some(e=>e.id===t.windowId))return;const e=yield this.ioc.buildWebWindow(t.windowId,t.name);this.allWindowProjections.push(e),this.registry.execute("window-added",e.api)}))}handleWindowRemoved(t){return e(this,void 0,void 0,(function*(){const e=this.allWindowProjections.find(e=>e.id===t.windowId);e&&(this.allWindowProjections=this.allWindowProjections.filter(e=>e.id!==t.windowId),e.model.clean(),this.registry.execute("window-removed",e.api))}))}handleGetBounds(){return e(this,void 0,void 0,(function*(){return{windowId:this.me.id,bounds:{top:window.screenTop,left:window.screenLeft,width:window.innerWidth,height:window.innerHeight}}}))}handleGetTitle(){return e(this,void 0,void 0,(function*(){return{windowId:this.me.id,title:document.title}}))}handleGetUrl(){return e(this,void 0,void 0,(function*(){return{windowId:this.me.id,url:window.location.href}}))}handleMoveResize(t){return e(this,void 0,void 0,(function*(){const e="number"==typeof t.top?t.top:t.relative?0:window.screenTop,n="number"==typeof t.left?t.left:t.relative?0:window.screenLeft,i="number"==typeof t.height?t.height:t.relative?0:window.innerHeight,r="number"==typeof t.width?t.width:t.relative?0:window.innerWidth,o=t.relative?window.moveBy:window.moveTo,s=t.relative?window.resizeBy:window.resizeTo;o(n,e),s(r,i)}))}handleSetTitle(t){return e(this,void 0,void 0,(function*(){document.title=t.title}))}}const Ge="T42.Web.Platform.Control",Ke="T42.Web.Platform.Stream";class Ve{constructor(e){this.coreGlue=e,this.platformMethodTimeoutMs=1e4}get contextLib(){return this.coreGlue.contexts}get interopInstance(){return this.coreGlue.interop.instance.instance}start(t){return e(this,void 0,void 0,(function*(){this.controllers=t,yield Promise.all([this.checkWaitMethod(Ge),this.checkWaitMethod(Ke)]);const[e]=yield Promise.all([this.coreGlue.interop.subscribe(Ke),this.coreGlue.interop.registerAsync("T42.Web.Client.Control",(e,t,n,i)=>this.passMessageController(e,n,i))]);this.sub=e,this.sub.onData(e=>this.passMessageController(e.data))}))}getInteropInstance(e){const t=this.coreGlue.interop.servers().find(t=>t.windowId&&t.windowId===e);return{application:null==t?void 0:t.application,applicationName:null==t?void 0:t.applicationName,peerId:null==t?void 0:t.peerId,instance:null==t?void 0:t.instance,windowId:null==t?void 0:t.windowId}}send(t,n,i){return e(this,void 0,void 0,(function*(){if(n.dataDecoder)try{n.dataDecoder.runWithException(i)}catch(e){throw new Error(`Unexpected internal outgoing validation error: ${e.message}, for operation: ${n.name} and input: ${JSON.stringify(e.input)}`)}let e;try{e=yield this.transmitMessage(t,n,i),n.resultDecoder&&(e=n.resultDecoder.runWithException(e))}catch(e){if(e.kind)throw new Error(`Unexpected internal incoming validation error: ${e.message}, for operation: ${n.name} and input: ${JSON.stringify(e.input)}`);throw new Error(e.message)}return e}))}checkWaitMethod(e){return t=t=>{if(this.coreGlue.interop.methods().some(t=>t.name===e))return t();const n=this.coreGlue.interop.methodAdded(i=>{i.name===e&&(n(),t())})},n=this.platformMethodTimeoutMs,i="Cannot initiate Glue Web, because a system method's discovery timed out: "+e,new Promise((e,r)=>{const o=setTimeout(()=>{r(i||"Promise timeout hit: "+n)},n);new Promise(t).then(t=>{clearTimeout(o),e(t)}).catch(e=>{clearTimeout(o),r(e)})});var t,n,i}passMessageController(e,t,n){const i=P.run(e.domain);if(!i.ok)return void(n&&n("Cannot execute this client control, because of domain validation error: "+JSON.stringify(i.error)));const r=i.result;this.controllers[r].handleBridgeMessage(e).then(e=>{t&&t(e)}).catch(e=>{n&&n(e),console.warn(e)})}transmitMessage(t,n,i){return e(this,void 0,void 0,(function*(){const e={domain:t,data:i,operation:n.name};let r;const o=`Internal Platform Communication Error. Attempted operation: ${JSON.stringify(n.name)} with data: ${JSON.stringify(i)}. `;try{if(r=yield this.coreGlue.interop.invoke(Ge,e),!r)throw new Error("Received unsupported result from the platform - empty result");if(!Array.isArray(r.all_return_values)||0===r.all_return_values.length)throw new Error("Received unsupported result from the platform - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${o} -> Inner message: ${t}`)}throw new Error(`${o} -> Inner message: ${e.message}`)}return r.all_return_values[0].returned}))}}const ze={appHello:{name:"appHello",dataDecoder:L,resultDecoder:ie},applicationAdded:{name:"applicationAdded",dataDecoder:ne},applicationRemoved:{name:"applicationRemoved",dataDecoder:ne},applicationChanged:{name:"applicationChanged",dataDecoder:ne},instanceStarted:{name:"instanceStarted",dataDecoder:V},instanceStopped:{name:"instanceStopped",dataDecoder:V},applicationStart:{name:"applicationStart",dataDecoder:oe,resultDecoder:V},instanceStop:{name:"instanceStop",dataDecoder:re},import:{name:"import"},remove:{name:"remove",dataDecoder:Z},export:{name:"export",resultDecoder:ee},clear:{name:"clear"}};class $e{constructor(){this.registry=Be(),this.applications=[],this.instances=[]}start(t,n){return e(this,void 0,void 0,(function*(){this.logger=t.logger.subLogger("appManger.controller.web"),this.logger.trace("starting the web appManager controller"),this.publicWindowId=t.connection.transport.publicWindowId,this.actualWindowId=t.interop.instance.windowId,this.addOperationsExecutors(),this.ioc=n,this.bridge=n.bridge,this.platformRegistration=this.registerWithPlatform(),yield this.platformRegistration,this.logger.trace("registration with the platform successful, attaching the appManager property to glue and returning");const e=this.toApi();t.appManager=e}))}handleBridgeMessage(t){return e(this,void 0,void 0,(function*(){yield this.platformRegistration;const e=R.runWithException(t.operation),n=ze[e];if(!n.execute)return;let i=t.data;return n.dataDecoder&&(i=n.dataDecoder.runWithException(t.data)),yield n.execute(i)}))}onInstanceStarted(e){return this.registry.add("instance-started",e,this.instances)}onInstanceStopped(e){return this.registry.add("instance-stopped",e)}startApplication(t,n,i){var r;return e(this,void 0,void 0,(function*(){const e={name:t,waitForAGMReady:null===(r=null==i?void 0:i.waitForAGMReady)||void 0===r||r,context:n,top:null==i?void 0:i.top,left:null==i?void 0:i.left,width:null==i?void 0:i.width,height:null==i?void 0:i.height,relativeTo:null==i?void 0:i.relativeTo,relativeDirection:null==i?void 0:i.relativeDirection},o=yield this.bridge.send("appManager",ze.applicationStart,e),s=this.applications.find(e=>e.name===o.applicationName);return this.ioc.buildInstance(o,s)}))}toApi(){const e={myInstance:this.me,inMemory:{import:this.import.bind(this),remove:this.remove.bind(this),export:this.export.bind(this),clear:this.clear.bind(this)},application:this.getApplication.bind(this),applications:this.getApplications.bind(this),instances:this.getInstances.bind(this),onAppAdded:this.onAppAdded.bind(this),onAppChanged:this.onAppChanged.bind(this),onAppRemoved:this.onAppRemoved.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)};return Object.freeze(e)}addOperationsExecutors(){ze.applicationAdded.execute=this.handleApplicationAddedMessage.bind(this),ze.applicationRemoved.execute=this.handleApplicationRemovedMessage.bind(this),ze.applicationChanged.execute=this.handleApplicationChangedMessage.bind(this),ze.instanceStarted.execute=this.handleInstanceStartedMessage.bind(this),ze.instanceStopped.execute=this.handleInstanceStoppedMessage.bind(this)}onAppAdded(e){return this.registry.add("application-added",e,this.applications)}onAppRemoved(e){return this.registry.add("application-removed",e)}onAppChanged(e){return this.registry.add("application-changed",e)}handleApplicationAddedMessage(t){return e(this,void 0,void 0,(function*(){if(this.applications.some(e=>e.name===t.name))return;const e=yield this.ioc.buildApplication(t,[]),n=this.instances.filter(t=>t.application.name===e.name);e.instances.push(...n),this.applications.push(e),this.registry.execute("application-added",e)}))}handleApplicationRemovedMessage(t){return e(this,void 0,void 0,(function*(){const e=this.applications.findIndex(e=>e.name===t.name);if(e<0)return;const n=this.applications[e];this.applications.splice(e,1),this.registry.execute("application-removed",n)}))}handleApplicationChangedMessage(t){return e(this,void 0,void 0,(function*(){const e=this.applications.find(e=>e.name===t.name);if(!e)return this.handleApplicationAddedMessage(t);e.title=t.title,e.version=t.version,e.icon=t.icon,e.caption=t.caption,e.userProperties=t.userProperties,this.registry.execute("application-changed",e)}))}handleInstanceStartedMessage(t){return e(this,void 0,void 0,(function*(){if(this.instances.some(e=>e.id===t.id))return;const e=this.applications.find(e=>e.name===t.applicationName);if(!e)throw new Error(`Cannot add instance: ${t.id}, because there is no application definition associated with it`);const n=this.ioc.buildInstance(t,e);this.instances.push(n),e.instances.push(n),this.registry.execute("instance-started",n)}))}handleInstanceStoppedMessage(t){return e(this,void 0,void 0,(function*(){const e=this.instances.find(e=>e.id===t.id);if(e){const e=this.instances.findIndex(e=>e.id===t.id);this.instances.splice(e,1)}const n=this.applications.find(e=>e.instances.some(e=>e.id===t.id));if(n){const e=n.instances.findIndex(e=>e.id===t.id);n.instances.splice(e,1)}e&&this.registry.execute("instance-stopped",e)}))}import(t,n="replace"){return e(this,void 0,void 0,(function*(){if(Ie.runWithException(n),!Array.isArray(t))throw new Error("Import must be called with an array of definitions");const e=t.reduce((e,t)=>{const n=Q.run(t);return n.ok?e.valid.push(t):e.invalid.push({app:null==t?void 0:t.name,error:JSON.stringify(n.error)}),e},{valid:[],invalid:[]});return yield this.bridge.send("appManager",ze.import,{definitions:e.valid,mode:n}),{imported:e.valid.map(e=>e.name),errors:e.invalid}}))}remove(t){return e(this,void 0,void 0,(function*(){T.runWithException(t),yield this.bridge.send("appManager",ze.remove,{name:t})}))}clear(){return e(this,void 0,void 0,(function*(){yield this.bridge.send("appManager",ze.clear,void 0)}))}export(){return e(this,void 0,void 0,(function*(){return(yield this.bridge.send("appManager",ze.export,void 0)).definitions}))}getApplication(e){const t=T.runWithException(e);return this.applications.find(e=>e.name===t)}getApplications(){return this.applications.slice()}getInstances(){return this.instances.slice()}registerWithPlatform(){return e(this,void 0,void 0,(function*(){const e=yield this.bridge.send("appManager",ze.appHello,{windowId:this.actualWindowId});this.logger.trace("the platform responded to the hello message with a full list of apps"),this.applications=yield Promise.all(e.apps.map(e=>this.ioc.buildApplication(e,e.instances))),this.instances=this.applications.reduce((e,t)=>(e.push(...t.instances),e),[]),this.me=this.findMyInstance(),this.logger.trace(`all applications were parsed and saved. I am ${this.me?"NOT a":"a"} valid instance`)}))}findMyInstance(){for(const e of this.applications){const t=e.instances.find(e=>e.id===this.publicWindowId);if(t)return t}}}class Ye{constructor(e,t,n){this.data=e,this.bridge=t,this.application=n,this.myCtxKey="___instance___"+this.data.id}toApi(){const e=this.bridge.getInteropInstance(this.data.id),t={id:this.data.id,agm:e,application:this.application,stop:this.stop.bind(this),getContext:this.getContext.bind(this)};return this.me=Object.freeze(t),this.me}getContext(){return e(this,void 0,void 0,(function*(){return this.bridge.contextLib.get(this.myCtxKey)}))}stop(){return e(this,void 0,void 0,(function*(){yield this.bridge.send("appManager",ze.instanceStop,{id:this.data.id})}))}}class Xe{constructor(e,t,n){this.data=e,this.instances=t,this.controller=n}toApi(){const e={name:this.data.name,title:this.data.title,version:this.data.version,icon:this.data.icon,caption:this.data.caption,userProperties:this.data.userProperties,instances:this.instances,start:this.start.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)};return this.me=e,this.me}onInstanceStarted(e){if("function"!=typeof e)throw new Error("OnInstanceStarted requires a single argument of type function");this.controller.onInstanceStarted(t=>{t.application.name===this.data.name&&e(t)})}onInstanceStopped(e){if("function"!=typeof e)throw new Error("OnInstanceStarted requires a single argument of type function");this.controller.onInstanceStopped(t=>{t.application.name===this.data.name&&e(t)})}start(t,n){return e(this,void 0,void 0,(function*(){return this.controller.startApplication(this.data.name,t,n)}))}}const Qe={layoutAdded:{name:"layoutAdded",dataDecoder:fe},layoutChanged:{name:"layoutChanged",dataDecoder:fe},layoutRemoved:{name:"layoutRemoved",dataDecoder:fe},get:{name:"get",dataDecoder:ye,resultDecoder:_e},getAll:{name:"getAll",dataDecoder:be,resultDecoder:Se},export:{name:"export",dataDecoder:be,resultDecoder:we},import:{name:"import",dataDecoder:xe},remove:{name:"remove",dataDecoder:ye}};class Ze{constructor(){this.registry=Be()}start(t,n){return e(this,void 0,void 0,(function*(){this.logger=t.logger.subLogger("layouts.controller.web"),this.logger.trace("starting the web layouts controller"),this.bridge=n.bridge,this.addOperationsExecutors();const e=this.toApi();this.logger.trace("no need for platform registration, attaching the layouts property to glue and returning"),t.layouts=e}))}handleBridgeMessage(t){return e(this,void 0,void 0,(function*(){const e=O.runWithException(t.operation),n=Qe[e];if(!n.execute)return;let i=t.data;return n.dataDecoder&&(i=n.dataDecoder.runWithException(t.data)),yield n.execute(i)}))}toApi(){const e={get:this.get.bind(this),getAll:this.getAll.bind(this),export:this.export.bind(this),import:this.import.bind(this),save:this.save.bind(this),restore:this.restore.bind(this),remove:this.remove.bind(this),onAdded:this.onAdded.bind(this),onChanged:this.onChanged.bind(this),onRemoved:this.onRemoved.bind(this)};return Object.freeze(e)}addOperationsExecutors(){Qe.layoutAdded.execute=this.handleOnAdded.bind(this),Qe.layoutChanged.execute=this.handleOnChanged.bind(this),Qe.layoutRemoved.execute=this.handleOnRemoved.bind(this)}get(t,n){return e(this,void 0,void 0,(function*(){T.runWithException(t),se.runWithException(n);return(yield this.bridge.send("layouts",Qe.get,{name:t,type:n})).layout}))}getAll(t){return e(this,void 0,void 0,(function*(){se.runWithException(t);return(yield this.bridge.send("layouts",Qe.getAll,{type:t})).summaries}))}export(t){return e(this,void 0,void 0,(function*(){t&&se.runWithException(t);return(yield this.bridge.send("layouts",Qe.export,{type:"Workspace"})).layouts}))}import(t,n="replace"){return e(this,void 0,void 0,(function*(){if(Ie.runWithException(n),!Array.isArray(t))throw new Error("Import must be called with an array of layouts");const e=t.reduce((e,t)=>{const n=fe.run(t);return n.ok?e.valid.push(t):this.logger.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(n.error)}`),e},{valid:[]});yield this.bridge.send("layouts",Qe.import,{layouts:e.valid,mode:n})}))}save(t){return e(this,void 0,void 0,(function*(){throw ge.runWithException(t),new Error("Save is not supported in Core at the moment")}))}restore(t){return e(this,void 0,void 0,(function*(){throw me.runWithException(t),new Error("Restore is not supported in Core at the moment")}))}remove(t,n){return e(this,void 0,void 0,(function*(){se.runWithException(t),T.runWithException(n),yield this.bridge.send("layouts",Qe.remove,{type:t,name:n})}))}onAdded(e){return this.registry.add(Qe.layoutAdded.name,e)}onChanged(e){return this.registry.add(Qe.layoutChanged.name,e)}onRemoved(e){return this.registry.add(Qe.layoutRemoved.name,e)}handleOnAdded(t){return e(this,void 0,void 0,(function*(){this.registry.execute(Qe.layoutAdded.name,t)}))}handleOnChanged(t){return e(this,void 0,void 0,(function*(){this.registry.execute(Qe.layoutChanged.name,t)}))}handleOnRemoved(t){return e(this,void 0,void 0,(function*(){this.registry.execute(Qe.layoutRemoved.name,t)}))}}class et{start(t){return e(this,void 0,void 0,(function*(){this.logger=t.logger.subLogger("notifications.controller.web"),this.logger.trace("starting the web notifications controller"),this.interop=t.interop;const e=this.toApi();t.notifications=e,this.logger.trace("notifications are ready")}))}handleBridgeMessage(){return e(this,void 0,void 0,(function*(){}))}toApi(){const e={raise:this.raise.bind(this)};return Object.freeze(e)}raise(t){return e(this,void 0,void 0,(function*(){if(!("Notification"in window))throw new Error("this browser does not support desktop notification");let e;e="granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission(),yield e;const n=this.raiseUsingWebApi(t);if(t.clickInterop){const e=t.clickInterop;n.onclick=()=>{var t,n;this.interop.invoke(e.method,null!==(t=null==e?void 0:e.arguments)&&void 0!==t?t:{},null!==(n=null==e?void 0:e.target)&&void 0!==n?n:"best")}}return n}))}raiseUsingWebApi(e){return new Notification(e.title)}}const tt={getIntents:{name:"getIntents",resultDecoder:Pe},findIntent:{name:"findIntent",dataDecoder:Oe,resultDecoder:Pe},raiseIntent:{name:"raiseIntent",dataDecoder:Ee,resultDecoder:De}};class nt{constructor(){this.myIntents=new Set,this.GlueWebIntentsPrefix="Tick42.FDC3.Intents."}start(t,n){return e(this,void 0,void 0,(function*(){this.logger=t.logger.subLogger("intents.controller.web"),this.logger.trace("starting the web intents controller"),this.bridge=n.bridge,this.interop=t.interop;const e=this.toApi();this.logger.trace("no need for platform registration, attaching the intents property to glue and returning"),t.intents=e}))}handleBridgeMessage(t){return e(this,void 0,void 0,(function*(){const e=ke.runWithException(t.operation),n=tt[e];if(!n.execute)return;let i=t.data;return n.dataDecoder&&(i=n.dataDecoder.runWithException(t.data)),yield n.execute(i)}))}toApi(){const e={raise:this.raise.bind(this),all:this.all.bind(this),addIntentListener:this.addIntentListener.bind(this),find:this.find.bind(this)};return Object.freeze(e)}raise(t){return e(this,void 0,void 0,(function*(){const e=Ne.runWithException(t);let n;n="string"==typeof e?{intent:e}:e;return yield this.bridge.send("intents",tt.raiseIntent,n)}))}all(){return e(this,void 0,void 0,(function*(){return(yield this.bridge.send("intents",tt.getIntents,void 0)).intents}))}addIntentListener(e,t){if(We.runWithException(e),"function"!=typeof t)throw new Error("Cannot add intent listener, because the provided handler is not a function!");let n=!0;const i="string"==typeof e?e:e.intent,r=`${this.GlueWebIntentsPrefix}${i}`;if(this.myIntents.has(i))throw new Error(`Intent listener for intent ${i} already registered!`);this.myIntents.add(i);const o={unsubscribe:()=>{n=!1;try{this.interop.unregister(r),this.myIntents.delete(i)}catch(e){this.logger.trace(`Unsubscribed intent listener, but ${r} unregistration failed!`)}}},s="string"==typeof e?{intent:e}:e;return this.interop.register({name:r,flags:s},e=>{if(n)return t(e)}),o}find(t){return e(this,void 0,void 0,(function*(){let e=void 0;if(void 0!==t){const n=Re.runWithException(t);"string"==typeof n?e={filter:{name:n}}:"object"==typeof n&&(e={filter:n})}return(yield this.bridge.send("intents",tt.findIntent,e)).intents}))}}class it{constructor(){this.registry=Be(),this.GlueWebChannelsPrefix="___channel___",this.SubsKey="subs",this.ChangedKey="changed"}start(t){return e(this,void 0,void 0,(function*(){this.logger=t.logger.subLogger("channels.controller.web"),this.logger.trace("starting the web channels controller"),this.contexts=t.contexts,this.logger.trace("no need for platform registration, attaching the channels property to glue and returning");const e=this.toApi();t.channels=e}))}handleBridgeMessage(){return e(this,void 0,void 0,(function*(){}))}toApi(){const e={subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),publish:this.publish.bind(this),all:this.all.bind(this),list:this.list.bind(this),get:this.get.bind(this),join:this.join.bind(this),leave:this.leave.bind(this),current:this.current.bind(this),my:this.my.bind(this),changed:this.changed.bind(this),onChanged:this.onChanged.bind(this),add:this.add.bind(this)};return Object.freeze(e)}createContextName(e){return`${this.GlueWebChannelsPrefix}${e}`}getAllChannelNames(){return this.contexts.all().filter(e=>e.startsWith(this.GlueWebChannelsPrefix)).map(e=>e.replace(this.GlueWebChannelsPrefix,""))}unsubscribe(){this.unsubscribeFunc&&(this.unsubscribeFunc(),this.unsubscribeFunc=void 0)}switchToChannel(t){return e(this,void 0,void 0,(function*(){if(this.unsubscribe(),this.currentChannelName=t,void 0!==t){const e=this.createContextName(t);this.unsubscribeFunc=yield this.contexts.subscribe(e,(e,t,n,i,r)=>{this.registry.execute(this.SubsKey,e.data,e,null==r?void 0:r.updaterId)})}this.registry.execute(this.ChangedKey,t)}))}updateData(t,n){return e(this,void 0,void 0,(function*(){const e=this.createContextName(t);if(this.contexts.setPathSupported){const t=Object.keys(n).map(e=>({path:"data."+e,value:n[e]}));yield this.contexts.setPaths(e,t)}else yield this.contexts.update(e,{data:n})}))}subscribe(e){if("function"!=typeof e)throw new Error("Cannot subscribe to channels, because the provided callback is not a function!");return this.registry.add(this.SubsKey,e)}subscribeFor(t,n){return e(this,void 0,void 0,(function*(){const e=this.getAllChannelNames();if(qe(e).runWithException(t),"function"!=typeof n)throw new Error(`Cannot subscribe to channel ${t}, because the provided callback is not a function!`);const i=this.createContextName(t);return this.contexts.subscribe(i,(e,t,i,r,o)=>{n(e.data,e,null==o?void 0:o.updaterId)})}))}publish(e,t){if("object"!=typeof e)throw new Error("Cannot publish to channel, because the provided data is not an object!");if(void 0!==t){const n=this.getAllChannelNames();return qe(n).runWithException(t),this.updateData(t,e)}if(void 0===this.currentChannelName)throw new Error("Cannot publish to channel, because not joined to a channel!");return this.updateData(this.currentChannelName,e)}all(){return e(this,void 0,void 0,(function*(){return this.getAllChannelNames()}))}list(){return e(this,void 0,void 0,(function*(){const e=this.getAllChannelNames();return yield Promise.all(e.map(e=>this.get(e)))}))}get(e){const t=this.getAllChannelNames();qe(t).runWithException(e);const n=this.createContextName(e);return this.contexts.get(n)}join(t){return e(this,void 0,void 0,(function*(){const e=this.getAllChannelNames();qe(e).runWithException(t),yield this.switchToChannel(t)}))}leave(){return e(this,void 0,void 0,(function*(){yield this.switchToChannel()}))}current(){return this.currentChannelName}my(){return this.current()}changed(e){if("function"!=typeof e)throw new Error("Cannot subscribe to channel changed, because the provided callback is not a function!");return this.registry.add(this.ChangedKey,e)}onChanged(e){return this.changed(e)}add(e){throw new Error("Method `add()` isn't implemented.")}}class rt{constructor(e){this.coreGlue=e,this.controllers={windows:this.windowsController,appManager:this.appManagerController,layouts:this.layoutsController,notifications:this.notificationsController,intents:this.intentsController,channels:this.channelsController}}get windowsController(){return this._windowsControllerInstance||(this._windowsControllerInstance=new Je),this._windowsControllerInstance}get appManagerController(){return this._appManagerControllerInstance||(this._appManagerControllerInstance=new $e),this._appManagerControllerInstance}get layoutsController(){return this._layoutsControllerInstance||(this._layoutsControllerInstance=new Ze),this._layoutsControllerInstance}get notificationsController(){return this._notificationsControllerInstance||(this._notificationsControllerInstance=new et),this._notificationsControllerInstance}get intentsController(){return this._intentsControllerInstance||(this._intentsControllerInstance=new nt),this._intentsControllerInstance}get channelsController(){return this._channelsControllerInstance||(this._channelsControllerInstance=new it),this._channelsControllerInstance}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new Ve(this.coreGlue)),this._bridgeInstance}buildWebWindow(t,n){return e(this,void 0,void 0,(function*(){const e=new He(t,n,this.bridge),i=yield e.toApi();return{id:t,model:e,api:i}}))}buildApplication(t,n){return e(this,void 0,void 0,(function*(){const e=new Xe(t,[],this.appManagerController).toApi(),i=n.map(t=>this.buildInstance(t,e));return e.instances.push(...i),e}))}buildInstance(e,t){return new Ye(e,this.bridge,t).toApi()}}var ot="2.0.5";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
var st=function(e,t){return(st=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function at(e,t){function n(){this.constructor=e}st(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var ct=function(){return(ct=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function dt(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?r(e.value):new n((function(t){t(e.value)})).then(s,a)}c((i=i.apply(e,t||[])).next())}))}function ut(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function ht(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var lt=1,pt=2,ft=3,gt=4;function mt(e){return e.type===ft?"timestamp":e.type===pt?"number":e.type===lt?"string":e.type===gt?"object":"unknown"}function vt(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function yt(e){var t={},n=mt(e);if("object"===n){var i=Object.keys(e.value).reduce((function(t,n){var i=vt(e.value[n]);if("object"===i){var r=function e(t){return Object.keys(t).reduce((function(n,i){var r=vt(t[i]);return n[i]="object"===r?{type:"object",description:"",context:{},composite:e(t[i])}:{type:r,description:"",context:{}},n}),{})}(e.value[n]);t[n]={type:"object",description:"",context:{},composite:r}}else t[n]={type:i,description:"",context:{}};return t}),{});t.composite=i}return t.name=bt(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function bt(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function wt(e){return"timestamp"===mt(e)?Date.now():function e(t){if("object"!=typeof t)return t;return Object.keys(t).reduce((function(n,i){var r=t[i];return"object"==typeof r&&r.constructor!==Date?n[i]=e(r):r.constructor===Date?n[i]=new Date(r).getTime():r.constructor===Boolean?n[i]=r.toString():n[i]=r,n}),{})}(e.value)}function It(e){var t=function e(t){return t.reduce((function(t,n){return t.concat(Array.isArray(n)?e(n):n)}),[])}(e.root.getAggregateState()),n=t.sort((function(e,t){return e.state?t.state?t.state-e.state:-1:1}))[0];return{description:function(e){var t="";return e.forEach((function(e,n,i){var r=e.path.join(".");n===i.length-1?t+=r+"."+e.name+": "+e.description:t+=r+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t),value:n.state}}var xt=function(e,t,n){if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},St=function(){function e(e,t,n,i,r){this.definition=e,this.system=t,this.transport=n,this.value=i,this.type=r,this.path=[],xt(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}return Object.defineProperty(e.prototype,"repo",{get:function(){var e;return null===(e=this.system)||void 0===e?void 0:e.repo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),e.prototype.update=function(e){return this.value=e,this.transport.updateMetric(this)},e}(),_t=function(e){function t(t,n,i,r){return e.call(this,t,n,i,r,pt)||this}return at(t,e),t.prototype.incrementBy=function(e){this.update(this.value+e)},t.prototype.increment=function(){this.incrementBy(1)},t.prototype.decrement=function(){this.incrementBy(-1)},t.prototype.decrementBy=function(e){this.incrementBy(-1*e)},t}(St),kt=function(e){function t(t,n,i,r){return e.call(this,t,n,i,r,gt)||this}return at(t,e),t.prototype.update=function(e){return this.mergeValues(e),this.transport.updateMetric(this)},t.prototype.mergeValues=function(e){var t=this;return Object.keys(this.value).forEach((function(n){void 0!==e[n]&&(t.value[n]=e[n])}))},t}(St),Mt=function(e){function t(t,n,i,r){return e.call(this,t,n,i,r,lt)||this}return at(t,e),t}(St),Ct=function(e){function t(t,n,i,r){return e.call(this,t,n,i,r,ft)||this}return at(t,e),t.prototype.now=function(){this.update(new Date)},t}(St);var Tt=function(){function e(e,t){t.init(this),this.root=function e(t,n,i,r,o){if(!n)throw new Error("Repository is required");if(!i)throw new Error("Transport is required");var s,a,c=i,d=t,u=o||"",h=n,l=r,p=function e(t){if(!t||!t.parent)return[];var n=e(t.parent);return n.push(t.name),n}(r),f={},g=(a="/",((s=p)&&s.length>0?s.join(a):"")+t),m=n.root,v=[],y=[];function b(e,t,n,i){var r={name:""};r="string"==typeof e?{name:e}:e;var o=y.filter((function(e){return e.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==t)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=i(r);return y.push(a),a}var w={get name(){return d},get description(){return u},get repo(){return h},get parent(){return l},path:p,id:g,root:m,get subSystems(){return v},get metrics(){return y},subSystem:function(t,n){if(!t||0===t.length)throw new Error("name is required");var i=v.filter((function(e){return e.name===t}));if(i.length>0)return i[0];var r=e(t,h,c,w,n);return v.push(r),r},getState:function(){return f},setState:function(e,t){f={state:e,description:t},c.updateSystem(w,f)},stringMetric:function(e,t){return b(e,lt,t,(function(e){return new Mt(e,w,c,t)}))},timestampMetric:function(e,t){return b(e,ft,t,(function(e){return new Ct(e,w,c,t)}))},objectMetric:function(e,t){return b(e,gt,t,(function(e){return new kt(e,w,c,t)}))},numberMetric:function(e,t){return b(e,pt,t,(function(e){return new _t(e,w,c,t)}))},getAggregateState:function(){var e=[];return Object.keys(f).length>0&&e.push({name:d,path:p,state:f.state,description:f.description}),v.forEach((function(t){var n=t.getAggregateState();n.length>0&&e.push.apply(e,n)})),e}};return c.createSystem(w),w}("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}return e.prototype.addSystemMetrics=function(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){var n=e.subSystem("ClickStream"),i=function(e){if(e.target){var t=e.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:e.target?t.className:"",id:t.id,type:"<"+t.tagName.toLowerCase()+">",href:t.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}e.stringMetric("StartTime",(new Date).toString());var r=e.stringMetric("StartURL",""),o=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},e}(),jt=function(){function e(){}return e.prototype.init=function(e){},e.prototype.createSystem=function(e){return Promise.resolve()},e.prototype.updateSystem=function(e,t){return Promise.resolve()},e.prototype.createMetric=function(e){return Promise.resolve()},e.prototype.updateMetric=function(e){return Promise.resolve()},e}(),Pt=function(){function e(e,t,n){this.api=e,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=t?t:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return e.prototype.scheduleCollection=function(){var e=this;setTimeout((function(){e.collect(),setInterval((function(){e.collect()}),e.publishInterval)}),this.initialPublishTimeout)},e.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(e){}},e.prototype.collectMemory=function(){var e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))},e.prototype.collectEntries=function(){var e=window.performance.getEntries();e.length<=this.lastCount||(this.lastCount=e.length,this.system.stringMetric("entries",JSON.stringify(e)))},e}(),At=function(e){var t;t=e.connection&&"object"==typeof e.connection?function(e,t){var n,i,r=this;if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");var o=function(e){s(e.root)},s=function(e){a(e),e.metrics.forEach((function(e){c(e)})),e.subSystems.forEach((function(e){s(e)}))},a=function(e){return dt(r,void 0,void 0,(function(){var t,r;return ut(this,(function(o){switch(o.label){case 0:return void 0===e.parent?[2]:[4,n];case 1:return o.sent(),t={name:bt(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},r={type:"define",metrics:[t]},i.send(r),[2]}}))}))},c=function(e){return dt(r,void 0,void 0,(function(){var t,r,o;return ut(this,(function(s){switch(s.label){case 0:return t=u(e),[4,n];case 1:return s.sent(),r=yt(t),o={type:"define",metrics:[r]},i.send(o),void 0!==t.value&&d(t),[2]}}))}))},d=function(e){if(h()){var t=wt(e),n={type:"publish",values:[{name:bt(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return i.sendFireAndForget(n)}return Promise.resolve()},u=function(e){var t=ct({},e);return"object"==typeof e.value&&null!==e.value&&(t.value=ct({},e.value)),t},h=function(){var e;try{return(null!==(e=t.canUpdateMetric)&&void 0!==e?e:function(){return!0})()}catch(e){return!0}};return{init:function(r){var s;n=new Promise((function(e){s=e})),(i=e.domain("metrics")).onJoined((function(e){!e&&s&&(s(),s=void 0);var t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(t),e&&o(r)})),i.join({system:t.system,service:t.service,instance:t.instance})},createSystem:a,updateSystem:function(t,o){return dt(r,void 0,void 0,(function(){var r,s,a;return ut(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),r={type:"publish",values:[{name:bt(t.path.join("/")+"/"+t.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]},i.send(r),s=It(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},i.send(a),[2]}}))}))},createMetric:c,updateMetric:function(e){return dt(r,void 0,void 0,(function(){var t;return ut(this,(function(i){switch(i.label){case 0:return t=u(e),[4,n];case 1:return i.sent(),d(t),[2]}}))}))}}}(e.connection,e):new jt;var n=new Tt(e,t).root;e.disableAutoAppSystem||(n=n.subSystem("App"));var i=function(e){var t,n=e.subSystem("reporting"),i={name:"features"},r=function(e,r,o){if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");t?t.update({name:e,action:r,payload:o}):t=n.objectMetric(i,{name:e,action:r,payload:o})};return e.featureMetric=r,e}(n);return function(e,t){var n,i;if("undefined"==typeof window)return;var r=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;r&&(t=r);(null==t?void 0:t.enabled)&&new Pt(e,t.initialPublishTimeout,t.publishInterval)}(i,e.pagePerformanceMetrics),i};function Rt(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(t)t(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,r){var o=n[e];return o||(o=[],n[e]=o),o.push(t),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(r)?t.apply(void 0,r):t.apply(void 0,[r])}catch(t){i(t,e)}}))}),0),function(){var i=n[e];i&&(0===(i=i.reduce((function(e,n,i){return n===t&&e.length===i||e.push(n),e}),[])).length?delete n[e]:n[e]=i)}},execute:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var o=n[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,t);s.push(r)}catch(t){s.push(void 0),i(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}Rt.default=Rt;var Ot=Rt,Et=function(){function e(e,t){var n=this;this.registry=Ot(),this.gw=e.facade,this.gw.connect((function(e,t){n.messageHandler(t)})).then((function(e){n.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"in-memory"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),Nt=function(){function e(e,t){var n=this;this.logger=t,this.registry=Ot(),this.worker=new SharedWorker(e),this.worker.port.onmessage=function(e){n.messageHandler(e.data)}}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.worker.port.postMessage(e),Promise.resolve()},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"shared-worker"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),Dt=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?void 0:e}},e.isNode=function(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode},e}(),Lt=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,n){e.resolve=function(n){e.resolved=!0,t(n)},e.reject=function(t){e.rejected=!0,n(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),Wt={};function qt(e){var t=Wt[e];if(t)return t;var n=[];function i(){return(new Date).getTime()}var r,o,s=i();function a(e,t){var r=null!=t?t:i(),o=0;n.length>0&&(o=r-n[n.length-1].time),n.push({name:e,time:r,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return o},stop:function(){return a("end",r=i()),o=r-s},mark:a,marks:n};return Wt[e]=c,c}var Ft=Dt.isNode()?require("ws"):window.WebSocket,Ut=function(){function e(e,t){if(this.startupTimer=qt("connection"),this._running=!0,this._registry=Ot(),this.wsRequests=[],this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t){var n=this;return new Promise((function(t,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(e),t()}catch(e){i(e)}}),i)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,n){e.waitForSocketConnection(t,n)}))},e.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.name=function(){return"ws "+this.settings.ws},e.prototype.reconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close();var t=new Lt;return this.waitForSocketConnection((function(){t.resolve()})),t.promise},e.prototype.waitForSocketConnection=function(e,t){var n;t=null!=t?t:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.openSocket=function(e,t){return dt(this,void 0,void 0,(function(){var n=this;return ut(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0!==t){if(0===t)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+t+" more times (every "+e+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===t?void 0:t-1;n.openSocket(e,i)}),e),[3,4];case 4:return[2]}}))}))},e.prototype.initiateSocket=function(){var e=this,t=new Lt;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new Ft(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(e){var r=new WeakSet;i=JSON.stringify(n,(function(e,t){if("object"==typeof t&&null!==t){if(r.has(t))return;r.add(t)}return t}))}t.reject("error"),e.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){e.logger.info("ws closed "+n),t.reject("closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;e.startupTimer.mark("ws-opened"),e.logger.info("ws opened "+(null===(n=e.settings.identity)||void 0===n?void 0:n.application)),t.resolve(),e.notifyStatusChanged(!0)},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.notifyForSocketState=function(e){this.wsRequests.forEach((function(t){e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}();var Bt=1;var Ht,Jt,Gt,Kt={nextValue:function(){return(Bt=(9301*Bt+49297)%233280)/233280},seed:function(e){Bt=e}},Vt="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function zt(){Gt=!1}function $t(e){if(e){if(e!==Ht){if(e.length!==Vt.length)throw new Error("Custom alphabet for shortid must be "+Vt.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+Vt.length+" unique characters. These characters were not unique: "+t.join(", "));Ht=e,zt()}}else Ht!==Vt&&(Ht=Vt,zt())}function Yt(){return Gt||(Gt=function(){Ht||$t(Vt);for(var e,t=Ht.split(""),n=[],i=Kt.nextValue();t.length>0;)i=Kt.nextValue(),e=Math.floor(i*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var Xt={characters:function(e){return $t(e),Ht},seed:function(e){Kt.seed(e),Jt!==e&&(zt(),Jt=e)},lookup:function(e){return Yt()[e]},shuffled:Yt},Qt="object"==typeof window&&(window.crypto||window.msCrypto);var Zt=function(){if(!Qt||!Qt.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return Qt.getRandomValues(e),48&e[0]};var en=function(e,t){for(var n,i=0,r="";!n;)r+=e(t>>4*i&15|Zt()),n=t<Math.pow(16,i+1),i++;return r};var tn=function(e){var t=Xt.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var nn=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=Xt.characters(),n=e.length,i=0;i<n;i++)if(-1===t.indexOf(e[i]))return!1;return!0},rn=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n,i=0;function r(){var e="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?t++:(t=0,n=r),e+=en(Xt.lookup,6),e+=en(Xt.lookup,i),t>0&&(e+=en(Xt.lookup,t)),e+=en(Xt.lookup,r)}e.exports=r,e.exports.generate=r,e.exports.seed=function(t){return Xt.seed(t),e.exports},e.exports.worker=function(t){return i=t,e.exports},e.exports.characters=function(e){return void 0!==e&&Xt.characters(e),Xt.shuffled()},e.exports.decode=tn,e.exports.isValid=nn})),on=(rn.generate,rn.seed,rn.worker,rn.characters,rn.decode,rn.isValid,rn);function sn(e,t,n,i,r){null==e&&(e="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,d=Ot();t.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,d.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),h(o))})),t.on("success",(function(e){return p(e)})),t.on("error",(function(e){return l(e)})),t.on("result",(function(e){return p(e)})),i&&i.forEach((function(e){t.on(e,(function(e){return p(e)}))})),r&&r.forEach((function(e){t.on(e,(function(e){return l(e)}))}));var u={};function h(t){return o=t,new Promise((function(i,r){if(s)i();else{var o;if("global"===e)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+e),o=g({type:"join",destination:e,domain:"global",options:t});o.then((function(){!function(){n.debug("did join "+e),s=!0;var t=a;a=!1,d.execute("onJoined",t)}(),i()})).catch((function(t){n.debug("error joining "+e+" domain: "+JSON.stringify(t)),r(t)}))}}))}function l(t){if(e===t.domain){var n=t.request_id;if(n){var i=u[n];i&&i.error(t)}}}function p(t){if(t.domain===e){var n=t.request_id;if(n){var i=u[n];i&&i.success(t)}}}function f(){return on()}function g(i,r,o){o=o||{},i.request_id=i.request_id||f(),i.domain=i.domain||e,o.skipPeerId||(i.peer_id=t.peerId);var s=i.request_id;return new Promise((function(e,a){u[s]={success:function(t){delete u[s],t._tag=r,e(t)},error:function(e){n.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(i)),delete u[s],e._tag=r,a(e)}},t.send(i,o).catch((function(e){u[s].error({err:e})}))}))}return{join:h,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,g({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,d.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),d.add("onJoined",e)},onLeft:function(e){return s||e(),d.add("onLeft",e)},send:g,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain||e,n.peer_id=t.peerId,t.send(n)},on:function(i,r){t.on(i,(function(t){if(t.domain===e)try{r(t)}catch(e){n.error("Callback  failed: "+e+" \n "+e.stack+" \n msg was: "+JSON.stringify(t),e)}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var an=function(){function e(e,t,n){var i=this;this.connection=e,this.settings=t,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=Ot(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],e.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=this,n=JSON.parse(e,(function(e,n){if("string"!=typeof n)return n;if(n.length<t.dateMinLen)return n;if(n[0]!==t.datePrefixFirstChar)return n;if(n.substring(0,t.datePrefixLen)!==t.datePrefix)return n;try{var i=parseInt(n.substring(t.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(e){return n}}));return{msg:n,msgType:n.type}},e.prototype.createStringMessage=function(e){var t=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}},e.prototype.processObjectMessage=function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},e.prototype.createObjectMessage=function(e){return e},e.prototype.login=function(e,t){return dt(this,void 0,void 0,(function(){var n,i,r,o,s,a,c,d,u,h;return ut(this,(function(l){switch(l.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=e.gatewayToken,!e.gatewayToken)return[3,5];if(!t)return[3,4];l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return d=l.sent(),e.gatewayToken=d,[3,4];case 3:return i=l.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=e.gatewayToken,this.connection.gatewayToken=e.gatewayToken,[3,10];case 5:return"sspi"!==e.flowName?[3,9]:(n.provider="win",n.method="access-token",e.flowCallback&&e.sessionId?(r=n,[4,e.flowCallback(e.sessionId,null)]):[3,7]);case 6:return r.token=l.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(e.token)n.method="access-token",n.token=e.token;else{if(!e.username)throw new Error("invalid auth message"+JSON.stringify(e));n.method="secret",n.login=e.username,n.secret=e.password}l.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},e.sessionId&&(o.request_id=e.sessionId),this.globalDomain=sn("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),l.label=11;case 11:l.trys.push([11,19,20,21]),a=void 0,l.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=l.sent()).type?[3,16]:(d=Buffer.from(c.authentication.token,"base64"),e.flowCallback&&e.sessionId?(u=o.authentication,[4,e.flowCallback(e.sessionId,d)]):[3,15]);case 14:u.token=l.sent().data.toString("base64"),l.label=15;case 15:return o.request_id=e.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.debug("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw h=l.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return e&&e.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null),[7];case 21:return[2]}}))}))},e.prototype.logout=function(){return dt(this,void 0,void 0,(function(){var e;return ut(this,(function(t){switch(t.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),e=this.sessions.map((function(e){e.leave()})),[4,Promise.all(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)},e.prototype.domain=function(e,t,n,i){var r=this.sessions.filter((function(t){return t.domain===e}))[0];return r||(r=sn(e,this.connection,t,n,i),this.sessions.push(r)),r},e.prototype.handleDisconnected=function(){var e=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(e.handleDisconnected.bind(e),e.settings.reconnectInterval||1e3)}))}},e.prototype.setLoggedIn=function(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")},e.prototype.ping=function(){var e=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){e.ping()}),3e4))},e.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},e.prototype.getNewGWToken=function(){if(void 0!==typeof window){var e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))},e}(),cn=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,n=e;t<n.length;t++){var i=n[t];this.specs[i.name]=i,this.specsNames.push(i.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=e.on(n,(function(e){return t.processMessage(n,e)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(e)){var o=this.messages[r]||[];this.messages[r]=o,o.push(t)}}},e.prototype.drain=function(e,t){var n;t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var i=0,r=this.specs[e].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),dn=function(e,t,n){return new Promise((function(i,r){var o=setTimeout((function(){r(n||"Promise timeout hit: "+t)}),t);new Promise(e).then((function(e){clearTimeout(o),i(e)})).catch((function(e){clearTimeout(o),r(e)}))}))},un=function(){function e(e,t,n){this.settings=e,this.logger=t,this.identity=n,this.parentReady=!1,this.iAmConnected=!1,this.rejected=!1,this.children=[],this.parentPingTimeout=3e3,this.connectionRequestTimeout=5e3,this.defaultTargetString="*",this.registry=Ot(),this.messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:this.handleParentReady.bind(this)},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformUnload:{name:"platformUnload",handle:this.handlePlatformUnload.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)}},this.setUpMessageListener(),this.setUpUnload(),this.settings.port||(this.parent=window.opener||window.top,this.parentType=window.opener?"opener":-1!==window.name.indexOf("#wsp")?"workspace":"top")}return Object.defineProperty(e.prototype,"transportWindowId",{get:function(){return this.publicWindowId},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return dt(this,void 0,void 0,(function(){return ut(this,(function(t){if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");return this.port.postMessage(e),[2]}))}))},Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.send=function(){return Promise.reject("not supported")},e.prototype.onConnectedChanged=function(e){return this.registry.add("onConnectedChanged",e)},e.prototype.open=function(){return dt(this,void 0,void 0,(function(){return ut(this,(function(e){switch(e.label){case 0:return this.logger.debug("opening a connection to the web platform gateway."),[4,this.connect()];case 1:return e.sent(),this.notifyStatusChanged(!0),[2]}}))}))},e.prototype.close=function(){return Promise.resolve()},e.prototype.name=function(){return"web-platform"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.connect=function(){return dt(this,void 0,void 0,(function(){var e=this;return ut(this,(function(t){switch(t.label){case 0:if(this.parentReady)return this.logger.debug("cancelling connection attempt, because this client's parent has already given a ready signal"),[2];if(this.settings.port)return this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.publicWindowId=this.settings.windowId,this.identity&&(this.identity.windowId=this.publicWindowId),this.port.onmessage=function(t){return e.registry.execute("onMessage",t.data)},this.logger.debug("internal web platform connection completed"),[2];if(!this.parentType||!this.parent)throw new Error("Cannot initiate a connection, because there is no opener, no top and no port.");return this.logger.debug("opening a "+("opener"===this.parentType?"child":"grandchild")+" client web platform connection"),[4,this.waitParent(this.parent,this.parentType)];case 1:return t.sent(),[4,this.initiateRemoteConnection(this.parent,this.parentType)];case 2:return t.sent(),this.logger.debug("the "+("opener"===this.parentType?"child":"grandchild")+" client is connected"),[2]}}))}))},e.prototype.initiateRemoteConnection=function(e,t){var n=this;return dn((function(i,r){n.connectionResolve=i,n.connectionReject=r,n.myClientId=on();var o="workspace"===n.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window.name,s={glue42core:{type:n.messages.connectionRequest.name,clientId:n.myClientId,clientType:"top"===t||"workspace"===t?"grandChild":"child",bridgeInstanceId:o}};n.logger.debug("sending connection request to "+t),e.postMessage(s,n.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the opener/top window timed out")},e.prototype.waitParent=function(e,t){var n=this;return dn((function(i){n.parentPingResolve=i;var r={glue42core:{type:"opener"===t?n.messages.platformPing.name:n.messages.parentPing.name}};n.logger.debug("checking for "+t+" window availability"),e.postMessage(r,n.defaultTargetString)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client")},e.prototype.setUpMessageListener=function(){var e=this;this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(function(t){var n,i=null===(n=t.data)||void 0===n?void 0:n.glue42core;if(i&&!e.rejected)if(e.checkMessageTypeValid(i.type)){var r=i.type;e.logger.debug("received valid glue42core message of type: "+r),e.messages[r].handle(t)}else e.logger.error("cannot handle the incoming glue42 core message, because the type is invalid: "+i.type)}))},e.prototype.setUpUnload=function(){var e=this;this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(function(){var t,n,i={glue42core:{type:e.messages.clientUnload.name,data:{clientId:e.myClientId,ownWindowId:null===(t=e.identity)||void 0===t?void 0:t.windowId}}};e.parent&&e.parent.postMessage(i,e.defaultTargetString),null===(n=e.port)||void 0===n||n.postMessage(i)}))},e.prototype.handleParentReady=function(){if(this.logger.debug("handling the ready signal from the parent, by resoling the pending promise."),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},e.prototype.handlePlatformReady=function(){if(this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},e.prototype.handleConnectionAccepted=function(e){var t,n=null===(t=e.data)||void 0===t?void 0:t.glue42core;return this.myClientId===n.clientId?this.handleAcceptanceOfMyRequest(n):this.handleAcceptanceOfGrandChildRequest(n,e)},e.prototype.handleAcceptanceOfMyRequest=function(e){var t=this;if(this.logger.debug("handling a connection accepted signal targeted at me."),e.port){if(this.publicWindowId="opener"===this.parentType?window.name:"top"===this.parentType?e.parentWindowId:window.name.substring(0,window.name.indexOf("#wsp")),this.identity&&"top"!==this.parentType&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this.port=e.port,this.port.onmessage=function(e){return t.registry.execute("onMessage",e.data)},this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")},e.prototype.handleAcceptanceOfGrandChildRequest=function(e,t){this.logger.debug("handling a connection accepted signal targeted at a grandchild: "+e.clientId);var n=this.children.find((function(t){return t.grandChildId===e.clientId}));n?(n.connected=!0,this.logger.debug("the grandchild connection for "+e.clientId+" is set up, forwarding the success message and the gateway port"),e.parentWindowId=this.publicWindowId,n.source.postMessage(t.data,n.origin,[e.port])):this.logger.error("cannot handle connection accepted for grandchild: "+e.clientId+", because there is no grandchild with this id")},e.prototype.handleConnectionRejected=function(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)},e.prototype.handleConnectionRequest=function(e){var t=e.source,n=e.data.glue42core;return n.clientType&&"grandChild"===n.clientType?n.clientId?"opener"===this.parentType&&this.parent?(this.logger.debug("handling a connection request for a grandchild: "+n.clientId),this.children.push({grandChildId:n.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug("grandchild: "+n.clientId+" is prepared, forwarding connection request to the platform"),void this.parent.postMessage(e.data,this.defaultTargetString)):this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call")},e.prototype.handleParentPing=function(e){if(this.parentReady)if(this.iAmConnected){var t={glue42core:{type:this.messages.parentReady.name}},n=e.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(t,e.origin)}else this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");else this.logger.debug("my parent is not ready, I am ignoring the parent ping")},e.prototype.handlePlatformUnload=function(e){this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.children.length&&(this.logger.debug("forwarding the platform unload to all known children and starting platform discovery polling"),this.children.forEach((function(t){return t.source.postMessage(e.data,t.origin)}))),this.notifyStatusChanged(!1,"Gateway unloaded")},e.prototype.handleClientUnload=function(e){var t=e.data.glue42core;t.clientId?this.children.find((function(e){return e.grandChildId===t.clientId}))?(this.logger.debug("handling grandchild unload for id: "+t.clientId),this.children=this.children.filter((function(e){return e.grandChildId!==t.clientId}))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")},e.prototype.handlePlatformPing=function(){this.logger.error("cannot handle platform ping, because this is not a platform calls handling component")},e.prototype.notifyStatusChanged=function(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)},e.prototype.checkMessageTypeValid=function(e){return"string"==typeof e&&!!this.messages[e]},e.prototype.rejectConnectionRequest=function(e,t,n){this.rejected=!0,this.logger.error(n);var i={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(i,t)},e}(),hn=function(){function e(e,t){if(this.settings=e,this.logger=t,this.messageHandlers={},this.ids=1,this.registry=Ot(),this._connected=!1,this.isTrace=!1,(e=e||{}).reconnectAttempts=e.reconnectAttempts||10,e.reconnectInterval=e.reconnectInterval||1e3,e.inproc)this.transport=new Et(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new Nt(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new un(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new Ut(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug("starting with "+this.transport.name()+" transport"),this.protocol=new an(this,e,t.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),e.replaySpecs&&e.replaySpecs.length&&(this.replayer=new cn(e.replaySpecs),this.replayer.init(this))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;return null===(e=this.protocol)||void 0===e?void 0:e.protocolVersion},enumerable:!0,configurable:!0}),e.prototype.send=function(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(e);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,t)}var i=this.protocol.createStringMessage(e);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,t)},e.prototype.on=function(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){var t=this;return this.protocol.loggedIn((function(){e(t.settings.ws||t.settings.sharedWorker||"")}))},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return dt(this,void 0,void 0,(function(){var n;return ut(this,(function(i){switch(i.label){case 0:return[4,this.transport.open()];case 1:return i.sent(),qt("connection").mark("transport-opened"),n=this.protocol.login(e,t),qt("connection").mark("protocol-logged-in"),[2,n]}}))}))},e.prototype.logout=function(){return dt(this,void 0,void 0,(function(){return ut(this,(function(e){switch(e.label){case 0:return[4,this.protocol.logout()];case 1:return e.sent(),[4,this.transport.close()];case 2:return e.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this.protocol.loggedIn(e)},e.prototype.domain=function(e,t,n){return this.protocol.domain(e,this.logger.subLogger("domain="+e),t,n)},e.prototype.authToken=function(){return this.protocol.authToken()},e.prototype.reconnect=function(){return this.transport.reconnect()},e.prototype.distributeMessage=function(e,t){var n=this,i=this.messageHandlers[t.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(t){var r=i[t];if(void 0!==r)try{r(e)}catch(e){try{n.logger.error("Message handler failed with "+e.stack,e)}catch(t){console.log("Message handler failed",e)}}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?this.registry.execute("connected"):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"==typeof e?this.protocol.processStringMessage(e):this.protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e}(),ln=["trace","debug","info","warn","error","off"],pn=function(){function e(e,t,n){this.name=e,this.parent=t,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=e,this.path=t?t.path+"."+e:e,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return e.prototype.subLogger=function(t){var n=this.subLoggers.filter((function(e){return e.name===t}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var i=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},e.prototype.publishLevel=function(e){var t;return e&&(this._publishLevel=e),this._publishLevel||(null===(t=this.parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this.parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.log=function(e,t,n){this.publishMessage(t||"info",e,n)},e.prototype.trace=function(e){this.log(e,"trace")},e.prototype.debug=function(e){this.log(e,"debug")},e.prototype.info=function(e){this.log(e,"info")},e.prototype.warn=function(e){this.log(e,"warn")},e.prototype.error=function(e,t){this.log(e,"error")},e.prototype.canPublish=function(e,t){return ln.indexOf(e)>=ln.indexOf(t||this.consoleLevel()||"trace")},e.prototype.publishMessage=function(t,n,i){var r=this.loggerFullName;if("error"===t&&!i){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())){var s=e.Interop;if(s)try{s.methods({name:e.InteropMethodName}).length>0&&s.invoke(e.InteropMethodName,{msg:""+n,logger:r,level:t})}catch(e){}}if(this.canPublish(t)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+t+"] "}var d=""+a+r+": "+n;switch(t){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,i)}}},e.InteropMethodName="T42.AppLogger.Log",e}(),fn="create-context",gn="created",mn="destroyed",vn="context-created",yn="context-added",bn="subscribe-context",wn="subscribed-context",In="unsubscribe-context",xn="destroy-context",Sn="context-destroyed",_n="update-context",kn="context-updated",Mn="joined",Cn={get name(){return"context"},get types(){return[fn,gn,mn,vn,yn,bn,wn,In,xn,Sn,_n,kn,Mn]}},Tn="5.4.0";var jn=function(){function e(e,t,n,i){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=i,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function Pn(e,t,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e))),!t)return e;if(t.reset)return e=ct({},t.reset);if(e=An(e,void 0),t.commands){for(var i=0,r=t.commands;i<r.length;i++){var o=r[i];"remove"===o.type?Nn(e,o.path):"set"===o.type&&En(e,o.value,o.path)}return e}var s=t.added,a=t.updated,c=t.removed;return s&&Object.keys(s).forEach((function(t){e[t]=s[t]})),a&&Object.keys(a).forEach((function(t){Rn(t,e,a)})),c&&c.forEach((function(t){delete e[t]})),e}catch(i){return null==n||n.error("error applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e),i),e}}function An(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var n=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,n),Object.assign.apply(Object,ht([n],Object.keys(e).map((function(n){var i;return(i={})[n]=An(e[n],t),i}))))}var Rn=function(e,t,n){var i=n[e];if(void 0===i)return t;var r=t[e];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(t[e]=i,t):(t[e]=Object.assign({},r,i),t):(t[e]=i,t)};function On(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!On(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function En(e,t,n){var i,r=n.split(".");for(i=0;i<r.length-1;i++)e[r[i]]||(e[r[i]]={}),"object"!=typeof e[r[i]]&&(e[r[i]]={}),e=e[r[i]];e[r[i]]=t}function Nn(e,t){var n,i=t.split(".");for(n=0;n<i.length-1;n++){if(!e[i[n]])return;e=e[i[n]]}delete e[i[n]]}var Dn,Ln=function(){function e(e){var t,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=e.connection,this._logger=e.logger,this._gw3Session=this._connection.domain("global",[vn,wn,Sn,kn]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(t=this._connection.replayer)||void 0===t||t.drain(Cn.name,(function(e){var t=e.type;t&&(t===vn||t===yn||t===gn?n.handleContextCreatedMessage(e):t===wn||t===kn||t===Mn?n.handleContextUpdatedMessage(e):t!==Sn&&t!==mn||n.handleContextDestroyedMessage(e))}))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;if(!this._protocolVersion){var t=this._connection.availableDomains.find((function(e){return"context"===e.uri}));this._protocolVersion=null!==(e=null==t?void 0:t.version)&&void 0!==e?e:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var n=t[e];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},e.prototype.createContext=function(e,t){var n=this;return this._gw3Session.send({type:fn,domain:"global",name:e,data:t,lifetime:"retained"}).then((function(i){n._contextNameToId[e]=i.context_id,n._contextIdToName[i.context_id]=e;var r=n._contextNameToData[e]||new jn(i.context_id,e,!0,void 0);return r.isAnnounced=!0,r.name=e,r.contextId=i.context_id,r.context=t,n._contextNameToData[e]=r,i.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){var n;return dt(this,void 0,void 0,(function(){var i,r,o,s=this;return ut(this,(function(a){switch(a.label){case 0:return(i=this._contextNameToData[e])&&i.isAnnounced?(r=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(e,t)];case 1:r=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(r,t):this.calculateContextDeltaV1(r,t),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:_n,domain:"global",context_id:i.contextId,delta:o},{},{skipPeerId:!1}).then((function(e){s.handleUpdated(i,o,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var n=this,i=this._contextNameToData[e];return i&&i.isAnnounced?this._gw3Session.send({type:_n,domain:"global",context_id:i.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(i,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.setPath=function(e,t,n){return this.setPathSupported?this.setPaths(e,[{path:t,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},e.prototype.setPaths=function(e,t){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[e];if(!i||!i.isAnnounced){for(var r={},o=0,s=t;o<s.length;o++){En(r,(u=s[o]).value,u.path)}return this.createContext(e,r)}for(var a=[],c=0,d=t;c<d.length;c++){var u;null===(u=d[c]).value?a.push({type:"remove",path:u.path}):a.push({type:"set",path:u.path,value:u.value})}return this._gw3Session.send({type:_n,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:e.peer_id})}))},e.prototype.get=function(e){var t,n=this,i=this._contextNameToData[e];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(t,i){return dt(n,void 0,void 0,(function(){var n=this;return ut(this,(function(i){return this.subscribe(e,(function(e,i,r,o){n.unsubscribe(o),t(e)})),[2]}))}))}));var r=null!==(t=null==i?void 0:i.context)&&void 0!==t?t:{};return Promise.resolve(r)},e.prototype.subscribe=function(e,t){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new jn(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[n]=t,Promise.resolve(n);var r,o=i.hasCallbacks();return i.updateCallbacks[n]=t,o||i.joinedActivity||i.context&&i.sentExplicitSubscription?(t(r=An(i.context),r,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},e.prototype.unsubscribe=function(e){for(var t=0,n=Object.keys(this._contextNameToData);t<n.length;t++){var i=n[t],r=(this._contextNameToId[i],this._contextNameToData[i]);if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},e.prototype.destroy=function(e){var t=this._contextNameToData[e];return t?this._gw3Session.send({type:xn,domain:"global",context_id:t.contextId}).then((function(e){})):Promise.reject("context with "+e+" does not exist")},e.prototype.handleUpdated=function(e,t,n){var i=e.context;e.context=Pn(e.context,t,this._logger),this._contextNameToData[e.name]!==e||On(i,e.context)||this.invokeUpdateCallbacks(e,t,n)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=[yn,vn,gn];e<t.length;e++){var n=t[e],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},e.prototype.handleContextCreatedMessage=function(e){var t=e.type;t===gn?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===yn&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=e.context_id,i.activityId=e.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new jn(e.context_id,n,!0,e.activity_id)},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=[kn,wn,Mn];e<t.length;e++){var n=t[e],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,n=e.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(t===Mn)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=e.activity_id):(i=new jn(n,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=i,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(t===wn?((i=i||new jn(n,e.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=i,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(t===wn)i.context=e.data||{};else if(t===Mn)i.context=e.context_snapshot||{};else{if(t!==kn)throw new Error("Unrecognized context update message "+t);i.context=Pn(i.context,e.delta,this._logger)}!r&&On(i.context,o)&&t!==wn||this.invokeUpdateCallbacks(i,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,n){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(var i=0,r=t.commands;i<r.length;i++){var o=r[i];"remove"===o.type?(-1===o.path.indexOf(".")&&t.removed.push(o.path),En(t.updated,null,o.path)):"set"===o.type&&En(t.updated,o.value,o.path)}}for(var s in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(s))try{(0,e.updateCallbacks[s])(An(e.context),Object.assign({},t.added||{},t.updated||{},t.reset||{}),t.removed,parseInt(s,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=[Sn,mn];e<t.length;e++){var n=t[e],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},e.prototype.handleContextDestroyedMessage=function(e){var t,n;if(e.type===mn){if(n=e.activity_id,!(t=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(n=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:bn,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:In,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDeltaV1=function(e,t){var n={added:{},updated:{},removed:[],reset:void 0};if(e)for(var i=0,r=Object.keys(e);i<r.length;i++){var o=r[i];-1===Object.keys(t).indexOf(o)||null===t[o]||On(e[o],t[o])||(n.updated[o]=t[o])}for(var s=0,a=Object.keys(t);s<a.length;s++){o=a[s];e&&-1!==Object.keys(e).indexOf(o)?null===t[o]&&n.removed.push(o):null!==t[o]&&(n.added[o]=t[o])}return n},e.prototype.calculateContextDeltaV2=function(e,t){for(var n,i,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(t);o<s.length;o++){var a=s[o];if(null!==t[a])On(e?e[a]:null,t[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:t[a]});else null===(i=r.commands)||void 0===i||i.push({type:"remove",path:a})}return r},e}(),Wn=function(){function e(e){this._bridge=new Ln(e)}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)},e.prototype.setPath=function(e,t,n){return this.checkName(e),this.checkPath(t),""===t?(this.checkData(n),this.set(e,n)):this._bridge.setPath(e,t,n)},e.prototype.setPaths=function(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=t;n<i.length;n++){var r=i[n],o=r.path,s=r.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(e,t)},e.prototype.subscribe=function(e,t){var n=this;if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,(function(e,i,r,o,s){return t(e,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(e){return function(){n._bridge.unsubscribe(e)}}))},e.prototype.get=function(e){return this.checkName(e),this._bridge.get(e)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.destroy=function(e){return this.checkName(e),this._bridge.destroy(e)},Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),e.prototype.checkName=function(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")},e.prototype.checkPath=function(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")},e.prototype.checkData=function(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")},e}();function qn(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=function(){}:"function"!=typeof n&&(n=function(){}),e.then(t,n))}function Fn(e,t,n){var i;return void 0===e&&(e=0),t.finally((function(){i&&clearTimeout(i)})),new Promise((function(t,r){i=setTimeout((function(){return r(n)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(Dn||(Dn={}));var Un=function(){function e(e,t,n,i){this.protocol=e,this.repo=t,this.instance=n,this.configuration=i}return e.prototype.subscribe=function(e,t,n,i,r){var o=this,s=function(e,n,i,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,o.protocol.client.subscribe(n,t,e,i,s,r)};return qn(new Promise((function(n,i){var r,a=function(e){n(e)},c=function(e){i(e)};if(e)if((r="string"==typeof e?{name:e}:e).name){void 0===t&&(t={});var d=t.target;if(void 0===d&&(d="best"),"string"!=typeof d||"all"===d||"best"===d){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=o.configuration.waitTimeoutMs));var u=0,h=o.getServerMethodsByFilterAndTarget(r,d);if(h.length>0)s(h,h[0].methods[0],a,c);else{var l=function(){if(d&&t.waitTimeoutMs)if(u+=500,(h=o.getServerMethodsByFilterAndTarget(r,d)).length>0){var n=h[0].methods[0];s(h,n,a,c)}else if(u>=t.waitTimeoutMs){s(h,"string"==typeof e?{name:e}:e,a,c)}else setTimeout(l,500)};setTimeout(l,500)}}else i(new Error('"'+d+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,i)},e.prototype.servers=function(e){var t=void 0===e?void 0:ct({},e);return this.getServers(t).map((function(e){return e.server.instance}))},e.prototype.methods=function(e){return e="string"==typeof e?{name:e}:ct({},e),this.getMethods(e)},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e)},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved(e)},e.prototype.serverAdded=function(e){return this.repo.onServerAdded(e)},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,n){e(t,n)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,n){e({server:t,method:n})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,n){e({server:t,method:n})}))},e.prototype.invoke=function(e,t,n,i,r,o){return dt(this,void 0,void 0,(function(){var s=this;return ut(this,(function(a){return[2,qn(function(){return dt(s,void 0,void 0,(function(){var r,o,s,a,c,d,u,h,l,p,f,g,m=this;return ut(this,(function(v){switch(v.label){case 0:if(!(r="string"==typeof e?{name:e}:ct({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(t||(t={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(r,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,n,i)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=ct(ct({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(p=r.objectTypes)&&void 0!==p?p:[],flags:null!==(g=null===(f=r.flags)||void 0===f?void 0:f.metadata)&&void 0!==g?g:{}}),a={method:s,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=i.methodResponseTimeoutMs,d=i,u=o.map((function(e){var n=on(),i=e.methods[0],r=e.server,o=m.protocol.client.invoke(n,i,t,r,d);return Promise.race([o,Fn(c,o,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(d),status:Dn.Error})])})),[4,Promise.all(u)];case 5:return h=v.sent(),l=this.getInvocationResultObj(h,r,t),h.every((function(e){return e.status===Dn.Error}))?[2,Promise.reject(l)]:[2,l]}}))}))}(),r,o)]}))}))},e.prototype.getInvocationResultObj=function(e,t,n){var i=e.filter((function(e){return e.status===Dn.Success})).reduce((function(e,i){return e=ht(e,[{executed_by:i.instance,returned:i.result,called_with:n,method:t,message:i.message,status:i.status}])}),[]),r=e.filter((function(e){return e.status===Dn.Error})).reduce((function(e,i){return e=ht(e,[{executed_by:i.instance,called_with:n,name:t.name,message:i.message}])}),[]),o=e[0];return{method:t,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:i,all_errors:r,message:o.message,status:o.status}},e.prototype.tryToAwaitForMethods=function(e,t,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},e.prototype.filterByTarget=function(e,t){var n=this;if("string"!=typeof e){return(Array.isArray(e)?e:[e]).reduce((function(e,i){var r=t.filter((function(e){return n.instanceMatch(i,e.server.instance)}));return e.concat(r)}),[])}if("all"===e)return ht(t);if("best"===e){var i=t.find((function(e){return e.server.instance.isLocal}));if(i)return[i];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.instance.peerId!==n.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]})).every((function(n){var i,r=e[n],o=t[n];switch(n){case"objectTypes":i=(r||[]).every((function(e){return(o||[]).includes(e)}));break;case"flags":i=function e(t,n){return Object.keys(n).every((function(i){return"object"==typeof n[i]?e((null==t?void 0:t[i])||{},n[i]||{}):n[i]===(null==t?void 0:t[i])}))}(o||{},r||{});break;default:i=String(r).toLowerCase()===String(o).toLowerCase()}return i}))},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((function(n){return t.methodMatch(e,n)}))},e.prototype.getMethodsForInstance=function(e){var t=this,n=this.repo.getServers().filter((function(n){return t.instanceMatch(e,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(e){Object.keys(e.methods).forEach((function(t){var n=e.methods[t];i[n.identifier]=n}))})),Object.keys(i).map((function(e){return i[e]}))},e.prototype.getServers=function(e){var t=this,n=this.repo.getServers();return void 0===e?n.map((function(e){return{server:e,methods:[]}})):n.reduce((function(n,i){var r=Object.values(i.methods).filter((function(n){return t.methodMatch(e,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var n=this.getServers(e);return this.filterByTarget(t,n)},e}(),Bn=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}return Object.defineProperty(e.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),Hn=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),Jn=function(){function e(e,t){var n=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return n.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return n.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return n.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRequestHandler){var n=new Hn(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionAddedHandler){var n=new Bn(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRemovedHandler){var n=new Bn(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}},e}(),Gn=function(){function e(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new Bn(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),Kn=function(){function e(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,n=this._protocol.server.getBranchList(this._repoMethod);return e?n.indexOf(e)>-1?new Gn(e,this._protocol,this._repoMethod):void 0:n.map((function(e){return new Gn(e,t._protocol,t._repoMethod)}))},e.prototype.branch=function(e){return this.branches(e)},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new Bn(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e,t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming,flags:null===(e=t.flags)||void 0===e?void 0:e.metadata}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),Vn=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Jn(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,n,i,r){var o=this;return qn(new Promise((function(n,i){if(e){var s;if(!(s="string"==typeof e?{name:""+e}:ct({},e)).name)return i("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(e){return e.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});o.protocol.server.createStream(a).then((function(){var e;r?(e=r,r.updateRepoMethod(a)):e=new Kn(o.protocol,a,o),a.stream=e,n(e)})).catch((function(e){a.repoId&&o.serverRepository.remove(a.repoId),i(e)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),n,i)},e.prototype.register=function(e,t){var n=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var i=function(e,i){return dt(n,void 0,void 0,(function(){var n,r,o;return ut(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=t(e.args,e.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=s.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),i(o,o),[3,5];case 5:return[2]}}))}))};return i.userCallback=t,this.registerCore(e,i)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var n=function(e,n){try{var i=!1,r=function(e){i||n(void 0,e),i=!0},o=function(e){i||(e||(e=""),n(e,e)),i=!0},s=t(e.args,e.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),dt(this,void 0,void 0,(function(){var n,i;return ut(this,(function(r){switch(r.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(e){return e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return dt(this,void 0,void 0,(function(){var n;return ut(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,n=[];return e.forEach((function(e){var i=t.protocol.server.unregister(e).then((function(){e.repoId&&t.serverRepository.remove(e.repoId)}));n.push(i),t.addAsCurrentlyUnregistering(e.definition.name,i)})),Promise.all(n)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return dt(this,void 0,void 0,(function(){var n,i=this;return ut(this,(function(r){return n=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,n]).then((function(){delete i.currentlyUnregistering[e]})),[2]}))}))},e.prototype.registerCore=function(e,t){return dt(this,void 0,void 0,(function(){var n,i,r,o=this;return ut(this,(function(s){switch(s.label){case 0:return(n="string"==typeof e?{name:""+e}:ct({},e)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(e))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+n.name+" to be a stream, please use the glue.interop.createStream() method.")]:(r=this.serverRepository.add({definition:n,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(r).catch((function(e){throw(null==r?void 0:r.repoId)&&o.serverRepository.remove(r.repoId),e}))])}}))}))},e.prototype.onMethodInvoked=function(e,t,n){var i=this;e&&e.theFunction&&e.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(e,t,n,r)}))},e}(),zn=function(){function e(e,t,n){var i=this;this.wrapped={},this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))},t&&this.refreshWrappedObject(t),n&&(n.loggedIn((function(){i.refresh(n)})),this.refresh(n))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null==e?void 0:e.resolvedIdentity,n=Object.assign({},null!=t?t:{},{peerId:null==e?void 0:e.peerId});this.refreshWrappedObject(n)}},e.prototype.refreshWrappedObject=function(e){var t,n,i;this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:on(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(i=null!==(n=e.pid)&&void 0!==n?n:e.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}(),$n=function(e){return ct(ct({},e),{flags:e.flags.metadata||{}})},Yn=function(){function e(e,t){this.logger=e,this.API=t,this.servers={},this.methodsCount={},this.callbacks=Ot();var n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}return e.prototype.addServer=function(e,t){this.logger.debug("adding server "+t);var n=this.servers[t];if(n)return n.id;var i=new zn(this.API,e),r={id:t,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[t]=r,this.callbacks.execute("onServerAdded",r.instance),t},e.prototype.removeServerById=function(e,t){var n=this,i=this.servers[e];i?(this.logger.debug("removing server "+e),Object.keys(i.methods).forEach((function(t){n.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",i.instance,t)):this.logger.warn("not aware of server "+e+", my state "+JSON.stringify(Object.keys(this.servers)))},e.prototype.addServerMethod=function(e,t){var n,i=this.servers[e];if(!i)throw new Error("server does not exists");if(!i.methods[t.id]){var r=this.createMethodIdentifier(t),o=this,s={identifier:r,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:null!==(n=t.flags)&&void 0!==n?n:{},getServers:function(){return o.getServersByMethod(r)}};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,i.methods[t.id]=s;var a=$n(s);return this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",a)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",i.instance,a),s}},e.prototype.removeServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");var i=n.methods[t];delete n.methods[t];var r=$n(i);this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},e.prototype.getMethods=function(){return this.extractMethodsFromServers(Object.values(this.servers)).map($n)},e.prototype.getServers=function(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((function(e){return e.instance}));return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(t){var i=t.methods;Object.keys(i).forEach((function(r){n||e(t.instance,i[r])}))}))}),0),function(){n=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.hideServerMethodSystemFlags(this.servers[e])},e.prototype.reset=function(){var e,t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers=((e={})[this.myServer.id]=this.myServer,e),this.methodsCount={}},e.prototype.createMethodIdentifier=function(e){var t=void 0!==e.input_signature?e.input_signature:"",n=void 0!==e.result_signature?e.result_signature:"";return(e.name+t+n).toLowerCase()},e.prototype.getServersByMethod=function(e){var t=[];return Object.values(this.servers).forEach((function(n){Object.values(n.methods).forEach((function(i){i.identifier===e&&t.push(n.instance)}))})),t},e.prototype.returnUnsubWithDelayedReplay=function(e,t,n){var i=!1;return setTimeout((function(){t.forEach((function(e){i||n(e)}))}),0),function(){i=!0,e()}},e.prototype.hideServerMethodSystemFlags=function(e){var t={};return Object.entries(e.methods).forEach((function(e){var n=e[0],i=e[1];t[n]=$n(i)})),ct(ct({},e),{methods:t})},e.prototype.extractMethodsFromServers=function(e){return Object.values(e).reduce((function(e,t){return ht(e,Object.values(t.methods))}),[])},e}(),Xn=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"==typeof e)return this.methods.find((function(t){return t.repoId===e}))},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),Qn="onSubscriptionRequest",Zn="onSubscriptionAdded",ei="onSubscriptionRemoved",ti=function(){function e(e,t,n){var i=this;this.session=e,this.repository=t,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=Ot(),this.nextStreamId=0,e.on("add-interest",(function(e){i.handleAddInterest(e)})),e.on("remove-interest",(function(e){i.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(t,n),r=e.msg.subscription_id,o={id:r,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:i,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(Zn,o,t)},e.prototype.rejectRequest=function(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)},e.prototype.pushData=function(e,t,n){var i=this;if("object"==typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return!n||0===n.length||n.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var n={type:"publish",stream_id:e,data:t};i.session.sendFireAndForget(n)}))}},e.prototype.pushDataToSingle=function(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(i)},e.prototype.closeSingleSubscription=function(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];var n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);t.instance;this.callbacks.execute(ei,t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var n=this;if("object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap&&e.protocolState.subscriptionsMap){var i=e.protocolState.subscriptionsMap,r=Object.keys(i).map((function(e){return i[e]}));"string"==typeof t&&(r=r.filter((function(e){return e.branchKey===t}))),r.forEach((function(e){delete i[e.id];var t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};n.session.sendFireAndForget(t)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var n=e.protocolState.subscriptionsMap,i=Object.keys(n).map((function(e){return n[e]}));return"string"!=typeof t?i:i.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((function(e){return t[e]})),i=[];return n.forEach((function(e){var t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===i.indexOf(t)&&i.push(t)})),i},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent(Zn,e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent(Qn,e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent(ei,e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"==typeof e.subscription_id&&"object"==typeof t&&t.protocolState.subscriptionsMap&&"object"==typeof t.protocolState.subscriptionsMap[e.subscription_id]){var n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(ei,n,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},i=this.serverRepository.getById(e.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(Qn,n,i);else{var r="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(r,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)},e.prototype.getStreamId=function(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+e.definition.name+" method without protocol state");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:i})),i},e}(),ni=function(){function e(e,t,n,i){var r=this;this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=i,this.callbacks=Ot(),this.streaming=new ti(e,t,n),this.session.on("invoke",(function(e){return r.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var n,i=this,r=e.definition,o=Object.assign({},{metadata:null!==(n=r.flags)&&void 0!==n?n:{}},{streaming:t||!1}),s={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:o,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(s,{methodId:e.repoId}).then((function(){i.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw i.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,i){var r;r=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},e.prototype.unregister=function(e){return dt(this,void 0,void 0,(function(){var t;return ut(this,(function(n){switch(n.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,n){this.streaming.pushData(e,t,n)},e.prototype.pushDataToSingle=function(e,t,n){this.streaming.pushDataToSingle(e,t,n)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)},e.prototype.rejectRequest=function(e,t,n){this.streaming.rejectRequest(e,t,n)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,n=e.caller_id,i=e.method_id,r=e.arguments_kv,o=this.serverRepository.getList().filter((function(e){return e.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,t,s)}},e}(),ii=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),ri="awaitingAccept",oi="subscribed",si="Subscription failed.",ai="ClientInitiated",ci=function(){function e(e,t,n){var i=this;this.session=e,this.repository=t,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,n=t.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(e){return e.serverId!==t.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===ri){var o="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===oi&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,n=i.subscriptionsList[t];if("object"==typeof n){var r=e._tag.serverId,o=n.trackedServers.filter((function(e){return e.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=e.subscription_id,i.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s=n.status===ri;if(n.status=oi,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new ii(i.repository,n),n.subscription=c,n.success(c));for(var d=0,u=n.handlers.onConnected;d<u.length;d++){var h=u[d];try{h(c.serverInstance,a)}catch(e){}}}}}},this.handleEventData=function(e){var t=i.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=i.subscriptionsList[t];if("object"==typeof n){var r=n.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===r.length){var o=e.oob,s=r[0].serverId,a=function(){return{data:e.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,d=n.queued.data;c.length>0?c.forEach((function(e){"function"==typeof e&&e(a())})):d.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=i.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=i.subscriptionsList[t];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[t]),delete i.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,e,t,i,r,t.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(t){return t.name===e.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:t.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(e){return s.handleSubscribed(e)})).catch((function(e){return s.handleErrorSubscribing(e)}))}else s.logger.error("can not find method "+e.name+" for target "+n.server.id)})):r({method:e,called_with:t.arguments,message:si+" Unable to register the user callbacks."})}else r({method:e,called_with:t.arguments,message:si+" No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,n,i,r,o,s){var a=this,c={localKey:e,status:ri,method:t,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var i=a.subscriptionsList[e];i.status===ri?(r({method:t,called_with:n.arguments,message:si+" Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[e]):i.status===oi&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(e){return void 0!==e.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[e]))}}),o),c},e.prototype.callOnClosedHandlers=function(e,t){var n,i=e.queued.closers.length,r=i>0?e.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),e.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:n,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,n=this.subscriptionsList[e];"object"==typeof n&&(n.trackedServers.forEach((function(e){void 0!==e.subscriptionId&&(n.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ai}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,ai),delete this.subscriptionsList[e])},e}(),di=function(){function e(e,t,n){var i=this;this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(function(e){return i.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return i.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return i.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return i.handleMethodsRemovedMessage(e)})),this.streaming=new ci(e,t,n)}return e.prototype.subscribe=function(e,t,n,i,r,o){this.streaming.subscribe(e,t,n,i,r,o)},e.prototype.invoke=function(e,t,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:o}).then((function(e){return r.handleResultMessage(e)})).catch((function(e){return r.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,n=e.identity,i=!e.meta||e.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:i};this.repository.addServer(o,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,n=e.server_id;e.methods.forEach((function(e){t.repository.addServerMethod(n,e)}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,n=e.server_id,i=e.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(e){var o=r.methods[e];i.indexOf(o.gatewayId)>-1&&t.repository.removeServerMethod(n,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,n=e.result,i=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(i).instance,status:Dn.Success,message:""}},e.prototype.handleInvocationError=function(e){if(this.logger.debug("handle invocation error "+JSON.stringify(e)),"_tag"in e){var t=e._tag.invocationId,n=e._tag.serverId,i=this.repository.getServerById(n),r=e.reason;return{invocationId:t,result:e.context,instance:i.instance,status:Dn.Error,message:r}}return{invocationId:"",message:e.message,status:Dn.Error,error:e}},e}();function ui(e,t,n,i,r,o){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(e){s=e})),d=t.domain("agm",["subscribed"]),u=new ni(d,n,i,a.subLogger("server")),h=new di(d,n,a.subLogger("client"));return d.onJoined((function(r){n.addServer(e,t.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var e=0,t=h.drainSubscriptions();e<t.length;e++){var n=t[e],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),o.client.subscribe(r,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var d=0,u=c;d<u.length;d++){var l=u[d],p=l.definition;a.info("re-publishing method "+p.name),l.stream?o.server.createStream(p,l.streamCallbacks,void 0,void 0,l.stream):l.theFunction&&l.theFunction.userCallback?o.register(p,l.theFunction.userCallback):l.theFunction&&l.theFunction.userCallbackAsync&&o.registerAsync(p,l.theFunction.userCallbackAsync)}}():s&&(s({client:h,server:u}),s=void 0)})),d.onLeft((function(){n.reset()})),d.join(),c}var hi=function(){function e(e){var t=this;if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");var n,i=e.connection;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new zn(this,void 0,i),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new Yn(e.logger.subLogger("cRep"),this),this.serverRepository=new Xn,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=ui(this.instance,i,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((function(n){return t.protocol=n,t.client=new Un(t.protocol,t.clientRepository,t.instance,e),t.server=new Vn(t.protocol,t.serverRepository),t}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,n,i){return this.client.subscribe(e,t,n,i)},e.prototype.createStream=function(e,t,n,i){return this.server.createStream(e,t,n,i)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,n,i,r,o){return this.client.invoke(e,t,n,i,r,o)},e.prototype.waitForMethod=function(e){var t=new Lt,n=this.client.methodAdded((function(i){i.name===e&&(n(),t.resolve(i))}));return t.promise},e}(),li=["subscribed","success"],pi=function(){function e(e,t){var n=this;this.publish=function(e,t,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(e,t,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,d=n.removeEmptyValues({type:"subscribe",topic:e,peer_id:n.peerId,routing_key:a,source:c});n.session.send(d).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:e,callback:t,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(e){return e.subscription_id!==o})),Promise.resolve()}})})).catch((function(e){return o(e)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(e){var t=e.data,i=e.subscription_id,r=e["publisher-identity"],o=n.subscriptions.find((function(e){return e.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(t,o.topic,r):o.callback(t,o.topic,r))}))},this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",li),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.removeEmptyValues=function(e){var t={};return Object.keys(e).forEach((function(n){void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t},e.prototype.keysMatch=function(e,t){var n=Object.keys(e),i=!0;return n.forEach((function(n){e[n]!==t[n]&&(i=!1)})),i},e}(),fi=function(e,t){var n,i=Dt.getGDMajorVersion(),r=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,r=window.gdPreloadPromise||r)}var o,s,a,c,d,u,h,l=qt("glue"),p=function(e,t,n){var i,r,o,s,a,c;if(Dt.isNode()){var d=process.env._GD_STARTING_CONTEXT_;if(d)try{c=JSON.parse(d)}catch(e){}}function u(){if(e.application)return e.application;if(n)return n.applicationName;var t=on();return Dt.isNode()?c?c.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+t+")":t}var h=function(){var i,r,o,s,a,d,h,l,p,f,g=e.gateway,m=null!==(i=null==g?void 0:g.protocolVersion)&&void 0!==i?i:3,v=null==g?void 0:g.reconnectInterval,y=null==g?void 0:g.reconnectAttempts,b=null==g?void 0:g.ws,w=null==g?void 0:g.sharedWorker,I=null==g?void 0:g.inproc,x=null!==(r=null==g?void 0:g.webPlatform)&&void 0!==r?r:void 0;n&&(b=n.gwURL),Dt.isNode()&&c&&c.gwURL&&(b=c.gwURL),b||w||I||(b="ws://localhost:8385");var S=u(),_=S;void 0!==n?(h=n.windowId,l=n.pid,n.env&&(p=n.env.env,f=n.env.region),_=null!==(o=n.application)&&void 0!==o?o:"glue-app",d=n.appInstanceId):Dt.isNode()&&(l=process.pid,c&&(p=c.env,f=c.region,d=c.instanceId));var k=null!==(a=null===(s=e.gateway)||void 0===s?void 0:s.replaySpecs)&&void 0!==a?a:[];return k.push(Cn),{identity:{application:_,applicationName:S,windowId:h,instance:d,process:l,region:f,environment:p,api:t.version||Tn},reconnectInterval:v,ws:b,sharedWorker:w,webPlatform:x,inproc:I,protocolVersion:m,reconnectAttempts:y,replaySpecs:k}}(),l=u();if("undefined"!=typeof window){var p=window,f=p.htmlContainer?p.htmlContainer.containerName+"."+p.htmlContainer.application:null===(i=null==p?void 0:p.glue42gd)||void 0===i?void 0:i.application;f&&(l=f)}return{bus:null!==(r=e.bus)&&void 0!==r&&r,application:l,auth:function(){var t,n,i;return"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Dt.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(t=e.gateway)||void 0===t?void 0:t.webPlatform)||(null===(n=e.gateway)||void 0===n?void 0:n.inproc)||(null===(i=e.gateway)||void 0===i?void 0:i.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var t,i,r,o=e.logger,s="warn";return o||(o=s),n&&(r=n.consoleLogLevel),"string"==typeof o?{console:null!=r?r:o,publish:s}:{console:null!==(t=null!=r?r:o.console)&&void 0!==t?t:s,publish:null!==(i=o.publish)&&void 0!==i?i:s}}(),connection:h,metrics:null===(o=e.metrics)||void 0===o||o,contexts:null===(s=e.contexts)||void 0===s||s,version:t.version||Tn,libs:null!==(a=t.libs)&&void 0!==a?a:[],customLogger:e.customLogger}}(e=e||{},t=t||{},n),f={};function g(e,t,n){(h=a.canPublish("trace"))&&a.trace("registering "+e+" module");var i=function(){t.initTime=n.stop(),t.initEndTime=n.endTime,t.marks=n.marks,h&&a.trace(e+" is ready - "+(n.endTime-n.startTime))};t.initStartTime=n.startTime,t.ready?t.ready().then((function(){i()})):i(),Array.isArray(e)||(e=[e]),e.forEach((function(e){f[e]=t,fi[e]=t}))}function m(){var e=qt("interop"),t={connection:o,logger:a.subLogger("interop")};return s=new hi(t),pn.Interop=s,g(["interop","agm"],s,e),Promise.resolve()}function v(){var e=p.activities&&3===o.protocolVersion;if(p.contexts||e){var t=qt("contexts");return g("contexts",d=new Wn({connection:o,logger:a.subLogger("contexts")}),t),d}var n=o.replayer;n&&n.drain(Cn.name)}function y(){return dt(this,void 0,void 0,(function(){var e;return ut(this,(function(t){return p.bus?(e=qt("bus"),g("bus",u=new pi(o,a.subLogger("bus")),e),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function b(e){try{return e.forEach((function(e){!function(e,t){var n=qt(e),i=t(f);i&&g(e,i,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return r.then((function(){var e,t=qt("logger");return(a=new pn(""+(null===(e=p.connection.identity)||void 0===e?void 0:e.application),void 0,p.customLogger)).consoleLevel(p.logger.console),a.publishLevel(p.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),g("logger",a,t),Promise.resolve(void 0)})).then((function(){var e=qt("connection");o=new hn(p.connection,a.subLogger("connection"));var t=Promise.resolve(p.auth);return p.connection&&!p.auth&&(t=n?n.getGWToken().then((function(e){return{gatewayToken:e}})):Promise.reject("You need to provide auth information")),t.then((function(t){var n;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return n=t,o.login(n)})).then((function(){return g("connection",o,e),p})).catch((function(e){throw o&&o.logout(),e}))})).then((function(){return Promise.all([(s=qt("metrics"),d=p.metrics,u=null==n?void 0:n.getMetricsPublishingEnabled,h=p.connection.identity,l=u||function(){return!0},f=null!==(e="boolean"!=typeof d&&d.disableAutoAppSystem)&&void 0!==e&&e,g("metrics",c=At({connection:d?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:l,system:"Glue42",service:null!==(t=null==h?void 0:h.service)&&void 0!==t?t:"metrics-service",instance:null!==(r=null!==(i=null==h?void 0:h.instance)&&void 0!==i?i:null==h?void 0:h.windowId)&&void 0!==r?r:on(),disableAutoAppSystem:f,pagePerformanceMetrics:"boolean"!=typeof d?null==d?void 0:d.pagePerformanceMetrics:void 0}),s),Promise.resolve()),m(),v(),y()]);var e,t,i,r,s,d,u,h,l,f})).then((function(){return s.readyPromise})).then((function(){return b(p.libs||[])})).then((function(){var e=Object.keys(f).map((function(e){var t=f[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var i={coreVersion:Tn,version:p.version};l.stop();var r={feedback:function(e){s&&s.invoke("T42.ACS.Feedback",e,"best")},info:i,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:d,bus:u,version:p.version,userConfig:e,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(r.performance={get glueVer(){return p.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=Wt;return Object.keys(e).map((function(t){var n=e[t];return{name:t,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(f).forEach((function(e){var t=f[e];r[e]=t})),r.config={},Object.keys(p).forEach((function(e){r.config[e]=p[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((function(e){r.config[e]=null==t?void 0:t.extOptions[e]})),(null==t?void 0:t.enrichGlue)&&t.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var h=function(e,t,n){return function(){return r.logger.warn("glue.js - 'glue.agm."+t+"' method is deprecated, use 'glue.interop."+n+"' instead."),e.apply(r.agm,arguments)}},g=r.agm;g.method_added=h(r.agm.methodAdded,"method_added","methodAdded"),g.method_removed=h(r.agm.methodRemoved,"method_removed","methodRemoved"),g.server_added=h(r.agm.serverAdded,"server_added","serverAdded"),g.server_method_aded=h(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),g.server_method_removed=h(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(e){return Promise.reject({err:e,libs:f})}))};"undefined"!=typeof window&&(window.GlueCore=fi),fi.version=Tn,fi.default=fi;const gi=(mi=fi,n=>e(void 0,void 0,void 0,(function*(){const e=(e=>{var n;const i=Object.assign({},t,e);return i.systemLogger&&(i.logger=null!==(n=i.systemLogger.level)&&void 0!==n?n:"trace"),i})(n);if(window.glue42gd)return(e=>{var t,n;const i={windows:!0,layouts:"full",appManager:"full",channels:!0,libraries:e.libraries,logger:null!==(n=null===(t=null==e?void 0:e.systemLogger)||void 0===t?void 0:t.level)&&void 0!==n?n:"warn"};return window.Glue(i)})(e);(()=>{const e=window.glue42core;if(e){if(e.webStarted)throw new Error("The Glue42 Core Web has already been started for this application.");e.webStarted=!0}else window.glue42core={webStarted:!0}})();const i=yield(r=()=>mi(e,{version:ot}),o=3e4,s="Glue Web initialization timed out, because core didn't resolve",new Promise((e,t)=>{let n=!0;const i=setTimeout(()=>{n&&(n=!1,t(s||"Promise timeout hit: "+o))},o);r().then(t=>{n&&(n=!1,clearTimeout(i),e(t))}).catch(e=>{n&&(n=!1,clearTimeout(i),t(e))})}));var r,o,s;const a=i.logger.subLogger("web.main.controller"),c=new rt(i);return yield c.bridge.start(c.controllers),a.trace("the bridge has been started, initializing all controllers"),yield Promise.all(Object.values(c.controllers).map(e=>e.start(i,c))),a.trace("all controllers reported started, starting all additional libraries"),yield Promise.all(e.libraries.map(t=>t(i,e))),a.trace("all libraries were started, glue is ready, returning it"),i})));var mi;if("undefined"!=typeof window){const e=window;e.GlueWeb=gi,delete e.GlueCore}return gi.version=ot,gi}));
//# sourceMappingURL=web.umd.min.js.map
