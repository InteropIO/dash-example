!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):((t="undefined"!=typeof globalThis?globalThis:t||self).desktop=t.desktop||{},t.desktop.min=e())}(this,(function(){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};function e(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=function(){return(n=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function i(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function o(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var a=function(){return(a=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function c(t,e,n,i){return new(n||(n=Promise))((function(o,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function u(t,e){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){s=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){s.label=r[1];break}if(6===r[0]&&s.label<o[1]){s.label=o[1],o=r;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(r);break}o[2]&&s.ops.pop(),s.trys.pop();continue}r=e.call(t,s)}catch(t){r=[6,t],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}function d(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i}var p=1,h=2,f=3,l=4;function g(t){return t.type===f?"timestamp":t.type===h?"number":t.type===p?"string":t.type===l?"object":"unknown"}function y(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function v(t){var e={},n=g(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=y(t.value[n]);if("object"===i){var o=function t(e){return Object.keys(e).reduce((function(n,i){var o=y(e[i]);return n[i]="object"===o?{type:"object",description:"",context:{},composite:t(e[i])}:{type:o,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:o}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=m(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function m(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function w(t){return"timestamp"===g(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,i){var o=e[i];return"object"==typeof o&&o.constructor!==Date?n[i]=t(o):o.constructor===Date?n[i]=new Date(o).getTime():o.constructor===Boolean?n[i]=o.toString():n[i]=o,n}),{})}(t.value)}function b(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var o=t.path.join(".");n===i.length-1?e+=o+"."+t.name+": "+t.description:e+=o+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var _=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},I=function(){function t(t,e,n,i,o){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=o,this.path=[],_(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){return this.value=t,this.transport.updateMetric(this)},t}(),A=function(t){function e(e,n,i,o){return t.call(this,e,n,i,o,h)||this}return s(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(I),C=function(t){function e(e,n,i,o){return t.call(this,e,n,i,o,l)||this}return s(e,t),e.prototype.update=function(t){return this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(I),S=function(t){function e(e,n,i,o){return t.call(this,e,n,i,o,p)||this}return s(e,t),e}(I),T=function(t){function e(e,n,i,o){return t.call(this,e,n,i,o,f)||this}return s(e,t),e.prototype.now=function(){this.update(new Date)},e}(I);var k=function(){function t(t,e){e.init(this),this.root=function t(e,n,i,o,r){if(!n)throw new Error("Repository is required");if(!i)throw new Error("Transport is required");var s,a,c=i,u=e,d=r||"",g=n,y=o,v=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(o),m={},w=(a="/",((s=v)&&s.length>0?s.join(a):"")+e),b=n.root,_=[],I=[];function k(t,e,n,i){var o={name:""};o="string"==typeof t?{name:t}:t;var r=I.filter((function(t){return t.name===o.name}));if(r.length>0){var s=r[0];if(s.type!==e)throw new Error("A metric named "+o.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=i(o);return I.push(a),a}var x={get name(){return u},get description(){return d},get repo(){return g},get parent(){return y},path:v,id:w,root:b,get subSystems(){return _},get metrics(){return I},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var i=_.filter((function(t){return t.name===e}));if(i.length>0)return i[0];var o=t(e,g,c,x,n);return _.push(o),o},getState:function(){return m},setState:function(t,e){m={state:t,description:e},c.updateSystem(x,m)},stringMetric:function(t,e){return k(t,p,e,(function(t){return new S(t,x,c,e)}))},timestampMetric:function(t,e){return k(t,f,e,(function(t){return new T(t,x,c,e)}))},objectMetric:function(t,e){return k(t,l,e,(function(t){return new C(t,x,c,e)}))},numberMetric:function(t,e){return k(t,h,e,(function(t){return new A(t,x,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(m).length>0&&t.push({name:u,path:v,state:m.state,description:m.description}),_.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(x),x}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var o=t.stringMetric("StartURL",""),r=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;o.update(s)}void 0!==window.glue42gd&&r.update(window.glue42gd.appName)}},t}(),x=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){return Promise.resolve()},t.prototype.updateSystem=function(t,e){return Promise.resolve()},t.prototype.createMetric=function(t){return Promise.resolve()},t.prototype.updateMetric=function(t){return Promise.resolve()},t}(),P=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();t.length<=this.lastCount||(this.lastCount=t.length,this.system.stringMetric("entries",JSON.stringify(t)))},t}(),M=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){var n,i,o=this;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var r=function(t){s(t.root)},s=function(t){d(t),t.metrics.forEach((function(t){p(t)})),t.subSystems.forEach((function(t){s(t)}))},d=function(t){return c(o,void 0,void 0,(function(){var e,o;return u(this,(function(r){switch(r.label){case 0:return void 0===t.parent?[2]:[4,n];case 1:return r.sent(),e={name:m(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},o={type:"define",metrics:[e]},i.send(o),[2]}}))}))},p=function(t){return c(o,void 0,void 0,(function(){var e,o,r;return u(this,(function(s){switch(s.label){case 0:return e=f(t),[4,n];case 1:return s.sent(),o=v(e),r={type:"define",metrics:[o]},i.send(r),void 0!==e.value&&h(e),[2]}}))}))},h=function(t){if(l()){var e=w(t),n={type:"publish",values:[{name:m(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};return i.sendFireAndForget(n)}return Promise.resolve()},f=function(t){var e=a({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=a({},t.value)),e},l=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(o){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&r(o)})),i.join({system:e.system,service:e.service,instance:e.instance})},createSystem:d,updateSystem:function(e,r){return c(o,void 0,void 0,(function(){var o,s,a;return u(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),o={type:"publish",values:[{name:m(e.path.join("/")+"/"+e.name+"/State"),value:{Description:r.description,Value:r.state},timestamp:Date.now()}]},i.send(o),s=b(e),a={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},i.send(a),[2]}}))}))},createMetric:p,updateMetric:function(t){return c(o,void 0,void 0,(function(){var e;return u(this,(function(i){switch(i.label){case 0:return e=f(t),[4,n];case 1:return i.sent(),h(e),[2]}}))}))}}}(t.connection,t):new x;var n=new k(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var i=function(t){var e,n=t.subSystem("reporting"),i={name:"features"},o=function(t,o,r){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===r||""===r)throw new Error("payload is mandatory");e?e.update({name:t,action:o,payload:r}):e=n.objectMetric(i,{name:t,action:o,payload:r})};return t.featureMetric=o,t}(n);return function(t,e){var n,i;if("undefined"==typeof window)return;var o=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;o&&(e=o);(null==e?void 0:e.enabled)&&new P(t,e.initialPublishTimeout,e.publishInterval)}(i,t.pagePerformanceMetrics),i};function j(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var o=n instanceof Error?n:new Error(n);if(e)e(o);else{var r='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(r);case"silent":return;case"throw":throw new Error(r)}console.error(r)}}return{add:function(t,e,o){var r=n[t];return r||(r=[],n[t]=r),r.push(e),o&&setTimeout((function(){o.forEach((function(o){var r;if(null===(r=n[t])||void 0===r?void 0:r.includes(e))try{Array.isArray(o)?e.apply(void 0,o):e.apply(void 0,[o])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var r=n[t];if(!r||0===r.length)return[];var s=[];return r.forEach((function(n){try{var o=n.apply(void 0,e);s.push(o)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}j.default=j;var O=j,E=function(){function t(t,e){var n=this;this.registry=O(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),R=function(){function t(t,e){var n=this;this.logger=e,this.registry=O(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),W=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),F=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),N={};function L(t){var e=N[t];if(e)return e;var n=[];function i(){return(new Date).getTime()}var o,r,s=i();function a(t,e){var o=null!=e?e:i(),r=0;n.length>0&&(r=o-n[n.length-1].time),n.push({name:t,time:o,diff:r})}a("start",s);var c={get startTime(){return s},get endTime(){return o},get period(){return r},stop:function(){return a("end",o=i()),r=o-s},mark:a,marks:n};return N[t]=c,c}var D=W.isNode()?require("ws"):window.WebSocket,G=function(){function t(t,e){if(this.startupTimer=L("connection"),this._running=!0,this._registry=O(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var o;try{null===(o=n.ws)||void 0===o||o.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new F;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return c(this,void 0,void 0,(function(){var n=this;return u(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new F;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new D(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var o=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(o.has(e))return;o.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var H=1;var B,q,U,V={nextValue:function(){return(H=(9301*H+49297)%233280)/233280},seed:function(t){H=t}},z="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function J(){U=!1}function K(t){if(t){if(t!==B){if(t.length!==z.length)throw new Error("Custom alphabet for shortid must be "+z.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+z.length+" unique characters. These characters were not unique: "+e.join(", "));B=t,J()}}else B!==z&&(B=z,J())}function Z(){return U||(U=function(){B||K(z);for(var t,e=B.split(""),n=[],i=V.nextValue();e.length>0;)i=V.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Y={characters:function(t){return K(t),B},seed:function(t){V.seed(t),q!==t&&(J(),q=t)},lookup:function(t){return Z()[t]},shuffled:Z},X="object"==typeof window&&(window.crypto||window.msCrypto);var Q=function(){if(!X||!X.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return X.getRandomValues(t),48&t[0]};var $=function(t,e){for(var n,i=0,o="";!n;)o+=t(e>>4*i&15|Q()),n=e<Math.pow(16,i+1),i++;return o};var tt=function(t){var e=Y.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var et=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Y.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},nt=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function o(){var t="",o=Math.floor(.001*(Date.now()-1459707606518));return o===n?e++:(e=0,n=o),t+=$(Y.lookup,6),t+=$(Y.lookup,i),e>0&&(t+=$(Y.lookup,e)),t+=$(Y.lookup,o)}t.exports=o,t.exports.generate=o,t.exports.seed=function(e){return Y.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&Y.characters(t),Y.shuffled()},t.exports.decode=tt,t.exports.isValid=et})),it=(nt.generate,nt.seed,nt.worker,nt.characters,nt.decode,nt.isValid,nt);function ot(t,e,n,i,o){null==t&&(t="global"),i=i||["success"],o=o||["error"];var r,s=!1,a=!1,c=!1,u=O();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(r))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return f(t)}))})),o&&o.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return r=e,new Promise((function(i,o){if(s)i();else{var r;if("global"===t)r=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),r=g({type:"join",destination:t,domain:"global",options:e});r.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),o(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function l(){return it()}function g(i,o,r){r=r||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,r.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=o,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=o,a(t)}},e.send(i,r).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,g({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:g,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,o){e.on(i,(function(e){if(e.domain===t)try{o(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var rt=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=O(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return c(this,void 0,void 0,(function(){var n,i,o,r,s,a,c,d,p,h;return u(this,(function(u){switch(u.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return d=u.sent(),t.gatewayToken=d,[3,4];case 3:return i=u.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(o=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return o.token=u.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}u.label=10;case 10:r={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(r.request_id=t.sessionId),this.globalDomain=ot("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),u.label=11;case 11:u.trys.push([11,19,20,21]),a=void 0,u.label=12;case 12:return[4,this.globalDomain.send(r,void 0,s)];case 13:return"authentication-request"!==(c=u.sent()).type?[3,16]:(d=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(p=r.authentication,[4,t.flowCallback(t.sessionId,d)]):[3,15]);case 14:p.token=u.sent().data.toString("base64"),u.label=15;case 15:return r.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.debug("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw h=u.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return c(this,void 0,void 0,(function(){var t;return u(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var o=this.sessions.filter((function(e){return e.domain===t}))[0];return o||(o=ot(t,this.connection,e,n,i),this.sessions.push(o)),o},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected.bind(t),t.settings.reconnectInterval||1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),st=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var o=i[n],r=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var o=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){r(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var o=i[n];if(-1!==this.specs[o].types.indexOf(t)){var r=this.messages[o]||[];this.messages[o]=r,r.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,o=this.specs[t].types;i<o.length;i++){var r=o[i];this.subsRefCount[r]-=1,this.subsRefCount[r]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[r]),delete this.subs[r],delete this.subsRefCount[r])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),at=function(t,e,n){return new Promise((function(i,o){var r=setTimeout((function(){o(n||"Promise timeout hit: "+e)}),e);new Promise(t).then((function(t){clearTimeout(r),i(t)})).catch((function(t){clearTimeout(r),o(t)}))}))},ct=function(){function t(t,e,n){this.settings=t,this.logger=e,this.identity=n,this.parentReady=!1,this.iAmConnected=!1,this.rejected=!1,this.children=[],this.parentPingTimeout=3e3,this.connectionRequestTimeout=5e3,this.defaultTargetString="*",this.registry=O(),this.messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:this.handleParentReady.bind(this)},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformUnload:{name:"platformUnload",handle:this.handlePlatformUnload.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)}},this.setUpMessageListener(),this.setUpUnload(),this.settings.port||(this.parent=window.opener||window.top,this.parentType=window.opener?"opener":-1!==window.name.indexOf("#wsp")?"workspace":"top")}return Object.defineProperty(t.prototype,"transportWindowId",{get:function(){return this.publicWindowId},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return c(this,void 0,void 0,(function(){return u(this,(function(e){if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");return this.port.postMessage(t),[2]}))}))},Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.send=function(){return Promise.reject("not supported")},t.prototype.onConnectedChanged=function(t){return this.registry.add("onConnectedChanged",t)},t.prototype.open=function(){return c(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return this.logger.debug("opening a connection to the web platform gateway."),[4,this.connect()];case 1:return t.sent(),this.notifyStatusChanged(!0),[2]}}))}))},t.prototype.close=function(){return Promise.resolve()},t.prototype.name=function(){return"web-platform"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.connect=function(){return c(this,void 0,void 0,(function(){var t=this;return u(this,(function(e){switch(e.label){case 0:if(this.parentReady)return this.logger.debug("cancelling connection attempt, because this client's parent has already given a ready signal"),[2];if(this.settings.port)return this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.publicWindowId=this.settings.windowId,this.identity&&(this.identity.windowId=this.publicWindowId),this.port.onmessage=function(e){return t.registry.execute("onMessage",e.data)},this.logger.debug("internal web platform connection completed"),[2];if(!this.parentType||!this.parent)throw new Error("Cannot initiate a connection, because there is no opener, no top and no port.");return this.logger.debug("opening a "+("opener"===this.parentType?"child":"grandchild")+" client web platform connection"),[4,this.waitParent(this.parent,this.parentType)];case 1:return e.sent(),[4,this.initiateRemoteConnection(this.parent,this.parentType)];case 2:return e.sent(),this.logger.debug("the "+("opener"===this.parentType?"child":"grandchild")+" client is connected"),[2]}}))}))},t.prototype.initiateRemoteConnection=function(t,e){var n=this;return at((function(i,o){n.connectionResolve=i,n.connectionReject=o,n.myClientId=it();var r="workspace"===n.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window.name,s={glue42core:{type:n.messages.connectionRequest.name,clientId:n.myClientId,clientType:"top"===e||"workspace"===e?"grandChild":"child",bridgeInstanceId:r}};n.logger.debug("sending connection request to "+e),t.postMessage(s,n.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the opener/top window timed out")},t.prototype.waitParent=function(t,e){var n=this;return at((function(i){n.parentPingResolve=i;var o={glue42core:{type:"opener"===e?n.messages.platformPing.name:n.messages.parentPing.name}};n.logger.debug("checking for "+e+" window availability"),t.postMessage(o,n.defaultTargetString)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client")},t.prototype.setUpMessageListener=function(){var t=this;this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(function(e){var n,i=null===(n=e.data)||void 0===n?void 0:n.glue42core;if(i&&!t.rejected)if(t.checkMessageTypeValid(i.type)){var o=i.type;t.logger.debug("received valid glue42core message of type: "+o),t.messages[o].handle(e)}else t.logger.error("cannot handle the incoming glue42 core message, because the type is invalid: "+i.type)}))},t.prototype.setUpUnload=function(){var t=this;this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(function(){var e,n,i={glue42core:{type:t.messages.clientUnload.name,data:{clientId:t.myClientId,ownWindowId:null===(e=t.identity)||void 0===e?void 0:e.windowId}}};t.parent&&t.parent.postMessage(i,t.defaultTargetString),null===(n=t.port)||void 0===n||n.postMessage(i)}))},t.prototype.handleParentReady=function(){if(this.logger.debug("handling the ready signal from the parent, by resoling the pending promise."),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},t.prototype.handlePlatformReady=function(){if(this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},t.prototype.handleConnectionAccepted=function(t){var e,n=null===(e=t.data)||void 0===e?void 0:e.glue42core;return this.myClientId===n.clientId?this.handleAcceptanceOfMyRequest(n):this.handleAcceptanceOfGrandChildRequest(n,t)},t.prototype.handleAcceptanceOfMyRequest=function(t){var e=this;if(this.logger.debug("handling a connection accepted signal targeted at me."),t.port){if(this.publicWindowId="opener"===this.parentType?window.name:"top"===this.parentType?t.parentWindowId:window.name.substring(0,window.name.indexOf("#wsp")),this.identity&&"top"!==this.parentType&&(this.identity.windowId=this.publicWindowId),this.identity&&t.appName&&(this.identity.application=t.appName,this.identity.applicationName=t.appName),this.port=t.port,this.port.onmessage=function(t){return e.registry.execute("onMessage",t.data)},this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")},t.prototype.handleAcceptanceOfGrandChildRequest=function(t,e){this.logger.debug("handling a connection accepted signal targeted at a grandchild: "+t.clientId);var n=this.children.find((function(e){return e.grandChildId===t.clientId}));n?(n.connected=!0,this.logger.debug("the grandchild connection for "+t.clientId+" is set up, forwarding the success message and the gateway port"),t.parentWindowId=this.publicWindowId,n.source.postMessage(e.data,n.origin,[t.port])):this.logger.error("cannot handle connection accepted for grandchild: "+t.clientId+", because there is no grandchild with this id")},t.prototype.handleConnectionRejected=function(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)},t.prototype.handleConnectionRequest=function(t){var e=t.source,n=t.data.glue42core;return n.clientType&&"grandChild"===n.clientType?n.clientId?"opener"===this.parentType&&this.parent?(this.logger.debug("handling a connection request for a grandchild: "+n.clientId),this.children.push({grandChildId:n.clientId,source:e,connected:!1,origin:t.origin}),this.logger.debug("grandchild: "+n.clientId+" is prepared, forwarding connection request to the platform"),void this.parent.postMessage(t.data,this.defaultTargetString)):this.rejectConnectionRequest(e,t.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(e,t.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(e,t.origin,"rejecting a connection request, because the source was not opened by a glue API call")},t.prototype.handleParentPing=function(t){if(this.parentReady)if(this.iAmConnected){var e={glue42core:{type:this.messages.parentReady.name}},n=t.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(e,t.origin)}else this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");else this.logger.debug("my parent is not ready, I am ignoring the parent ping")},t.prototype.handlePlatformUnload=function(t){this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.children.length&&(this.logger.debug("forwarding the platform unload to all known children and starting platform discovery polling"),this.children.forEach((function(e){return e.source.postMessage(t.data,e.origin)}))),this.notifyStatusChanged(!1,"Gateway unloaded")},t.prototype.handleClientUnload=function(t){var e=t.data.glue42core;e.clientId?this.children.find((function(t){return t.grandChildId===e.clientId}))?(this.logger.debug("handling grandchild unload for id: "+e.clientId),this.children=this.children.filter((function(t){return t.grandChildId!==e.clientId}))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")},t.prototype.handlePlatformPing=function(){this.logger.error("cannot handle platform ping, because this is not a platform calls handling component")},t.prototype.notifyStatusChanged=function(t,e){this.iAmConnected=t,this.registry.execute("onConnectedChanged",t,e)},t.prototype.checkMessageTypeValid=function(t){return"string"==typeof t&&!!this.messages[t]},t.prototype.rejectConnectionRequest=function(t,e,n){this.rejected=!0,this.logger.error(n);var i={glue42core:{type:this.messages.connectionRejected.name}};t.postMessage(i,e)},t}(),ut=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=O(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new E(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new R(t.sharedWorker,e.subLogger("shared-worker"));else if(t.webPlatform)this.transport=new ct(t.webPlatform,e.subLogger("web-platform"),t.identity);else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new G(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.debug("starting with "+this.transport.name()+" transport"),this.protocol=new rt(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new st(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(i){switch(i.label){case 0:return[4,this.transport.open()];case 1:return i.sent(),L("connection").mark("transport-opened"),n=this.protocol.login(t,e),L("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return c(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var o=i[e];if(void 0!==o)try{o(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),dt=["trace","debug","info","warn","error","off"],pt=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return dt.indexOf(t)>=dt.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var o=this.loggerFullName;if("error"===e&&!i){var r=new Error;r.stack&&(n=n+"\n"+r.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:o,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+o+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),ht="create-context",ft="created",lt="destroyed",gt="context-created",yt="context-added",vt="subscribe-context",mt="subscribed-context",wt="unsubscribe-context",bt="destroy-context",_t="context-destroyed",It="update-context",At="context-updated",Ct="joined",St={get name(){return"context"},get types(){return[ht,ft,lt,gt,yt,vt,mt,wt,bt,_t,It,At,Ct]}},Tt="5.4.0";var kt=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function xt(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=a({},e.reset);if(t=Pt(t,void 0),e.commands){for(var i=0,o=e.commands;i<o.length;i++){var r=o[i];"remove"===r.type?Et(t,r.path):"set"===r.type&&Ot(t,r.value,r.path)}return t}var s=e.added,c=e.updated,u=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),c&&Object.keys(c).forEach((function(e){Mt(e,t,c)})),u&&u.forEach((function(e){delete t[e]})),t}catch(i){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),i),t}}function Pt(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),t instanceof Map&&Array.from(t,(function(t){var i=t[0],o=t[1];return n.set(i,Pt(o,e))})),Object.assign.apply(Object,d([n],Object.keys(t).map((function(n){var i;return(i={})[n]=Pt(t[n],e),i}))))}var Mt=function(t,e,n){var i=n[t];if(void 0===i)return e;var o=e[t];return o&&i?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(o)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},o,i),e):(e[t]=i,e)};function jt(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!jt(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Ot(t,e,n){var i,o=n.split(".");for(i=0;i<o.length-1;i++)t[o[i]]||(t[o[i]]={}),"object"!=typeof t[o[i]]&&(t[o[i]]={}),t=t[o[i]];t[o[i]]=e}function Et(t,e){var n,i=e.split(".");for(n=0;n<i.length-1;n++){if(!t[i[n]])return;t=t[i[n]]}delete t[i[n]]}var Rt,Wt=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[gt,mt,_t,At]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(St.name,(function(t){var e=t.type;e&&(e===gt||e===yt||e===ft?n.handleContextCreatedMessage(t):e===mt||e===At||e===Ct?n.handleContextUpdatedMessage(t):e!==_t&&e!==lt||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:ht,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){n._contextNameToId[t]=i.context_id,n._contextIdToName[i.context_id]=t;var o=n._contextNameToData[t]||new kt(i.context_id,t,!0,void 0);return o.isAnnounced=!0,o.name=t,o.contextId=i.context_id,o.context=e,n._contextNameToData[t]=o,i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return c(this,void 0,void 0,(function(){var i,o,r,s=this;return u(this,(function(a){switch(a.label){case 0:return(i=this._contextNameToData[t])&&i.isAnnounced?(o=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(t,e)];case 1:o=a.sent(),a.label=2;case 2:return r=2===this.protocolVersion?this.calculateContextDeltaV2(o,e):this.calculateContextDeltaV1(o,e),Object.keys(r.added).length||Object.keys(r.updated).length||r.removed.length||(null===(n=r.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:It,domain:"global",context_id:i.contextId,delta:r},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(i,r,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:It,domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[t];if(!i||!i.isAnnounced){for(var o={},r=0,s=e;r<s.length;r++){Ot(o,(d=s[r]).value,d.path)}return this.createContext(t,o)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:It,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,i=this._contextNameToData[t];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(e,i){return c(n,void 0,void 0,(function(){var n=this;return u(this,(function(i){return this.subscribe(t,(function(t,i,o,r){n.unsubscribe(r),e(t)})),[2]}))}))}));var o=null!==(e=null==i?void 0:i.context)&&void 0!==e?e:{};return Promise.resolve(o)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new kt(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var o,r=i.hasCallbacks();return i.updateCallbacks[n]=e,r||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(o=Pt(i.context),o,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],o=(this._contextNameToId[i],this._contextNameToData[i]);if(!o)return;var r=o.hasCallbacks();delete o.updateCallbacks[t],o.isAnnounced&&r&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:bt,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=xt(t.context,e,this._logger),this._contextNameToData[t.name]!==t||jt(i,t.context)||this.invokeUpdateCallbacks(t,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[yt,gt,ft];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===ft?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===yt&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new kt(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[At,mt,Ct];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],o=!i||!i.isAnnounced;if(e===Ct)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new kt(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===mt?((i=i||new kt(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var r=i.context;if(e===mt)i.context=t.data||{};else if(e===Ct)i.context=t.context_snapshot||{};else{if(e!==At)throw new Error("Unrecognized context update message "+e);i.context=xt(i.context,t.delta,this._logger)}!o&&jt(i.context,r)&&e!==mt||this.invokeUpdateCallbacks(i,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n){if((e=e||{added:{},updated:{},reset:{},removed:[]}).commands){e.added=e.updated=e.reset={},e.removed=[];for(var i=0,o=e.commands;i<o.length;i++){var r=o[i];"remove"===r.type?(-1===r.path.indexOf(".")&&e.removed.push(r.path),Ot(e.updated,null,r.path)):"set"===r.type&&Ot(e.updated,r.value,r.path)}}for(var s in t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(s))try{(0,t.updateCallbacks[s])(Pt(t.context),Object.assign({},e.added||{},e.updated||{},e.reset||{}),e.removed,parseInt(s,10),n)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[_t,lt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===lt){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:vt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:wt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,o=Object.keys(t);i<o.length;i++){var r=o[i];-1===Object.keys(e).indexOf(r)||null===e[r]||jt(t[r],e[r])||(n.updated[r]=e[r])}for(var s=0,a=Object.keys(e);s<a.length;s++){r=a[s];t&&-1!==Object.keys(t).indexOf(r)?null===e[r]&&n.removed.push(r):null!==e[r]&&(n.added[r]=e[r])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,i,o={added:{},updated:{},removed:[],reset:void 0,commands:[]},r=0,s=Object.keys(e);r<s.length;r++){var a=s[r];if(null!==e[a])jt(t?t[a]:null,e[a])||null===(n=o.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(i=o.commands)||void 0===i||i.push({type:"remove",path:a})}return o},t}(),Ft=function(){function t(t){this._bridge=new Wt(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=e;n<i.length;n++){var o=i[n],r=o.path,s=o.value;this.checkPath(r),""===r&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,i,o,r,s){return e(t,i,o,(function(){return n._bridge.unsubscribe(r)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function Nt(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function Lt(t,e,n){var i;return void 0===t&&(t=0),e.finally((function(){i&&clearTimeout(i)})),new Promise((function(e,o){i=setTimeout((function(){return o(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Rt||(Rt={}));var Dt=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,o){var r=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,r.protocol.client.subscribe(n,e,t,i,s,o)};return Nt(new Promise((function(n,i){var o,a=function(t){n(t)},c=function(t){i(t)};if(t)if((o="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=r.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=r.configuration.waitTimeoutMs));var d=0,p=r.getServerMethodsByFilterAndTarget(o,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=r.getServerMethodsByFilterAndTarget(o,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:a({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:a({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,i,o,r){return c(this,void 0,void 0,(function(){var s=this;return u(this,(function(d){return[2,Nt(function(){return c(s,void 0,void 0,(function(){var o,r,s,c,d,p,h,f,l,g,y,v,m=this;return u(this,(function(u){switch(u.label){case 0:if(!(o="string"==typeof t?{name:t}:a({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+o.name))];if(0!==(r=this.getServerMethodsByFilterAndTarget(o,n)).length)return[3,4];u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(o,n,i)];case 2:return r=u.sent(),[3,4];case 3:return u.sent(),s=a(a({},o),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(g=o.objectTypes)&&void 0!==g?g:[],flags:null!==(v=null===(y=o.flags)||void 0===y?void 0:y.metadata)&&void 0!==v?v:{}}),c={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(c)];case 4:return d=i.methodResponseTimeoutMs,p=i,h=r.map((function(t){var n=it(),i=t.methods[0],o=t.server,r=m.protocol.client.invoke(n,i,e,o,p);return Promise.race([r,Lt(d,r,{invocationId:n,message:"Invocation timeout ("+d+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(o.instance)+", options: "+JSON.stringify(p),status:Rt.Error})])})),[4,Promise.all(h)];case 5:return f=u.sent(),l=this.getInvocationResultObj(f,o,e),f.every((function(t){return t.status===Rt.Error}))?[2,Promise.reject(l)]:[2,l]}}))}))}(),o,r)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===Rt.Success})).reduce((function(t,i){return t=d(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),o=t.filter((function(t){return t.status===Rt.Error})).reduce((function(t,i){return t=d(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),r=t[0];return{method:e,called_with:n,returned:r.result,executed_by:r.instance,all_return_values:i,all_errors:o,message:r.message,status:r.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(o,r){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),o(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void r()}),500);else r()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var o=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(o)}),[])}if("all"===t)return d(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).every((function(n){var i,o=t[n],r=e[n];switch(n){case"objectTypes":i=(o||[]).every((function(t){return(r||[]).includes(t)}));break;case"flags":i=function t(e,n){return Object.keys(n).every((function(i){return"object"==typeof n[i]?t((null==e?void 0:e[i])||{},n[i]||{}):n[i]===(null==e?void 0:e[i])}))}(r||{},o||{});break;default:i=String(o).toLowerCase()===String(r).toLowerCase()}return i}))},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var o=Object.values(i.methods).filter((function(n){return e.methodMatch(t,n)}));return o.length>0&&n.push({server:i,methods:o}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),Gt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),Ht=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),Bt=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new Ht(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new Gt(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new Gt(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),qt=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new Gt(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),Ut=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new qt(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new qt(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new Gt(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t,e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:null===(t=e.flags)||void 0===t?void 0:t.metadata}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),Vt=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Bt(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i,o){var r=this;return Nt(new Promise((function(n,i){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:a({},t)).name)return i("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(s));if(r.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var c=r.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});r.protocol.server.createStream(c).then((function(){var t;o?(t=o,o.updateRepoMethod(c)):t=new Ut(r.protocol,c,r),c.stream=t,n(t)})).catch((function(t){c.repoId&&r.serverRepository.remove(c.repoId),i(t)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return c(n,void 0,void 0,(function(){var n,o,r;return u(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return o=s.sent(),i(void 0,o),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(r=s.sent())||(r=""),i(r,r),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,o=function(t){i||n(void 0,t),i=!0},r=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,o,r);s&&"function"==typeof s.then&&s.then(o).catch(r)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),c(this,void 0,void 0,(function(){var n,i;return u(this,(function(o){switch(o.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return c(this,void 0,void 0,(function(){var n;return u(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return c(this,void 0,void 0,(function(){var n,i=this;return u(this,(function(o){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return c(this,void 0,void 0,(function(){var n,i,o,r=this;return u(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:a({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+n.name+" to be a stream, please use the glue.interop.createStream() method.")]:(o=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(o).catch((function(t){throw(null==o?void 0:o.repoId)&&r.serverRepository.remove(o.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,o){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o?("object"!=typeof o||Array.isArray(o))&&(o={_value:o}):o={},i.protocol.server.methodInvocationResult(t,e,n,o)}))},t}(),zt=function(){function t(t,e,n){var i=this;this.wrapped={},this.wrapped.getMethods=function(){return t.methodsForInstance(this)},this.wrapped.getStreams=function(){return t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))},e&&this.refreshWrappedObject(e),n&&(n.loggedIn((function(){i.refresh(n)})),this.refresh(n))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:it(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}(),Jt=function(t){return a(a({},t),{flags:t.flags.metadata||{}})},Kt=function(){function t(t,e){this.logger=t,this.API=e,this.servers={},this.methodsCount={},this.callbacks=O();var n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new zt(this.API,t),o={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=o,this.callbacks.execute("onServerAdded",o.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n,i=this.servers[t];if(!i)throw new Error("server does not exists");if(!i.methods[e.id]){var o=this.createMethodIdentifier(e),r=this,s={identifier:o,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,flags:null!==(n=e.flags)&&void 0!==n?n:{},getServers:function(){return r.getServersByMethod(o)}};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,i.methods[e.id]=s;var a=Jt(s);return this.methodsCount[o]||(this.methodsCount[o]=0,this.callbacks.execute("onMethodAdded",a)),this.methodsCount[o]=this.methodsCount[o]+1,this.callbacks.execute("onServerMethodAdded",i.instance,a),s}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e];var o=Jt(i);this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",o),this.callbacks.execute("onServerMethodRemoved",n.instance,o)},t.prototype.getMethods=function(){return this.extractMethodsFromServers(Object.values(this.servers)).map(Jt)},t.prototype.getServers=function(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(o){n||t(e.instance,i[o])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.hideServerMethodSystemFlags(this.servers[t])},t.prototype.reset=function(){var t,e=this;Object.keys(this.servers).forEach((function(t){e.removeServerById(t,"reset")})),this.servers=((t={})[this.myServer.id]=this.myServer,t),this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=[];return Object.values(this.servers).forEach((function(n){Object.values(n.methods).forEach((function(i){i.identifier===t&&e.push(n.instance)}))})),e},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t.prototype.hideServerMethodSystemFlags=function(t){var e={};return Object.entries(t.methods).forEach((function(t){var n=t[0],i=t[1];e[n]=Jt(i)})),a(a({},t),{methods:e})},t.prototype.extractMethodsFromServers=function(t){return Object.values(t).reduce((function(t,e){return d(t,Object.values(e.methods))}),[])},t}(),Zt=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),Yt="onSubscriptionRequest",Xt="onSubscriptionAdded",Qt="onSubscriptionRemoved",$t=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=O(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),o=t.msg.subscription_id,r={id:o,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[o]=r,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:i}),this.callbacks.execute(Xt,r,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(Qt,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,o=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(o=o.filter((function(t){return t.branchKey===e}))),o.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(Xt,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(Yt,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(Qt,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(Qt,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(Yt,n,i);else{var o="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(o,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),te=function(){function t(t,e,n,i){var o=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=O(),this.streaming=new $t(t,e,n),this.session.on("invoke",(function(t){return o.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n,i=this,o=t.definition,r=Object.assign({},{metadata:null!==(n=o.flags)&&void 0!==n?n:{}},{streaming:e||!1}),s={type:"register",methods:[{id:t.repoId,name:o.name,display_name:o.displayName,description:o.description,version:o.version,flags:r,object_types:o.objectTypes||o.object_types,input_signature:o.accepts,result_signature:o.returns,restrictions:void 0}]};return this.session.send(s,{methodId:t.repoId}).then((function(){i.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw i.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var o;o=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(o)},t.prototype.unregister=function(t){return c(this,void 0,void 0,(function(){var e;return u(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,o=t.arguments_kv,r=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==r){var s={args:o,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",r,e,s)}},t}(),ee=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),ne="awaitingAccept",ie="subscribed",oe="Subscription failed.",re="ClientInitiated",se=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,o=i.subscriptionsList[n];if("object"==typeof o&&(o.trackedServers=o.trackedServers.filter((function(t){return t.serverId!==e.serverId})),o.trackedServers.length<=0)){if(clearTimeout(o.timeoutId),o.status===ne){var r="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof o.params.arguments?JSON.stringify(o.params.arguments):"{}";o.error({message:"Subscription rejected."+r+" Called with:"+s,called_with:o.params.arguments,method:o.method})}else o.status===ie&&i.callOnClosedHandlers(o);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var o=t._tag.serverId,r=n.trackedServers.filter((function(t){return t.serverId===o}))[0];if("object"==typeof r){r.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===ne;if(n.status=ie,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new ee(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var o=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===o.length){var r=t.oob,s=o[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:r}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var o=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===o&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,o,r){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,o,e.methodResponseTimeout||1e4,r);"object"==typeof c?n.forEach((function(n){var i=n.server.id,o=n.methods.find((function(e){return e.name===t.name}));if(o){c.trackedServers.push({serverId:i,subscriptionId:void 0});var r={type:"subscribe",server_id:i,method_id:o.gatewayId,arguments_kv:e.arguments};s.session.send(r,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):o({method:t,called_with:e.arguments,message:oe+" Unable to register the user callbacks."})}else o({method:t,called_with:e.arguments,message:oe+" No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,o,r,s){var a=this,c={localKey:t,status:ne,method:e,params:n,success:i,error:o,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];i.status===ne?(o({method:e,called_with:n.arguments,message:oe+" Subscription attempt timed out after "+r+" ms."}),delete a.subscriptionsList[t]):i.status===ie&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),r),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,o=i>0?t.queued.closers[i-1]:null;void 0!==o&&"string"==typeof o&&(n=this.repository.getServerById(o).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:re}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,re),delete this.subscriptionsList[t])},t}(),ae=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new se(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,o,r){this.streaming.subscribe(t,e,n,i,o,r)},t.prototype.invoke=function(t,e,n,i){var o=this,r=i.id,s={type:"call",server_id:r,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:r}).then((function(t){return o.handleResultMessage(t)})).catch((function(t){return o.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,o=Number(n.process),r={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(r,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(t){var r=o.methods[t];i.indexOf(r.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:Rt.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),o=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:Rt.Error,message:o}}return{invocationId:"",message:t.message,status:Rt.Error,error:t}},t}();function ce(t,e,n,i,o,r){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new te(u,n,i,a.subLogger("server")),p=new ae(u,n,a.subLogger("client"));return u.onJoined((function(o){n.addServer(t,e.peerId),o?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],o=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+o.name),r.client.subscribe(o,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?r.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?r.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&r.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var ue=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),this.unwrappedInstance=new zt(this,void 0,i),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new Kt(t.logger.subLogger("cRep"),this),this.serverRepository=new Zt,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=ce(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Dt(e.protocol,e.clientRepository,e.instance,t),e.server=new Vt(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,o,r){return this.client.invoke(t,e,n,i,o,r)},t.prototype.waitForMethod=function(t){var e=new F,n=this.client.methodAdded((function(i){i.name===t&&(n(),e.resolve(i))}));return e.promise},t}(),de=["subscribed","success"],pe=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var o=i||{},r=o.routingKey,s=o.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:r,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(o,r){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var r=i.subscription_id;n.subscriptions.push({subscription_id:r,topic:t,callback:e,source:c}),o({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:r,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==r})),Promise.resolve()}})})).catch((function(t){return r(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,o=t["publisher-identity"],r=n.subscriptions.find((function(t){return t.subscription_id===i}));r&&(r.source?n.keysMatch(r.source,o)&&r.callback(e,r.topic,o):r.callback(e,r.topic,o))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",de),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),he=function(t,e){var n,i=W.getGDMajorVersion(),o=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,o=window.gdPreloadPromise||o)}var r,s,a,d,p,h,f,l=L("glue"),g=function(t,e,n){var i,o,r,s,a,c;if(W.isNode()){var u=process.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(t){}}function d(){if(t.application)return t.application;if(n)return n.applicationName;var e=it();return W.isNode()?c?c.applicationConfig.name:"NodeJS"+e:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+e+")":e}var p=function(){var i,o,r,s,a,u,p,h,f,l,g=t.gateway,y=null!==(i=null==g?void 0:g.protocolVersion)&&void 0!==i?i:3,v=null==g?void 0:g.reconnectInterval,m=null==g?void 0:g.reconnectAttempts,w=null==g?void 0:g.ws,b=null==g?void 0:g.sharedWorker,_=null==g?void 0:g.inproc,I=null!==(o=null==g?void 0:g.webPlatform)&&void 0!==o?o:void 0;n&&(w=n.gwURL),W.isNode()&&c&&c.gwURL&&(w=c.gwURL),w||b||_||(w="ws://localhost:8385");var A=d(),C=A;void 0!==n?(p=n.windowId,h=n.pid,n.env&&(f=n.env.env,l=n.env.region),C=null!==(r=n.application)&&void 0!==r?r:"glue-app",u=n.appInstanceId):W.isNode()&&(h=process.pid,c&&(f=c.env,l=c.region,u=c.instanceId));var S=null!==(a=null===(s=t.gateway)||void 0===s?void 0:s.replaySpecs)&&void 0!==a?a:[];return S.push(St),{identity:{application:C,applicationName:A,windowId:p,instance:u,process:h,region:l,environment:f,api:e.version||Tt},reconnectInterval:v,ws:w,sharedWorker:b,webPlatform:I,inproc:_,protocolVersion:y,reconnectAttempts:m,replaySpecs:S}}(),h=d();if("undefined"!=typeof window){var f=window,l=f.htmlContainer?f.htmlContainer.containerName+"."+f.htmlContainer.application:null===(i=null==f?void 0:f.glue42gd)||void 0===i?void 0:i.application;l&&(h=l)}return{bus:null!==(o=t.bus)&&void 0!==o&&o,application:h,auth:function(){var e,n,i;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:W.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.webPlatform)||(null===(n=t.gateway)||void 0===n?void 0:n.inproc)||(null===(i=t.gateway)||void 0===i?void 0:i.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,i,o,r=t.logger,s="warn";return r||(r=s),n&&(o=n.consoleLogLevel),"string"==typeof r?{console:null!=o?o:r,publish:s}:{console:null!==(e=null!=o?o:r.console)&&void 0!==e?e:s,publish:null!==(i=r.publish)&&void 0!==i?i:s}}(),connection:p,metrics:null===(r=t.metrics)||void 0===r||r,contexts:null===(s=t.contexts)||void 0===s||s,version:e.version||Tt,libs:null!==(a=e.libs)&&void 0!==a?a:[],customLogger:t.customLogger}}(t=t||{},e=e||{},n),y={};function v(t,e,n){(f=a.canPublish("trace"))&&a.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,f&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){y[t]=e,he[t]=e}))}function m(){var t=L("interop"),e={connection:r,logger:a.subLogger("interop")};return s=new ue(e),pt.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function w(){var t=g.activities&&3===r.protocolVersion;if(g.contexts||t){var e=L("contexts");return v("contexts",p=new Ft({connection:r,logger:a.subLogger("contexts")}),e),p}var n=r.replayer;n&&n.drain(St.name)}function b(){return c(this,void 0,void 0,(function(){var t;return u(this,(function(e){return g.bus?(t=L("bus"),v("bus",h=new pe(r,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function _(t){try{return t.forEach((function(t){!function(t,e){var n=L(t),i=e(y);i&&v(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return o.then((function(){var t,e=L("logger");return(a=new pt(""+(null===(t=g.connection.identity)||void 0===t?void 0:t.application),void 0,g.customLogger)).consoleLevel(g.logger.console),a.publishLevel(g.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=L("connection");r=new ut(g.connection,a.subLogger("connection"));var e=Promise.resolve(g.auth);return g.connection&&!g.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,r.login(n)})).then((function(){return v("connection",r,t),g})).catch((function(t){throw r&&r.logout(),t}))})).then((function(){return Promise.all([(s=L("metrics"),c=g.metrics,u=null==n?void 0:n.getMetricsPublishingEnabled,p=g.connection.identity,h=u||function(){return!0},f=null!==(t="boolean"!=typeof c&&c.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",d=M({connection:c?r:void 0,logger:a.subLogger("metrics"),canUpdateMetric:h,system:"Glue42",service:null!==(e=null==p?void 0:p.service)&&void 0!==e?e:"metrics-service",instance:null!==(o=null!==(i=null==p?void 0:p.instance)&&void 0!==i?i:null==p?void 0:p.windowId)&&void 0!==o?o:it(),disableAutoAppSystem:f,pagePerformanceMetrics:"boolean"!=typeof c?null==c?void 0:c.pagePerformanceMetrics:void 0}),s),Promise.resolve()),m(),w(),b()]);var t,e,i,o,s,c,u,p,h,f})).then((function(){return s.readyPromise})).then((function(){return _(g.libs||[])})).then((function(){var t=Object.keys(y).map((function(t){var e=y[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:Tt,version:g.version};l.stop();var o={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:a,interop:s,agm:s,connection:r,metrics:d,contexts:p,bus:h,version:g.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),r.logout()}};if(o.performance={get glueVer(){return g.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=N;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(y).forEach((function(t){var e=y[t];o[t]=e})),o.config={},Object.keys(g).forEach((function(t){o.config[t]=g[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){o.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(o),n&&n.updatePerfData&&n.updatePerfData(o.performance),o.agm){var c=function(t,e,n){return function(){return o.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(o.agm,arguments)}},u=o.agm;u.method_added=c(o.agm.methodAdded,"method_added","methodAdded"),u.method_removed=c(o.agm.methodRemoved,"method_removed","methodRemoved"),u.server_added=c(o.agm.serverAdded,"server_added","serverAdded"),u.server_method_aded=c(o.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),u.server_method_removed=c(o.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return o})).catch((function(t){return Promise.reject({err:t,libs:y})}))};"undefined"!=typeof window&&(window.GlueCore=he),he.version=Tt,he.default=he;var fe=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();function le(t){return"string"==typeof t}function ge(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)}function ye(t){return void 0===t}function ve(t){return!t||void 0===t}function me(t){return!!(t&&t.constructor&&t.call&&t.apply)}function we(t,e){void 0!==t&&e(t)}var be=function(t){function n(e,n,i,o){var r=t.call(this,e)||this;return r._name=e,r._description=o,r._ownerWindow=n,r._helperWindows=i||[],r}return e(n,t),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"helperWindows",{get:function(){var t=this;return this._helperWindows.map((function(e){return t.covertToWindowDef(e)}))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ownerWindow",{get:function(){return this.covertToWindowDef(this._ownerWindow)},enumerable:!0,configurable:!0}),n.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},n.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),we(e._description,(function(t){return n._description=t})),we(e._ownerWindow,(function(t){return n._ownerWindow=t})),we(e._helperWindows,(function(t){return n._helperWindows=t}))},n.prototype.covertToWindowDef=function(t){var e,n,i,o;return{type:null===(n=null===(e=t)||void 0===e?void 0:e.id)||void 0===n?void 0:n.type,name:null===(o=null===(i=t)||void 0===i?void 0:i.id)||void 0===o?void 0:o.name}},n}(fe),_e=function(t){function n(e,n){var i=t.call(this,e)||this;return i._name=e,i._appByWindowTypeGetter=n,i}return e(n,t),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),n.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},n}(fe),Ie=function(t,e){this.entity=t,this.context=e},Ae=function(t){this.type=t},Ce=function(t){function n(e,n){var i=t.call(this,Te.StatusChange)||this;return i.newStatus=e,i.oldStatus=n,i}return e(n,t),n}(Ae),Se=function(t){function n(e,n,i){var o=t.call(this,Te.ActivityContextChange)||this;return o.context="string"==typeof e?JSON.parse(e):e,o.updated=n,o.removed=i,o}return e(n,t),n}(Ae),Te=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}(),ke=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}(),xe=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),ve(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),ve(this._activity))return[];var e=this._activity.windows,n=[],i=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),i.push(t))}))})),i},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,i,o,r,s){this._ensureHasAgm();var a=this.servers();if(ve(i)&&(i="activity.all"),le(i))if("activity.all"===i)a;else{if("activity.best"!==i){if("all"===i||"best"===i)return function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}(t.AGM.invoke(e,n,i,o),r,s);throw new Error("Invalid invoke target "+i)}var c=a.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));c.length>0&&[c[0]]}else if(ge(i)){if(i.length>=0){var u=i[0];if(this._isInstance(u))i.map((function(t){return t}));else{if(!this._isActivityWindow(u))throw new Error("Unknown target object");i.map((function(t){return t.instance}))}}}else if(this._isInstance(i))[i];else{if(!this._isActivityWindow(i))throw new Error("Unknown target object");[i.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,i){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:i,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,i){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(ve(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}(),Pe=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}(),Me=function(t){setTimeout(t,0)};function je(t,e){if(!me(e))return t;t.then((function(t){Me((function(){e(null,t)}))}),(function(t){Me((function(){e(t,null)}))}))}var Oe=function(t){function n(e,n,i,o,r){var s=t.call(this,e)||this;return s._id=e,s._actType=n,s._status=i,s._context=o,s._ownerId=r,s._agm=new xe(s),s}return e(n,t),Object.defineProperty(n.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),n.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},n.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},n.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},n.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},n.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},n.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},n.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},n.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,i,o){n.id===e.id&&t(n,i,o)}))},n.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,i,o){n.id===e.id&&t(n,i,o)}))},n.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,i,o,r){n.id===e.id&&t(i,o,r,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},n.prototype.stop=function(){this._manager.stopActivity(this)},n.prototype.clone=function(t){return this._manager.clone(this,t)},n.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},n.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,i,o){n===e._id&&t(o)}))},n.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,i,o){i.id===e._id&&t(n,o)}))},n.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),we(e._actType,(function(t){return n._actType=t})),we(e._context,(function(t){return n._context=t})),we(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},n.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new Pe(e._manager,e._id,t)}))},Object.defineProperty(n.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),n.prototype.setFrameColor=function(t,e){var n=this;return je(new Promise((function(e,i){var o=n.windows.length;0===o&&e(n),n.windows.forEach((function(i){i.underlyingWindow.setFrameColor(t,(function(){--o<=0&&e(n)}))})),setTimeout((function(){o>0&&i(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)})),e)},n.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},n}(fe),Ee=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}(),Re=function(){function t(e){this._name=e,ve(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){ve(this._glueLogger)?t.Level===Ee.Trace&&console.info(this._getMessage(e,Ee.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){ve(this._glueLogger)?t.Level!==Ee.Debug&&t.Level!==Ee.Trace||console.info(this._getMessage(e,Ee.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){ve(this._glueLogger)?t.Level!==Ee.Debug&&t.Level!==Ee.Trace&&t.Level!==Ee.Info||console.info(this._getMessage(e,Ee.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){ve(this._glueLogger)?t.Level!==Ee.Debug&&t.Level!==Ee.Trace&&t.Level!==Ee.Info&&t.Level!==Ee.Warn||console.info(this._getMessage(e,Ee.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){ve(this._glueLogger)?(console.error(this._getMessage(t,Ee.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=Ee.Info,t}(),We=function(t){function n(e,n,i,o,r,s,a,c){var u=t.call(this,e)||this;return u._logger=Re.Get("window"),u._type=i,u._activityId=o,u._name=n,u._instance=r,u._isIndependent=s,u._windowGetter=a,u._hcWindowId=c,u}return e(n,t),n.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"activity",{get:function(){if(!ye(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isOwner",{get:function(){var t=this.activity;return!ye(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),n.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},n.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},n.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},n.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(n.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),n.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(Te.ActivityWindowJoinedActivity,t)},n.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(Te.ActivityWindowLeftActivity,t)},n.prototype._updateCore=function(t){var e=this;we(t._activityId,(function(t){return e._activityId=t})),we(t._isIndependent,(function(t){return e._isIndependent=t})),we(t._hcWindowId,(function(t){return e._hcWindowId=t})),we(t._type,(function(t){return e._type=t})),we(t._name,(function(t){return e._name=t})),ve(t._instance)||(this._instance=t._instance)},n.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(i,o,r){o.id===n.id&&r===t&&e(i)}))},n.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},n}(fe),Fe=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}(),Ne="error",Le="add-types",De="created",Ge="destroyed",He="initiated",Be="joined",qe="activity-joined",Ue="left",Ve="owner-changed",ze="add-peer-factories",Je="peer-factories-added",Ke="peer-factories-removed",Ze="peer-created",Ye=function(){function t(t){var e=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=t,this._connection=t.connection,this._logger=t.logger,this._contexts=t.contexts,this._windows=t.windows,this._sessionJoinedPromise=new Promise((function(t){e._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){e._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=this._connection.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var n=window.glue42gd;n&&"function"==typeof n.addRefreshHandler&&n.addRefreshHandler((function(t,i){e._gw3Session.send({type:"reload"}).then((function(e){if(e.token){try{n.setGWToken(e.token)}catch(t){return void i(t.message||t)}t()}else i("Expected gateway token for refreshing.")}),i)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new _e(t,void 0)};return new be(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new _e(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new Oe(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new Ie(t,new Ce(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe(De,this.handleActivityCreatedMessage),this.subscribe(Ge,this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe(Je,this.handlePeerFactoriesAdded),this.subscribe(Ke,this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if(t._windows&&void 0!==t._windows.my())return void t._windows.my().close();if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,i,o,r){var s=this,a={};a.name=e;var c=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=c(n),a.helper_types=i.map(c),this._gw3Session.send({type:Le,types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,r);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new Ie(e,new Ae(Te.Added)),Le),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new be(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new Ie(n,new Ae(Te.Removed)),Le)}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,i){var o=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var r={id:e,peer_type:e,configuration:i};return this._gw3Session.send({type:ze,factories:[r]}).then((function(){o.invokeCallbacks(o._windowTypeStatusChangeCallbacks,new Ie(t.peerFactoryGwMessageEntityToWindowType(r),new Ae(Te.Added)),ze)})).catch((function(){delete o._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new Ie(new _e(t,void 0),new Ae(Te.Removed)),ze)}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var i=this,o={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?o.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:o.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(o,He,(function(t,e){return t.request_id===e}),De,(function(t,e,n){return t.activity_id===n.activity_id}),Ge,(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id})).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==i._config.mode||i._activityTypesInitiatedFromMe[t]?e:(i._activityTypesInitiatedFromMe[t]=!0,i._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,i){if(n)return this._contexts.set(t.id,e);for(var o=0,r=i=i||[];o<r.length;o++){e[r[o]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var i=void 0!==this._connection.gatewayToken,o=this._connection.peerId;if("undefined"!=typeof window){var r=window.glue42gd;r&&(i=void 0!==r.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new Ie(new We(o,e,t,void 0,this.getAgmInstance(o),n,this.generateWindowGetter(o),void 0),new Ae(Te.Added)),"register window"),Promise.resolve(o)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;return e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1}),this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,Ze,(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id})).then((function(i){if(t)return n.joinActivity(t,i,e.name).then((function(){return i}))}))},t.prototype.closeWindow=function(t){return this._gw3Session.send({type:"destroy-peer",destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var o=new URLSearchParams(location.search.slice(1));e=(e=e||o.get("t42PeerType"))||o.get("t42ActivityWindowType"),void 0===n&&(n=o.get("t42ActivityWindowIndependent")),i=i||o.get("t42ActivityWindowName"),t=t||o.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:i=i||this._connection.peerId}},t.prototype.joinActivity=function(t,e,i){var o=this,r=i&&{name:i}||{};return this._gw3Session.send(n({type:"join-activity",target_id:e,activity_id:t},r)).then((function(){o.invokeCallbacks(o._activityWindowChangeCallbacks,new Ie(new We(e,void 0,void 0,t,o.getAgmInstance(e),void 0,o.generateWindowGetter(e),void 0),new Ae(Te.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),o.invokeCallbacks(o._activityChangeCallbacks,new Ie(new Oe(t,void 0,new Fe("created",void 0,void 0),void 0,void 0),new Ae(Te.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new Ie(new We(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new Ae(Te.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new Ie(new Oe(t,void 0,new Fe("created",void 0,void 0),void 0,void 0),new Ae(Te.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,i){var o=function(t){return function(e){return new Ie(e,new Ae(t?Te.Added:Te.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),o(!0),i),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),o(!1),i)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,i){return this.subscribe(t,(function(t){e(t).forEach((function(e){return i.forEach((function(i){return i(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,i,o,r,s,a){var c,u,d,p,h,f,l=this,g=this.getRandomRequestId(),y=new Promise((function(t,e){c=t,u=e})),v=null,m=function(){l.dropSubscription(d),l.dropSubscription(p),l.dropSubscription(h),l.dropSubscription(f)};d=e&&this.subscribe(e,(function(t){n(t,g)&&(v=t,l.dropSubscription(d))})),p=this.subscribe(i,(function(t){o(t,g,v)&&c(a(t))})),h=r&&this.subscribe(r,(function(t){s(t,g,v)&&u(t)})),f=r&&this.subscribe(Ne,(function(t){t.request_id===g&&u(t)})),t.request_id=g;var w=this._gw3Session.send(t).then((function(){return y}));return w.then(m,m),w},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new _e(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,i=this._connection.on(t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(i),i},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var i=this;t.forEach((function(t){try{t(e)}catch(t){i._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return i(this,void 0,void 0,(function(){var e,n,i,r=this;return o(this,(function(o){switch(o.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,i=e,[4,this._contexts.subscribe(e,(function(t,n,i){var o=new Ie(new Oe(e,void 0,void 0,t,void 0),new Se(t,n,i));r.invokeCallbacks(r._activityChangeCallbacks,o,"context updated")}))];case 1:return n[i]=o.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new be(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,i=[De,Be,Ve];e<i.length;e++){var o=i[e];this.forwardMessageToEventHandler(o,(function(e){return[e.owner||n(n({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new We(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new Ie(t,new Ae(Te.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=[De,Be];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[t.activityGwMessageToActivity(e,new Fe("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler(Ge,(function(e){return[t.activityGwMessageToActivity(e,new Fe("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(He,(function(e){return[t.activityGwMessageToActivity(e,new Fe("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(Ve,(function(e){return[t.activityGwMessageToActivity(e,new Fe("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler(Je,Ke,(function(n,i){return i?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var i=e.configuration||{};i.gateway_token=i.gateway_token||e.gateway_token,i.peer_factory=i.peer_factory||e.peer_factory;var o=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:i.gateway_token,configuration:i});o&&o.then&&o.catch&&o.catch((function(n){return t._gw3Session.send({type:Ne,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:Ne,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:Ne,request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var i=e===qe?n.joined_id:n.peer_id,o=e===qe?n.joined_type:n.peer_type,r=e===qe?n.joined_name:n.peer_name,s=new We(i,r,o,n.activity_id,t.getAgmInstance(i),void 0,t.generateWindowGetter(i),void 0);t._contextSubscriptions[n.activity_id]?e===Be&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){e===Be&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new Ie(s,new Ae(Te.ActivityWindowJoinedActivity)),e)}))},n=this,i=0,o=[qe,Be];i<o.length;i++){e(o[i])}this.subscribe(Ue,(function(e){var n=new We(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new Ie(n,new Ae(Te.ActivityWindowLeftActivity)),Ue)})),this.forwardAddedAndRemovedMessagesToEventHandler(Ze,void 0,(function(e){return[new We(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var i=n.windowId;return e._config.windows.list().filter((function(t){return t.id===i}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}(),Xe=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=Re.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(ve(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!ve(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return ye(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return ye(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return ye(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;ve(e)||ve(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!ve(e)){var n=e.activity;ve(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,i){var o=this.window;if(!ve(o)){var r=o.activity;ve(r)||t.id===r.id&&this._notifyMyContextChanged(t,e,n,i)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){ve(this.window)||this.window.id===e.id&&(n===Te.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===Te.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,i){var o=this;n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((function(r){try{r(e,n,i,t)}catch(t){o._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var i=this;this._myDetachedFrom.forEach((function(o){try{o(t,e,n)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!ve(n)){var i=n.activity;ve(i)||t.id===i.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var i=this.window;if(!ve(i)){var o=i.activity;ve(o)||(e.id===o.id&&this._notifyDetached(n),t.id===o.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}(),Qe=function(){function t(t,e){if(this._logger=Re.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!ye(this._error)},t.prototype.getError=function(){return this._error},t}(),$e=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new Ie(t,new Ae(Te.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,i=t.entity;if(n===Te.StatusChange&&!e.oldStatus){var o=this._items[i.id];o&&(e.oldStatus=o.status)}n===Te.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=Te.Updated),"undefined"==typeof htmlContainer&&(n===Te.ActivityWindowJoinedActivity&&this._items[i.id]&&this._items[i.id].activity&&(e.type=Te.Updated),n===Te.ActivityWindowLeftActivity&&this._items[i.id]&&!this._items[i.id].activity&&(e.type=Te.Updated));var r=this._updateInternalCollections(i,n,e);return this._notifyListeners(r,e),r},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var i=function(o){o.id===t&&(n(o),e.unsubscribe(i))};e.subscribe(i);var o=e.getByName(t);if(o)return e.unsubscribe(i),void n(o)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var i=e._items[n];t(i,new Ae(Te.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var i=t,o=e===Te.StatusChange&&i.status&&i.status.state===ke.Destroyed||e===Te.StatusChange&&n&&n.newStatus&&n.newStatus.state===ke.Destroyed,r=e===Te.Closed;if(e===Te.Removed&&void 0===i.isIndependent||r||o){var s=this._items[t.id];return delete this._items[t.id],this._processNew(t),s&&t._beforeDelete(s),t}var a=t.id;return this._items.hasOwnProperty(a)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}(),tn=function(){function t(t,e,n){var i=this;this._logger=Re.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new $e((function(t){return i._grabEntity(t)})),this._windowTypes=new $e((function(t){return i._grabEntity(t)})),this._activities=new $e((function(t){return i._grabEntity(t)})),this._windows=new $e((function(t){return i._grabEntity(t)})),this._dataReadyMarker=new Qe("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new Qe("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new Qe("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._descriptorsMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._logger.debug("Auto announcing window"),i.announceWindow().then((function(t){i._announcedWindows.push(t),i._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){i._logger.debug("Will not announce window - "+t),i._readyMarker.signal()}))})),i.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){i._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){i._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){i._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){i._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(i){i?n(e._readyMarker.getError()):t(e)}))}));return je(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,i,o,r){var s=this;return je(new Promise((function(r,a){var c;if(ve(t))a("activityTypeName argument can not be undefined");else if(le(t))if(ve(s.getActivityType(t)))if(ye(e))a("Owner window type can not be undefined");else{c=le(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var u=[];if(!ye(n)&&ge(n))for(var d in n){var p=n[d];if(le(p)){var h={type:p,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};u.push(h)}else u.push(p)}s._bridge.registerActivityType(t,c,u,i,o).then((function(t){s._grabEntity(t),r(t)})).catch((function(t){a(t)}))}else a("Activity type '"+t+"' already exists");else a("activityTypeName should be string")})),r)},t.prototype.unregisterActivityType=function(t,e){var n=this;return je(new Promise((function(e,i){var o=n.getActivityType(t);ye(o)?i("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(o)}),i)})),e)},t.prototype.initiate=function(t,e,n,i){var o=this;return je(new Promise((function(n,r){ye(o.getActivityType(t))?r("Activity type '"+t+"' does not exists"):o._bridge.initiateActivity(t,e,i).then((function(t){o._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return r(t)}))})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var i=this;return je(new Promise((function(n,o){if(ve(t))o("no windowType specified");else{if("object"==typeof(r=t)&&null!==r)t=t.getName();else if(!le(t))return void o("windowType should be string or object that has getName method");var r;i._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){o(t)}))}})),n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this;return je(new Promise((function(e,i){ve(t)?i("no windowType specified"):le(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){i(t)})):i("windowType should be a string")})),e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(le(t))n=[t];else if(t instanceof be)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1}(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(i,o){var r=n._bridge.getAnnouncementInfo();if(ye(t)&&(t=r.activityWindowId),ye(e)&&(e=r.activityWindowType),ve(e))throw new Error("Can not announce - unknown windowType");var s=r&&r.activityId;if(ve(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+r.activityWindowName+"', ind.:'"+r.activityWindowIndependent+"'"),n._bridge.registerWindow(e,r.activityWindowName,r.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return s?n._activities.getOrWait(s).then((function(e){return t})):t})).then((function(t){i(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var a=n._windows.getByName(t);if(!ve(a))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void i(a);var c=function(e,r,s){t===r.id&&(s===Te.ActivityWindowJoinedActivity&&(ye(r.activity)&&o("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),i(r),n.unsubscribeWindowEvents(c)))};n.subscribeWindowEvents(c),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,i){if(i.type===Te.StatusChange){var o=i;t(n,o.newStatus,o.oldStatus)}if(i.type===Te.Removed||i.type===Te.StatusChange&&i.newStatus.getState()===ke.Destroyed)for(var r=0,s=e._windows.get();r<s.length;r++){var a=s[r];a.activity&&a.activity.id===n.id&&e._windows.process(new Ie(a,new Ae(Te.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var i=n.type;i===Te.Added&&(i="opened"),t(e.activity,e,i)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var i=this;return je(new Promise((function(n,o){var r,s;if(ve(e)&&o("windowType is undefined"),le(e))r={type:e,name:"",isIndependent:!1,arguments:{}};else if(e instanceof _e)r={type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1};else{var a=["url"],c={};Object.keys(e).forEach((function(t){-1===a.indexOf(t)&&(c[t]=e[t])})),r=c}if(!ve(r.relativeTo))if("string"==typeof(s=r.relativeTo))!ve(u=i.getWindows({type:s}))&&u.length>0&&(r.relativeTo=u[0].id);else if(ve(s.type))ve(s.windowId)||(r.relativeTo=s.windowId);else{var u;!ve(u=i.getWindows({type:s.type}))&&u.length>0&&(r.relativeTo=u[0].id)}i._bridge.createWindow(t&&t.id,r).then((function(e){i._logger.debug("Window created, waiting for window entity with id "+e);var o=function(r,s){r.id!==e||t&&!r.activity||(i._logger.debug("Got entity window with id "+e),n(r),i._windows.unsubscribe(o))};i._windows.subscribe(o)})).catch((function(t){o(t)}))})),n)},t.prototype.createStackedWindows=function(t,e,n,i){var o=this;return je(new Promise((function(i,r){ve(t)&&r("activity is undefined"),ve(e)&&r("relativeWindowTypes is undefined"),Array.isArray(e)||r("relativeWindowTypes has to be an array"),ve(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,i;if((e=le(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t).stackedWindow=!0,e.timeout=n,!ve(e.relativeTo))if(ve((i=e.relativeTo).type)){if(!ve(i.windowId)){var r=o.getWindows({id:i.windowId});!ve(r)&&r.length>0&&(e.relativeTo=r[0].type.name)}}else e.relativeTo=i.type;s.push(e)}));var a=[];s.forEach((function(e){return a.push(o.createWindow(t,e))})),Promise.all(a).then(i).catch(r)})),i)},t.prototype.addWindowToActivity=function(t,e,n){var i=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return je(i,n),i},t.prototype.leaveWindowFromActivity=function(t,e,n){var i=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return je(i,n),i},t.prototype.setActivityContext=function(t,e,n){var i=this;return je(new Promise((function(n,o){ve(t)&&o("activity can not be null"),i._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){o(t)}))})),n)},t.prototype.updateActivityContext=function(t,e,n){var i=this;return je(new Promise((function(n,o){ve(t)&&o("activity can not be null");var r=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&r.push(s);for(var a=0,c=r;a<c.length;a++){var u=c[a];delete e[u]}i._bridge.updateActivityContext(t,e,!1,r).then((function(e){n(t)})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===Te.ActivityContextChange){var i=n;t(e,i.context,i.updated,i.removed)}}))},t.prototype.stopActivity=function(t,e){return je(this._bridge.stopActivity(t),e)},t.prototype.getWindows=function(t){return ye(t)?this._windows.get():ye(t.id)?this._windows.get().filter((function(e){if(!ye(t.type)&&e.type.id!==t.type)return!1;if(!ye(t.name)&&e.name!==t.name)return!1;if(!ye(t.activityId)){if(ve(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var i=this;return je(new Promise((function(n,o){i._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return o(t)}))})),n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var i=this;return je(new Promise((function(n,o){t||o("activity can not be null"),i._bridge.cloneActivity(t.id,e).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){return o(t)}))})),n)},t.prototype.attachActivities=function(t,e,n,i){var o=this;return n=n||{},je(new Promise((function(i,r){if(o._activities.getByName(t)){if(o._activities.getByName(e))return o._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,r=t.descriptors;o._activities.getOrWait(e).then((function(t){t._updateDescriptors(r);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];i(e)}))})).catch((function(t){r(t)}));r("can not find activity with id "+e)}else r("can not find activity with id "+t)})),i)},t.prototype.detachActivities=function(t,e,n){var i=this;return je(new Promise((function(n,o){return i._bridge.detachActivities(t,e).then((function(){i._activities.getOrWait(undefined).then((function(t){t._updateDescriptors(undefined),i._activities.getOrWait(undefined).then((function(t){n(t)}))})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)})),this._bridge.onActivityStatusChange((function(e){t._activities.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,i=t.descriptor,o=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(o);var n=t.attached.filter((function(t){return t.ownerId===i.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,i=t.newActivityId,o=t.descriptors,r=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(o),e._activities.getOrWait(i).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,r)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,i=this._activities.getByName(e);i&&i._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var i=n,o=e[n],r=t._activities.getByName(i);r&&r._updateDescriptors(o)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}(),en=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return ye(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return ye(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}(),nn=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new en(t,e)}return t.prototype.ready=function(t){var e=this;return je(new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))})),t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new xe(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){return[]},t}(),on=function(){function t(e){var n,i=this;if(!e)throw new Error("config can not be null");if(ye(e.logLevel)||(Re.Level=e.logLevel),ve(e.logger)||(Re.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(!(n=new Ye(e)))throw new Error("A bridge to native activity is needed to create activity lib.");xe.AGM=e.agm;var o=new tn(n,!e.disableAutoAnnounce,e.windows),r=new Xe(o,e.windows);this._api=new nn(o,r),this._readyPromise=o.ready().then((function(t){return i}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return je(this._readyPromise,t)},t}(),rn="T42.ACS.GetFunctionalEntitlement",sn="T42.ACS.CanI",an="T42.ACS.OnEvent";function cn(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var o=n instanceof Error?n:new Error(n);if(e)e(o);else{var r='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(r);case"silent":return;case"throw":throw new Error(r)}console.error(r)}}return{add:function(t,e,o){var r=n[t];return r||(r=[],n[t]=r),r.push(e),o&&setTimeout((function(){o.forEach((function(o){var r;if(null===(r=n[t])||void 0===r?void 0:r.includes(e))try{Array.isArray(o)?e.apply(void 0,o):e.apply(void 0,[o])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var r=n[t];if(!r||0===r.length)return[];var s=[];return r.forEach((function(n){try{var o=n.apply(void 0,e);s.push(o)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}cn.default=cn;var un=cn;function dn(t){return t?Object.keys(t).map((function(e){return t[e]})):[]}function pn(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}var hn=function(){function t(t,e,n){var i=this;this._appManager=t,this._name=e,this._agm=n,this._registry=un(),t.onInstanceStarted((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===i._name&&i._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===i._name&&i._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===i._name&&i._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===i._name&&i._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?pn(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?pn(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e='mode:"',n=(t=t.split(" ").join("")).indexOf(e);if(-1!==n){var i=n+e.length,o=t.indexOf('"',i),r=t.substr(i,o-i);if(r&&"string"==typeof r)return r.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,i=this._name;return new Promise((function(o,r){e=e||{},t=t||{};n._agm.invoke("T42.ACS.StartApplication",{Name:i,Context:t,Options:e},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;if(e&&e.Id)if("startOnly"===n._appManager.mode){var i=n._appManager.handleInstanceStarted(e);o(i)}else!function(t){var e,i=function(){var e,i=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===i.length?i[0].isActivityInstance?i[0]:i[1]:i[0])?e.agm?e:void 0:e},s=setTimeout((function(){e&&e(),r("timeout")}),1e4);e=n._appManager.onInstanceAgmServerReady((function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(s),setTimeout((function(){o(i())}),1))}));var a=i();a&&(e&&(e(),e=void 0),clearTimeout(s),o(a))}(e.Id);else o(void 0)}),(function(t){r(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}(),fn=function(){function t(t,e,n,i,o,r,s){var a=this;this._id=t,this._appName=e,this._appManager=n,this._agm=i,this._activities=o,this._windows=r,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=un(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===a._id&&a._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===a._id&&a._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityOwner",{get:function(){return this._isActivityOwner},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return"activity"!==e.application.type&&e.activityId&&e.activityId===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){if(this._activityId)return this.activityInstances.filter((function(t){var e;return null===(e=t)||void 0===e?void 0:e.isActivityOwner}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){var t,e,n;return null!=(n=null!=(t=this._startUpContext)?t:null===(e=this.window)||void 0===e?void 0:e.context)?n:{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),this._isActivityOwner=t.IsActivityOwner,!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,i=Object.keys(n)[0];if(!i)return;var o=n[i];this._agmInstance={machine:o.machineName,user:o.userName,environment:o.environment,application:o.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var i=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(i(),e())}));t._agm.invoke("T42.ACS.StopApplication",{Name:t._appName,Id:t._id}).then((function(){"startOnly"===t._appManager.mode&&(t._appManager.handleInstanceStopped({Name:t._appName,Id:t.id,Context:void 0,Title:void 0,ActivityId:void 0,IsActivityOwner:void 0,AgmServers:void 0}),e())})).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype.getContext=function(){return Promise.resolve(this.context)},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}(),ln=function(){function t(t,e,n,i,o,r){var s=this;this.mode=t,this._agm=e,this._activities=n,this._windows=i,this._logger=o,this._gdMajorVersion=r,this._apps={},this._instances=[],this._registry=un(),this.application=function(t){return s._apps[t]},this.applications=function(){return Object.keys(s._apps).map((function(t){return s._apps[t]}))},this.instances=function(){return s._instances},this.getMyInstance=function(){if(s._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return s._instances.filter((function(e){return e.id===t}))[0]}},this.handleAppAdded=function(t){var e=s._getAppId(t);s._logger.trace("adding app "+e),s._apps[e]=new hn(s,e,s._agm);var n=s._updateAppFromProps(t);s._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=s._updateAppFromProps(t);s._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=s._getAppId(t);s._logger.trace("removing app "+e);var n=s.application(e);s._instances=s._instances.filter((function(t){return t.application.name!==n.name})),delete s._apps[e],s._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=s._getAppId(t),n=s._getAppOrThrow(e);n.updateFromProps(t),n.available?s._registry.execute("appAvailable",n):s._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){s._logger.trace("started app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new fn(e,n,s,s._agm,s._activities,s._windows);return s._updateInstanceFromProps(i,t),s._instances.push(i),s._registry.execute("instanceStarted",i),i},this.handleInstanceStopped=function(t){s._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._instances=s._instances.filter((function(t){return!s._matchInstance(t,e,n)})),s._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);i.updateAgmInstanceFromProps(t),s._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new fn(e,n,void 0,void 0,void 0,void 0,!0);s._updateInstanceFromProps(i,t),s._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._updateInstanceFromProps(i,t)},this.onInstanceStarted=function(t){return s._registry.add("instanceStarted",t,s._instances)},this.onInstanceStartFailed=function(t){return s._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return s._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return s._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return s._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return s._registry.add("appAdded",t,Object.values(s._apps))},this.onAppRemoved=function(t){return s._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return s._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return s._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return s._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(i){return n._matchInstance(i,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t}();function gn(t,e,n){var i=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!i(e)&&!i(n))return t;i(e)?i(n)||(n=function(){}):e=function(){},t.then(e,n)}var yn=function(){function t(t){var e=this;this._agm=t,this._registry=un(),this._isMethodRegistered=!1,this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return gn(e._agmInvoke("T42.ACS.GetConfigurationRegion",(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return gn(e._agmInvoke("T42.ACS.GetBranches",(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return gn(e._agmInvoke("T42.ACS.GetCurrentBranch",(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,i){return gn(e._agmInvoke("T42.ACS.SetConfigurationRegion",(function(t){return t.returned.ResultMessage}),{Region:t}),n,i)},this.setCurrentBranch=function(t,n,i){return gn(e._agmInvoke("T42.ACS.SetCurrentBranch",(function(t){return t.returned.ResultMessage}),{Branch:t}),n,i)},this.currentUser=function(t,n){return gn(e._agmInvoke("T42.ACS.GetUser"),t,n)},this.getFunctionalEntitlement=function(t,n,i){return gn(e._agmInvoke(rn,(function(t){return t.returned.Entitlement}),{Function:t}),n,i)},this.getFunctionalEntitlementBranch=function(t,n,i,o){return gn(e._agmInvoke(rn,(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),i,o)},this.canI=function(t,n,i){return gn(e._agmInvoke(sn,(function(t){return t.returned.Result}),{Function:t}),n,i)},this.canIBranch=function(t,n,i,o){return gn(e._agmInvoke(sn,(function(t){return t.returned.Result}),{Function:t,Branch:n}),i,o)},this.onBranchesChanged=function(t){return e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){return e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke("T42.ACS.Shutdown",null,t)},this.onShuttingDown=function(t){return e.registerMethod(),e._registry.add("onShuttingDown",t)},this.restart=function(t){return e._agmInvoke("T42.ACS.Restart",null,t)},this._agmInvoke=function(t,n,i){return i=i||{},new Promise((function(o,r){e._agm.invoke(t,i).then((function(t){n||(n=function(t){return t.returned}),o(n(t))})).catch((function(t){return r(t)}))}))}}return t.prototype.registerMethod=function(){var t=this;this._isMethodRegistered||(this._agm.register("T42.ACS.OnGDShutdown",(function(e){return i(t,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,Promise.all(this._registry.execute("onShuttingDown",e))];case 1:return t.sent(),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))})),this._isMethodRegistered=!0)},t}();var vn="T42.ACS.InMemoryStoreCommand",mn=function(){function t(t){this.interop=t}return t.prototype.import=function(t,e){if(!t||!Array.isArray(t))return Promise.reject("invalid apps argument - should be an array of application definitions");if(e&&"replace"!==e&&"merge"!==e)return Promise.reject("invalid mode argument - should be 'replace' or 'merge'");var n={command:"import",args:{apps:t,mode:e=null!=e?e:"replace"}};return this.interop.invoke(vn,n).then((function(t){return t.returned}))},t.prototype.export=function(){return this.interop.invoke(vn,{command:"export"}).then((function(t){return t.returned.apps}))},t.prototype.remove=function(t){if(!t||"string"!=typeof t)return Promise.reject("invalid app name, should be a string value");var e={command:"remove",args:{apps:[t]}};return this.interop.invoke(vn,e).then((function(t){return t.returned}))},t.prototype.clear=function(){return this.interop.invoke(vn,{command:"clear"}).then((function(t){return t.returned}))},t.prototype.createAppDef=function(t,e){return e||(e="https://google.com"),{name:t,type:"window",title:t,details:{url:e}}},t}(),wn=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e="startOnly",n="skipIcons",i=t.mode||e;if(i!==e&&i!==n&&"full"!==i)throw new Error("Invalid mode for appManager lib - "+i+" is not supported");var o,r=t.activities,s=t.agm,a=t.logger,c=t.windows,u=new ln(i,s,r,c,a.subLogger("applications"),t.gdMajorVersion),d=new yn(s);if(i===e)o=function(t,e){return new Promise((function(n,i){t.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((function(t){var i=t.returned;i||n();var o=i.applications;o||n(),dn(o).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return i("Error getting application snapshot: "+t.message)}))}))}(s,u);else{var p=function(t,e,n,i){var o;return{start:function(){var r,s,a=new Promise((function(t,e){r=t,s=e}));return t.subscribe(an,{arguments:{skipIcon:i},waitTimeoutMs:1e4}).then((function(t){(o=t).onData((function(t){var i=t.data;dn(i.OnApplicationAdded).map((function(t){return e.handleAppAdded(t)})),dn(i.OnApplicationChanged).map((function(t){return e.handleAppUpdated(t)})),dn(i.OnApplicationRemoved).map((function(t){return e.handleAppRemoved(t)})),dn(i.OnApplicationReady).map((function(t){return e.handleAppReady(t)})),dn(i.OnApplicationStarted).map((function(t){return e.handleInstanceStarted(t)})),dn(i.OnApplicationStartFailed).map((function(t){return e.handleInstanceStartFailed(t)})),dn(i.OnApplicationStopped).map((function(t){return e.handleInstanceStopped(t)})),dn(i.OnApplicationUpdated).map((function(t){return e.handleInstanceUpdated(t)})),dn(i.OnApplicationAgmServerReady).map((function(t){return e.handleInstanceAgmServerReady(t)})),dn(i.OnBranchChanged).map((function(t){return n.handleBranchModified(t)})),dn(i.OnBranchesModified).map((function(t){return n.handleBranchesModified(t)})),r()})),o.onFailed((function(t){return s(t)}))})).catch((function(t){return s("Error subscribing for T42.ACS.OnEvent stream. Err: "+t)})),a},stop:function(){o&&o.close()}}}(s,u,d,i===n);o=p.start()}return{ready:function(){return o},applications:u.applications,application:u.application,onAppAdded:u.onAppAdded,onAppRemoved:u.onAppRemoved,onAppChanged:u.onAppChanged,onAppAvailable:u.onAppAvailable,onAppUnavailable:u.onAppUnavailable,instances:u.instances,get myInstance(){return u.getMyInstance()},onInstanceStarted:u.onInstanceStarted,onInstanceStopped:u.onInstanceStopped,onInstanceUpdated:u.onInstanceUpdated,onInstanceStartFailed:u.onInstanceStartFailed,getRegion:d.getRegion,getBranches:d.getBranches,getCurrentBranch:d.getCurrentBranch,getFunctionalEntitlement:d.getFunctionalEntitlement,getFunctionalEntitlementBranch:d.getFunctionalEntitlementBranch,setCurrentBranch:d.setCurrentBranch,setRegion:d.setRegion,currentUser:d.currentUser,canI:d.canI,canIBranch:d.canIBranch,onBranchesChanged:d.onBranchesChanged,exit:d.exit,restart:d.restart,onShuttingDown:d.onShuttingDown,inMemory:new mn(s)}},bn=new(function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=un()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,i){var o,r=setTimeout((function(){o(),i("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(r),n(s)):o=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(r),o(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}()),_n=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.callbackifyPromise=function(t,e,n){var i=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return i(t)}))}catch(t){return i(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var i=e.left,o=e.top,r=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:i,top:o,width:r,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,e.left+(e.workingAreaWidth-t.width)/2));return{top:Math.floor(Math.max(e.top,e.top+(e.workingAreaHeight-t.height)/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,i=t.top,o=n+t.width,r=i+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(o,c)-Math.max(n,s))*Math.max(0,Math.min(r,u)-Math.max(i,a))},t}(),In=function(t,e,n,r,s,a,c,u){var d,p,h=null!=u?u:un(),f=r.subLogger("window "+t),l=e.name,g=e.mode,y=e.url,v=e.title,m=e.context||{},w=e.bounds,b=e.frameColor,_=e.focus,I=e.neighbours||{},A=e.groupId,C=e.isGroupHeaderVisible,S=e.isTabHeaderVisible,T=e.isTabSelected,k=e.settings,x=e.isVisible,P=e.isSticky,M=e.isCollapsed,j=e.state,O=e.tabGroupId,E=e.isLocked,R=[],W=e.zoomFactor,F=e.placementSettings;function N(t,e,i){return new Promise((function(o,r){var s,a,c=ut(t,w),u=!1,d=function(){u||(u=!0,"function"==typeof e&&e(p),o(p),a&&(a(),a=void 0),s&&(clearTimeout(s),s=void 0))};c||(a=et((function(e){ut(t,e.bounds)&&d()}))),n.moveResize(p,t).then((function(){c?d():s=setTimeout((function(){d()}),1e3)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))}function L(t,e,i){return new Promise((function(o,r){if(t===x)return"function"==typeof e&&e(p),o(p);var s=Q((function(t){"function"==typeof e&&e(p),s(),o(p)}));n.setVisible(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))}function D(t,e,i){return new Promise((function(o,r){var s=$((function(){s(),"function"==typeof e&&e(p),o(p)}));n.updateContext(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))}function G(){return new Promise((function(t){var e=tt((function(n){n.id===p.id&&(e(),t())}))}))}function H(t){return t(p.title,p),h.add("onTitleChanged",t)}function B(t){return h.add("onClose",t)}function q(t){return h.add("onUrlChanged",t)}function U(t){return h.add("onFrameButtonAdded",t)}function V(t){return h.add("onFrameButtonRemoved",t)}function z(t){return M&&t(p),h.add("collapsed",t)}function J(t){return M||t(p),h.add("expanded",t)}function K(t){return"maximized"===j&&t(p),h.add("maximized",t)}function Z(t){return"minimized"===j&&t(p),h.add("minimized",t)}function Y(t){return"normal"===j&&t(p),h.add("normal",t)}function X(t){return h.add("detached",t)}function Q(t){return h.add("visibility-changed",t)}function $(t){return h.add("context-updated",t)}function tt(t){return h.add("lock-changed",t)}function et(t){return h.add("bounds-changed",t)}function nt(t){return h.add("focus-changed",t)}function it(t){return h.add("frame-color-changed",t)}function ot(t){return h.add("tab-header-visibility-changed",t)}function rt(t){return h.add("group-changed",t)}function st(t){var e=I[t];if(void 0!==e)return e.reduce((function(t,e){var n=bn.get(e);return n&&t.push(n.API),t}),[])}function at(){if(m._APPLICATION_NAME)return m._APPLICATION_NAME;if(m&&m._t42&&m._t42.application)return m._t42.application;var t=ct();return t?t.applicationName:void 0}function ct(){if("undefined"!=typeof window&&window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}function ut(t,e){var n=t.height,i=t.width;t.height<k.minHeight&&(n=k.minHeight),t.height>k.maxHeight&&(n=k.maxHeight),t.width<k.minWidth&&(i=k.minWidth),t.width>k.maxWidth&&(i=k.maxWidth);var o=!n||e.height===n,r=!i||e.width===i,s=!t.left||e.left===t.left,a=!t.top||e.top===t.top;return o&&r&&s&&a}var dt={handleWindowClose:function(){void 0!==p.id&&(h.execute("onClose",p),p.id=void 0)},handleWindowChangeState:function(t){"collapsed"===t?M=!0:"expanded"===t?M=!1:j=t,h.execute(t,p)},handleTitleChanged:function(t){v=t,h.execute("onTitleChanged",t,p)},handleVisibilityChanged:function(t){t!==x&&(x=t,h.execute("visibility-changed",p))},handleUrlChanged:function(t){y=t,h.execute("onUrlChanged",t,p)},handleWindowSettingsChanged:function(t){k=t,h.execute("settings-changed",p)},handleContextUpdated:function(t){m=t,h.execute("context-updated",m,p)},handleFrameIsLockedChanged:function(t){E=t,h.execute("lock-changed",p)},handleBoundsChanged:function(t){w.top===t.top&&w.left===t.left&&w.width===t.width&&w.height===t.height||(w.top=t.top,w.left=t.left,w.width=t.width,w.height=t.height,h.execute("bounds-changed",p))},handleFocusChanged:function(t){_=t,h.execute("focus-changed",p)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===R.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&R.push(e),h.execute("onFrameButtonAdded",e,p)},handleFrameButtonRemoved:function(t){var e;R=R.reduce((function(n,i){return i.buttonId===t?e=i:n.push(i),n}),[]),void 0!==e&&h.execute("onFrameButtonRemoved",e,p)},handleFrameButtonClicked:function(t){var e=R.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&h.execute("onFrameButtonClicked",e[0],p)},handleFrameColorChanged:function(t){b=t,h.execute("frame-color-changed",p)},handleFrameAttached:function(t,e){O=t,S=e,h.execute("frame-attached",p)},handleFrameSelectionChanged:function(e,n){var i;void 0!==e&&e===t?(T=!0,i=p):(T=!1,i=bn.get(e)?bn.get(e).API:void 0);var o=bn.get(n)?bn.get(n).API:void 0;if(T&&o)var r=o.onTabSelectionChanged((function(t,e){(e&&e.id)===o.id&&(r(),h.execute("tab-selection-changed",i,o,p))}));else h.execute("tab-selection-changed",i,o,p)},handleCompositionChanged:function(t,e){I=t||{},h.execute("neighbours-changed",t,p),A=e,p.groupId!==e&&h.execute("group-changed",p)},handleGroupHeaderVisibilityChanged:function(t){C=t},handleTabHeaderVisibilityChanged:function(t){S!==t&&(S=t,h.execute("tab-header-visibility-changed",p))},handleGroupChanged:function(e,n){f.trace("handle group changed to win: "+t+" with group id: "+e.id),d=e,A=e.id,h.execute("group-changed",p,e,n)},handleGroupAssociation:function(e){e&&f.trace("setting group to win: "+t+" with group id: "+e.id),d=e},handleAttached:function(t,e){O=t,S=e,h.execute("attached",p)},handleDetached:function(e){O=e;var n=h.add("frame-attached",(function(e){e.id===t&&(n(),h.execute("detached",p))}))},handleWindowAttached:function(t){h.execute("window-attached",t)},handleWindowDetached:function(t){h.execute("window-detached",t)},handleZoomFactorChanged:function(t){W=t,h.execute("zoom-factor-changed",p)},handleIsStickyChanged:function(t){P=t,h.execute("sticky-changed",t,p)},handlePlacementSettingsChanged:function(t){var e,n=t;if(n.display){var i=a();if(i){var o=n.display-1;e=new Promise((function(t,e){i.all().then((function(e){var n=e.find((function(t){return t.index===o}));t(n)})).catch(e)}))}else e=Promise.resolve(void 0)}else e=Promise.resolve(void 0);e.then((function(t){n.display=t,F=n,h.execute("placementSettingsChanged",p)}))}};return{API:p={get name(){return l},get application(){var t=s();return t?t.application(at()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if("undefined"!=typeof window&&window.glue42gd)return c.servers().find((function(e){return e.windowId===t.id}));var e=at();return e?{application:e}:void 0},get url(){return y},id:t,get title(){return v},get windowStyleAttributes(){return k},get settings(){return k},get tabGroupId(){return"tab"===g.toLowerCase()?O:void 0},get frameButtons(){return R},get mode(){return g},get state(){return j},get isCollapsed(){return M},get isVisible(){return x},get isLocked(){return E},get context(){return m},get bounds(){return w},get minHeight(){return k.minHeight},get maxHeight(){return k.maxHeight},get minWidth(){return k.minWidth},get maxWidth(){return k.maxWidth},get isFocused(){return _},get frameColor(){return b},get opened(){return void 0!==p.id},get group(){return d},get groupId(){return A},get isSticky(){return P},get topNeighbours(){return st("top")},get leftNeighbours(){return st("left")},get rightNeighbours(){return st("right")},get bottomNeighbours(){return st("bottom")},get isGroupHeaderVisible(){return C},get activityId(){if(m._t42)return m._t42.activityId;var t=ct();return t?t.activityId:void 0},get activityWindowId(){if(m._t42)return m._t42.activityWindowId;var t=ct();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return W},get screen(){if("undefined"!=typeof window&&window.glue42gd)return _n.getMonitor(p.bounds,window.glue42gd.monitors)},get placementSettings(){return Object.assign({},F)},maximize:function(t,e){return new Promise((function(i,o){if("maximized"===j)return"function"==typeof t&&t(p),i(p);var r=K((function(e){"function"==typeof t&&t(p),r(),i(p)}));n.maximize(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},restore:function(t,e){return new Promise((function(i,o){if("normal"===j)return"function"==typeof t&&t(p),i(p);var r=Y((function(e){r(),"function"==typeof t&&t(p),i(p)}));n.restore(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},minimize:function(t,e){return new Promise((function(i,o){if("minimized"===j)return"function"==typeof t&&t(p),i(p);var r=Z((function(e){return r(),"function"==typeof t&&t(p),i(p)}));n.minimize(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},maximizeRestore:function(t,e){return new Promise((function(i,o){var r=("normal"===j?K:Y)((function(){r(),"function"==typeof t&&t(p),i(p)}));n.maximizeRestore(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},collapse:function(t,e){return new Promise((function(i,o){if(M)return"function"==typeof t&&t(p),i(p);var r=z((function(e){r(),"function"==typeof t&&t(p),i(p)}));n.collapse(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},expand:function(t,e){return new Promise((function(i,o){if(!M)return"function"==typeof t&&t(p),i(p);var r=J((function(){r(),"function"==typeof t&&t(p),i(p)}));n.expand(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},toggleCollapse:function(t,e){return new Promise((function(i,o){var r=(M?J:z)((function(){r(),"function"==typeof t&&t(p),i(p)}));n.toggleCollapse(p).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},focus:function(e,i){return new Promise((function(o,r){if(_)return"function"==typeof e&&e(p),void o(p);var s=nt((function(n){if(t===n.id&&n.isFocused)return s(),"function"==typeof e&&e(p),o(p)}));n.focus(p).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},activate:function(e,i){return new Promise((function(o,r){if(_)return"function"==typeof e&&e(p),void o(p);var s=nt((function(n){if(t===n.id&&n.isFocused)return s(),"function"==typeof e&&e(p),void o(p)}));n.activate(p).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},moveResize:N,setTitle:function(t,e,i){return new Promise((function(o,r){if(t===v)return"function"==typeof e&&e(p),void o(p);var s=H((function(n){n===t&&(s(),"function"==typeof e&&e(p),o(p))}));n.setTitle(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setStyle:function(t,e,i){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t}))){var o="Invalid style arguments: "+JSON.stringify(t);return"function"==typeof i?void i(o):Promise.reject(new Error(o))}if(t&&void 0!==t.focus){if("boolean"!=typeof t.focus){o="Focus must be boolean. Currently only focus true is supported ! "+JSON.stringify(t);return"function"==typeof i?void i(o):Promise.reject(new Error(o))}!1===t.focus&&f.warn("Focus false is not supported!")}if(t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden){o="hidden should be boolean";return"function"==typeof i?void i(o):Promise.reject(new Error(o))}for(var r=0,s=["minHeight","maxHeight","minWidth","maxWidth"];r<s.length;r++){var a=s[r];if(a in t&&"number"!=typeof t[a]){o=a+" should be number";return"function"==typeof i?void i(o):Promise.reject(new Error(o))}}return _n.callbackifyPromise((function(){return n.setStyle(p,t)}),e,i)},setOnTop:function(t,e,i){if(this.onTop===t){var o="OnTop setting is already set to '"+t+"'";return i(o),Promise.reject(new Error(o))}return _n.callbackifyPromise((function(){return n.setOnTop(p,t)}),e,i)},resetButtons:function(t,e,i){return _n.callbackifyPromise((function(){return n.resetButtons(p,t)}),e,i)},setSizeConstraints:function(t,e,i){if(!t||Object.keys(t).every((function(t){return void 0===t}))){var o="Invalid Constraints: "+JSON.stringify(t);return i(o),Promise.reject(new Error(o))}return _n.callbackifyPromise((function(){return n.setSizeConstraints(p,t)}),e,i)},navigate:function(t,e,i){return new Promise((function(o,r){var s=q((function(t,n){t===n.url&&(s(),"function"==typeof e&&e(p),o(p))}));n.navigate(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},addFrameButton:function(t,e,i){return new Promise((function(o,r){if(void 0===t)return"function"==typeof i?void i("No button info"):void r("No button info");if(void 0===t.buttonId)return"function"==typeof i?void i("No buttonId"):void r("No buttonId");if(void 0===t.imageBase64)return"function"==typeof i?void i("No imageBase64"):void r("No imageBase64");var s=U((function(){s(),"function"==typeof e&&e(p),o(p)}));n.addFrameButton(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},removeFrameButton:function(t,e,i){return new Promise((function(o,r){if(void 0===t||""===t)return"function"==typeof i?void i("No buttonId"):void r("No buttonId");var s=V((function(){s(),"function"==typeof e&&e(p),o(p)}));n.removeFrameButton(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setVisible:L,show:function(){return L(!0)},hide:function(){return L(!1)},center:function(t){return N(_n.getDisplayCenterOfScreen(p.bounds,t||p.screen))},close:function(e,i){return new Promise((function(o,r){if(!t){var s=new Error("The window is already closed.");return"function"==typeof i&&i(s.message),void r(s)}var a=B((function(){a(),"function"==typeof e&&e(p),o(p)}));n.close(p).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},snap:function(t,e,r,s){return i(this,void 0,void 0,(function(){var i,a,c;return o(this,(function(o){if(!t){if(c=new Error("Please specify a target window - "+t),"function"==typeof s)return s(c.message),[2];throw c}if("string"==typeof t){if(!(a=bn.get(t))){if(c=new Error("Invalid target parameter or no such window. Invoked with:  "+t),"function"==typeof s)return s(c.message),[2];throw c}i=a.API.group}else i=t.group;return[2,Promise.all([(u=i,new Promise((function(t,e){var n=u.onWindowAdded((function(e,i){p.id===i.id&&(n(),t())}))}))),n.snap(p,t,e)]).then((function(){return"function"==typeof r&&r(p),p})).catch((function(t){return"function"==typeof s&&s(t),t}))];var u}))}))},showLoader:function(t){return new Promise((function(e,i){n.showLoader(p,t).then((function(){e(p)})).catch((function(t){i(t)}))}))},hideLoader:function(){return new Promise((function(t,e){n.hideLoader(p).then((function(){t(p)})).catch((function(t){e(t)}))}))},updateContext:D,lock:function(t,e){return p.isLocked?("function"==typeof t&&t(p),Promise.resolve(p)):new Promise((function(i,o){n.lock(p).then((function(){return G()})).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},unlock:function(t,e){return p.isLocked?new Promise((function(i,o){n.unlock(p).then((function(){return G()})).then((function(){"function"==typeof t&&t(p),i(p)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))})):("function"==typeof t&&t(p),Promise.resolve(p))},getIcon:function(t,e){return new Promise((function(i,o){n.getIcon(p).then((function(e){"function"==typeof t&&t(e),i(e)})).catch((function(t){"function"==typeof e&&e(t),o(t)}))}))},setIcon:function(t,e,i){return new Promise((function(o,r){n.setIcon(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setFrameColor:function(t,e,i){return new Promise((function(o,r){var s=it((function(){s(),"function"==typeof e&&e(p),o(p)}));n.setFrameColor(p,t).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},setTabTooltip:function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){if(!t)throw new Error(t+" is null or undefined");return[2,n.setTabTooltip(p,t)]}))}))},attachTab:function(t,e,i,o){return new Promise((function(r,s){var a,c=p.id,u="Invalid tab parameter - should be an object with property id or a string. Invoked for source window id:"+p.id;if(t){if("string"==typeof t)a=t;else{if(void 0===t.id)return void s(u);a=t.id}var d={sourceWindowId:a,targetWindowId:c};e&&(d.index=e);var h=bn.get(d.sourceWindowId).API.onAttached((function(t){h(),"function"==typeof i&&i(p),r(p)}));n.attachTab(p,d).catch((function(t){"function"==typeof o&&o(t),h(),s(t)}))}else s(u)}))},detachTab:function(e,i,o){return new Promise((function(r,s){var a={windowId:p.id},c=e||{};void 0!==c.relativeTo&&("string"==typeof c.relativeTo?a.relativeTo=c.relativeTo:void 0!==c.relativeTo.id&&(a.relativeTo=c.relativeTo.id),void 0!==c.relativeDirection&&(a.relativeDirection=c.relativeDirection),void 0!==c.width&&(a.width=c.width),void 0!==c.height&&(a.height=c.height)),void 0!==c.bounds&&(a.bounds=c.bounds),void 0!==c.hideTabHeader&&(a.hideTabHeader=c.hideTabHeader);var u=!1,d=!1,f=h.add("frame-attached",(function(e){var n=void 0===c.hideTabHeader||c.hideTabHeader!==e.isTabHeaderVisible;t===e.id&&n&&(u=!0,f(),d&&("function"==typeof i&&i(p),r(p),"function"==typeof l&&l()))})),l=X((function(e){t===e.id&&(d=!0,l(),u&&("function"==typeof i&&i(p),r(p),"function"==typeof f&&f()))}));n.detachTab(p,a).catch((function(t){"function"==typeof o&&o(t),l(),f(),s(t)}))}))},setTabHeaderVisible:function(e,i,o){return new Promise((function(r,s){if(S===e)return"function"==typeof i&&i(p),r(p);var a=ot((function(n){n.id===t&&n.isTabHeaderVisible===e&&("function"==typeof i&&i(p),a(),r(p))}));n.setTabHeaderVisible(p,e).catch((function(t){"function"==typeof o&&o(t),s(t)}))}))},showPopup:function(t){return n.showPopup(p,t)},createFlydown:function(t){return n.createFlydown(p.id,t)},setModalState:function(t){return n.setModalState(p.id,t||!1)},setZoomFactor:function(t,e,i){return _n.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(p,t)}),e,i)},zoomIn:function(t,e){return _n.callbackifyPromise((function(){return n.zoomIn(p)}),t,e)},zoomOut:function(t,e){return _n.callbackifyPromise((function(){return n.zoomOut(p)}),t,e)},showDevTools:function(){return n.showDevTools(p)},capture:function(t){return n.capture(p,t)},flash:function(t,e){var i={shouldFlash:!0,mode:"auto"};return"boolean"==typeof t&&(i.shouldFlash=t),void 0!==e&&(i.mode=e),n.flash(p,i)},setSticky:function(t,e,i){return new Promise((function(o,r){n.setSticky(p,t).then((function(){"function"==typeof e&&e(p),o(p)})).catch((function(t){"function"==typeof i&&i(t),r(t)}))}))},print:function(t){return n.print(p,t)},printToPDF:function(t){return n.printToPDF(p,t)},place:function(t){return n.place(p,t)},ungroup:function(e){return new Promise((function(i,o){var r=rt((function(e,n,o){t===e.id&&(r(),i(p))}));n.ungroup(p,e).catch((function(t){r(),o(t)}))}))},onClose:B,onUrlChanged:q,onTitleChanged:H,onFrameButtonAdded:U,onFrameButtonRemoved:V,onFrameButtonClicked:function(t){return h.add("onFrameButtonClicked",t)},onCollapsed:z,onExpanded:J,onMinimized:Z,onMaximized:K,onNormal:Y,onAttached:function(t){return h.add("attached",t)},onDetached:X,onVisibilityChanged:Q,onContextUpdated:$,onLockingChanged:tt,onBoundsChanged:et,onFrameColorChanged:it,onFocusChanged:nt,onStickyChanged:function(t){return h.add("sticky-changed",t)},onGroupChanged:rt,onWindowAttached:function(t){return h.add("window-attached",t)},onWindowDetached:function(t){return h.add("window-detached",t)},onTabSelectionChanged:function(t){return h.add("tab-selection-changed",t)},onTabHeaderVisibilityChanged:ot,onClosing:function(e){if(!me(e))throw new Error("callback should be a function");return n.onClosing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!me(e))throw new Error("callback should be a function");return n.onRefreshing((function(t,n,i){var o=e(i);o&&o.then?o.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){if(!me(t))throw new Error("callback should be a function");return h.add("zoom-factor-changed",t)},onPlacementSettingsChanged:function(t){if(!me(t))throw new Error("callback should be a function");return h.add("placementSettingsChanged",t)},onNeighboursChanged:function(t){if(!me(t))throw new Error("callback should be a function");return h.add("neighbours-changed",t)},get tabs(){return t=bn.list,"tab"!==g.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var i=t[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==p.tabGroupId&&i.API.tabGroupId===p.tabGroupId&&e.push(i.API),e}),[]);var t},get isTabHeaderVisible(){return S},get isTabSelected(){return T},getURL:function(){return Promise.resolve(y)},getTitle:function(){return Promise.resolve(v)},getBounds:function(){return Promise.resolve(w)},getContext:function(){return Promise.resolve(m)},setContext:function(t){return D(t)},resizeTo:function(t,e){return N({width:t,height:e})},moveTo:function(t,e){return N({top:t,left:e})},getParentWindow:function(){var t;return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){return(e=k.parentInstanceId)?[2,null===(t=bn.list[e])||void 0===t?void 0:t.API]:[2,void 0]}))}))},getChildWindows:function(){return i(this,void 0,void 0,(function(){return o(this,(function(e){return[2,Object.keys(bn.list).map((function(t){return bn.list[t].API})).filter((function(e){return e.settings.parentInstanceId===t}))]}))}))}},Events:dt,Registry:h}},An=new(function(){function t(){this._registry=un()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,i){e.execute("close",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(i,o){n.execute("navigate",{windowId:t.id,options:{url:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setStyle=function(t,e){var n;return i(this,void 0,void 0,(function(){var i,r,s,a,c,u,d,p,h,f,l,g,y;return o(this,(function(o){switch(o.label){case 0:return i=[],r=function(t){return i.push(t)},void 0===e.focus||t.isFocused||r(t.focus()),void 0!==e.hidden&&(s=!e.hidden,r(t.setVisible(s))),void 0!==e.onTop&&r(t.setOnTop(e.onTop)),void 0===e.tabTooltip&&void 0===e.tabToolTip||(n=e.tabTooltip,a=null!=n?n:e.tabToolTip,r(t.setTabTooltip(a))),c=e.maxWidth,u=e.maxHeight,d=e.minWidth,p=e.minHeight,h=e.allowClose,f=e.allowCollapse,l=e.allowLockUnlock,g=e.allowMaximize,y=e.allowMinimize,r(t.setSizeConstraints({maxWidth:c,maxHeight:u,minWidth:d,minHeight:p})),r(t.resetButtons({allowClose:h,allowCollapse:f,allowLockUnlock:l,allowMaximize:g,allowMinimize:y})),[4,Promise.all(i)];case 1:return o.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setSizeConstraints",{windowId:t.id,options:e}).then((function(){i(t)})).catch(o)}))},t.prototype.setTabTooltip=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabTooltip",{windowId:t.id,options:{tabToolTip:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.resetButtons=function(t,e){var n=this;return new Promise((function(i,o){n.execute("resetButtons",{windowId:t.id,options:e}).then((function(){i(t)})).catch(o)}))},t.prototype.setOnTop=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setOnTop",{windowId:t.id,options:{onTop:e}}).then((function(){i(t)})).catch(o)}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(i,o){var r={windowId:t.id,options:{title:e}};n.execute("setTitle",r).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setSticky=function(t,e){var n=this;return new Promise((function(i,o){var r={windowId:t.id,options:{isSticky:e}};n.execute("setSticky",r).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(i,o){n.execute("moveResize",{windowId:t.id,options:{bounds:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(i,o){n.execute("addButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(i,o){n.execute("removeButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,i){e.execute("activate",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,i){e.execute("focus",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,i){e.execute("maximizeRestore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,i){e.execute("maximize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){e.execute("restore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,i){e.execute("minimize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,i){e.execute("collapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,i){e.execute("expand",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,i){e.execute("toggleCollapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.snap=function(t,e,n){var i=this;return new Promise((function(o,r){t.id;var s,a="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void r(a);s=e.id}var c={targetWindowId:s};n&&(c.snappingEdge=n),i.execute("snap",{windowId:t.id,options:c}).then((function(){o(t)})).catch((function(t){r(t)}))}else r(a)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(i,o){n.execute("attachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(i,o){n.execute("detachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setVisible=function(t,e){var n=this;return void 0===e&&(e=!0),new Promise((function(i,o){var r;r=e?"show":"hide",n.execute(r,{windowId:t.id}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(i,o){n.execute("showLoadingAnimation",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,i){e.execute("hideLoadingAnimation",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(i,o){n.execute("updateContext",{windowId:t.id,context:e,replace:!(Object.keys(t.context).length>0)}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!0}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!1}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,i){e.execute("getIcon",{windowId:t.id,options:{}}).then((function(t){n(t.icon)})).catch((function(t){i(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setIcon",{windowId:t.id,options:{dataURL:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(i,o){n.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}}).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.showPopup=function(t,e){return i(this,void 0,void 0,(function(){var i,r;return o(this,(function(o){switch(o.label){case 0:return e?((i=n({},e)).targetLocation||(i.targetLocation="bottom"),r=n(n({},i),{popupBounds:i.size,targetId:t.id,popupId:i.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:r})]):[2,Promise.reject("The options object is not valid!")];case 1:return o.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return i(this,void 0,void 0,(function(){var r,s,a=this;return o(this,(function(c){return e?((r=n({},e)).horizontalOffset||(r.horizontalOffset=0),r.verticalOffset||(r.verticalOffset=0),s=this.reformatFlydownOptions(t,r),[2,this.execute("setFlydownArea",{windowId:t,options:s}).then((function(){var t=s.zones.map((function(t){return t.id}));return s.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,r){return i(a,void 0,void 0,(function(){var i;return o(this,(function(o){switch(o.label){case 0:return e.size instanceof Function?[4,e.size(n,r)]:[3,2];case 1:i=o.sent(),o.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,r)]:[3,4];case 3:return[2,o.sent()||i];case 4:return[2,i||t.flydownSize]}}))}))}),a._registry.clearKey(s.targetId+"_"+t.id),a._registry.add(s.targetId+"_"+t.id,n)})),{destroy:function(){return a.clearFlydownArea(s.targetId,t)},options:r}}))]):[2,Promise.reject("The options object is not valid!")]}))}))},t.prototype.setModalState=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){return[2,this.execute("setModalState",{windowId:t,options:{isModal:e}})]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return i(this,void 0,void 0,(function(){var i,r,s,a,c;return o(this,(function(o){switch(o.label){case 0:return i=function(){return e.cancel=!0},r={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,r,i))];case 1:return 1===(s=o.sent()).length?(a={height:0,width:0,top:0,left:0},c="object"!=typeof s[0]||Array.isArray(s[0])?a:s[0],[2,n(n({},e),{flydownWindowBounds:c})]):[2]}}))}))},t.prototype.zoomIn=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:n({},e)})];case 1:return[2,i.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:n({groupWindowIds:t},e)})];case 1:return[2,i.sent().data]}}))}))},t.prototype.flash=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this.execute("flash",{windowId:t.id,options:n({},e)})];case 1:return i.sent(),[2,t]}}))}))},t.prototype.configure=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(i){return[2,this.execute("configure",{windowId:t,options:n({},e)})]}))}))},t.prototype.print=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this.execute("print",{windowId:t.id,options:n({},e)})];case 1:return i.sent(),[2,t]}}))}))},t.prototype.printToPDF=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this.execute("printToPDF",{windowId:t.id,options:n({},e)})];case 1:return[2,i.sent().filePath]}}))}))},t.prototype.place=function(t,e){return i(this,void 0,void 0,(function(){var i;return o(this,(function(o){return(i=n({},e)).display&&(i.display=i.display.index+1),[2,this.execute("place",{windowId:t.id,options:n({},i)})]}))}))},t.prototype.execute=function(t,e){var i=this;return new Promise((function(o,r){var s=n(n({},e),{command:t});i.agm.invoke("T42.Wnd.Execute",s,i.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?r(t):o(t.returned)})).catch((function(t){r(t)}))}))},t.prototype.setGroupHeaderVisible=function(t,e){return this.execute("setGroupHeaderVisibility",{windowId:t,options:{toShow:e}})},t.prototype.getGroupTitle=function(t){return this.execute("getGroupTitle",{windowId:t,options:{}}).then((function(t){return t.title}))},t.prototype.setGroupTitle=function(t,e){return this.execute("setGroupTitle",{windowId:t,options:{title:e}})},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.ungroup=function(t,e){var n=this;return new Promise((function(i,o){var r={windowId:t.id,options:e};n.execute("ungroup",r).then((function(){i(t)})).catch((function(t){o(t)}))}))},t.prototype.reformatFlydownOptions=function(t,e){var i=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var i=e[n];t[n]=i}},o=e.zones.map((function(t){return i(t,"windowId"),i(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return n(n({},e),{zones:o,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t}());function Cn(t,e){var n=bn.list;return Object.keys(n).reduce((function(i,o){var r=n[o];return r.API.tabGroupId===e&&r.API.id!==t&&(i[o]=r),i}),{})}var Sn=function(){function t(t,e,n,i,o,r){this._registry=un(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(o),this._windowId=r,this._appManagerGetter=n,this._displayAPIGetter=i}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,i,o){t.respondToEvent(e).then(i).catch(o)}));new Promise((function(i,o){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance,onData:function(n){t.updateWindow(n.data,e)},onConnected:function(e){t._agmInstance=t.normalizeInstance(e),An.init(t._agm,t._agmInstance)}}).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return An},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,i,o,r){var s=n({},i=i||{});void 0!==t?(void 0!==s.relativeTo&&"string"!=typeof s.relativeTo&&(s.relativeTo=s.relativeTo.id||""),s.name=t,s.url=e,s.windowState=i.windowState||i.state,delete s.state,this._agm.invoke("T42.Wnd.Create",s,this._agmInstance).then((function(t){if(void 0!==t.returned){var e=t.returned.id;o(e)}else r({message:"failed to execute T42.Wnd.Create - unknown reason"})})).catch(r)):r({message:"The name is undefined"})},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(i){switch(i.label){case 0:return n=bn.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this._agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this._agmInstance)},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t,e){var n=this,i=this.getExtendedStreamEvent(t);if("Snapshot"===t.type)return t.windows.forEach((function(t){var e=n.createWindow(t.id,t);bn.markReadyToShow(e.API.id),n._registry.execute("window-event",i)})),void e(this);if("Created"===t.type){var o=t,r=this.createWindow(o.windowId,o.data||{});return bn.setReadyState(r.API.id),void this._registry.execute("window-event",i)}var s=bn.get(t.windowId);if(s){var a=s.API,c=s.Events;if("BoundsChanged"===t.type){var u=t;c.handleBoundsChanged(u.data)}if("UrlChanged"===t.type){var d=t;bn.setUrlChangedState(d.windowId),c.handleUrlChanged(d.data)}if("TitleChanged"===t.type){var p=t;c.handleTitleChanged(p.data)}if("IsStickyChanged"===t.type){var h=t;c.handleIsStickyChanged(h.data)}if("VisibilityChanged"===t.type&&c.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&c.handleContextUpdated(t.data),"StateChanged"===t.type&&c.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(c.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",a)),"CompositionChanged"===t.type){var f=t;c.handleCompositionChanged(f.data.neighbors,f.data.groupId),this._registry.execute("composition-changed",f.data)}if("GroupHeaderVisibilityChanged"===t.type){var l=t;c.handleGroupHeaderVisibilityChanged(l.data.groupHeaderVisible),this._registry.execute("group-header-changed",l.data)}if("FocusChanged"===t.type){var g=t;this.focusChanged(c,a,g.data)}if("WindowFrameChanged"===t.type&&(c.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){c.handleAttached(t.data.frameId,t.data.isTabHeaderVisible);var y=Cn(a.id,t.data.frameId);Object.keys(y).forEach((function(t){y[t].Events.handleWindowAttached(a)})),this._registry.execute("tab-attached",a,t.data.frameId,t.data.isTabHeaderVisible)}if("WindowFrameRemoved"===t.type){var v=a.tabGroupId;c.handleDetached(t.data.frameId);var m=Cn(a.id,v);Object.keys(m).forEach((function(t){m[t].Events.handleWindowDetached(a)}));var w=this._registry.add("frame-changed",(function(){w(),n._registry.execute("tab-detached",a,t.data.frameId,a.tabGroupId)}))}"TabHeaderVisibilityChanged"===t.type&&c.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&c.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&c.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&c.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&c.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&c.handleZoomFactorChanged(t.data),"Closed"===t.type&&(bn.remove(s),c.handleWindowClose()),"FrameIsLockedChanged"===t.type&&c.handleFrameIsLockedChanged(t.data),"PlacementSettingsChanged"===t.type&&c.handlePlacementSettingsChanged(t.data),this._registry.execute("window-event",i)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))},t.prototype.createWindow=function(t,e){var n,i=bn.get(t),o=In(t,this.mapToWindowConstructorOptions(e),An,this._logger,this._appManagerGetter,this._displayAPIGetter,this._agm,null===(n=i)||void 0===n?void 0:n.Registry);return bn.add(o),o},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked,placementSettings:t.placementSettings,isSticky:t.isSticky}},t.prototype.getExtendedStreamEvent=function(t){try{var e=n({state:t.type,windowName:bn.get(t.windowId).API.name},t);return"WindowFrameAdded"===e.state&&(e.state="TabAttached"),"StateChanged"===e.state&&(e.state=e.data.charAt(0).toUpperCase()+e.data.slice(1)),"ButtonAdded"===e.state&&(e.state="FrameButtonAdded"),"ButtonRemoved"===e.state&&(e.state="FrameButtonRemoved"),e}catch(e){return t}},t}(),Tn=function(t,e){var n=un(),i=[];function o(){return new Promise((function(t,e){var n=c((function(e){n(),t()}))}))}function r(t,n,i,o){return new Promise((function(o,r){e.execute(t,n).then((function(t){"function"==typeof i&&i(u),o(u)})).catch((function(t){r(t)}))}))}function s(){var t=[];return i.forEach((function(e){var n=a(e);void 0!==n&&t.push(n)})),t}function a(t){return bn.get(t)?bn.get(t).API:void 0}function c(t){return n.add("header-visibility-changed",t)}var u={id:t,get windows(){return e=s(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e){if(!ve(t)){var n;n="string"==typeof t?t:t.id;var o=i.indexOf(n);if(-1!==o){var r=a(i[o]);return"function"==typeof e&&e(r),r}}},get isHeaderVisible(){return void 0===s().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,n){return new Promise((function(n,r){Promise.all([e.setGroupHeaderVisible(i[0],!0),o()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){r(t)}))}))},hideHeader:function(t,n){return new Promise((function(n,r){Promise.all([e.setGroupHeaderVisible(i[0],!1),o()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){}))}))},getTitle:function(){return e.getGroupTitle(i[0])},setTitle:function(t){return e.setGroupTitle(i[0],t)},capture:function(t){return e.captureGroup(i,t)},maximize:function(t,e){return r("maximizeGroup",{windowId:i[0]},t)},restore:function(t,e){return r("restoreGroup",{windowId:i[0]},t)},onHeaderVisibilityChanged:c,onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:u,groupInternal:{addWindow:function(t){if(-1===i.indexOf(t)){i.push(t);var e=bn.get(t);e.Events.handleGroupAssociation(u),n.execute("window-added",u,e.API)}},removeWindow:function(t){var e=i.indexOf(t);if(-1!==e){i.splice(e,1);var o=a(t);n.execute("window-removed",u,o)}},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",u)}}}},kn=function(t,e){var n=e.subLogger("groups"),i=un(),o={},r=-1,s=bn.list;function a(t,n){var i,r;if(void 0!==t)return i="string"==typeof t?t:t.id,Object.keys(o).forEach((function(t){var e=o[t].groupAPI;void 0===e.find(i)||(r=e)})),"function"==typeof n&&n(r),r;e.debug("trying to find a group by a window, but winId is undefined")}function c(t){n.trace("Adding new window "+t.API.id+" to win.API.groupId "+t.API.groupId);var e=u(t);e&&(n.trace("handleGroupAssociation "+t.API.id+" to group.groupAPI.id "+e.groupAPI.id),t.Events.handleGroupAssociation(e.groupAPI))}function u(e,i){var r=i||e.API.groupId,s=e.API.id;if(void 0!==r&&void 0!==s){var a=function(e){if(o.hasOwnProperty(e))return o[e];var n=Tn(e,t.executor);return o[e]=n,n}(r);return a.groupInternal.addWindow(s),a}n.debug("trying to add a window without group - winId: "+s)}function d(t,e){var n=t.API.id,i=e||t.API.groupId;void 0!==i&&(o[i].groupInternal.removeWindow(n),t.Events.handleGroupAssociation(void 0),function(t){o.hasOwnProperty(t)&&void 0!==o[t]&&0===o[t].groupAPI.windows.length&&delete o[t]}(i))}return Object.keys(s).forEach((function(t){c(s[t])})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,o=t.windowId,r=a(o),s=r?r.id:void 0;if(n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+o+" oldGroup: "+s),s===e)return void n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+o+" oldGroup: "+s+" are the same - returning...");var c=bn.get(o)||bn.get(o),p=u(c,e);r&&(d(c,s),i.execute("window-moved",o,r,e));c.Events.handleGroupChanged(p.groupAPI,r)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=a(t.windowId);if(void 0!==e){var n=o[e.id];-1===r&&(r=e.windows.length),0===--r&&(r=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),bn.onAdded((function(t){c(t)})),bn.onRemoved((function(t){d(t)})),{groupsAPI:{get my(){return a(t.my())},list:function(t){var e=Object.keys(o).map((function(t){if(o[t])return o[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:a},groupsEvents:{onWindowMoved:function(t){return i.add("window-moved",t)}}}},xn=function(t,e,n,i,o){var r,s,a=un(),c=e;bn.init(c);var u=new Promise((function(e,a){(function(t,e,n,i,o){var r=e;return new Promise((function(e,s){if(2===o)throw r.trace("running in HC"),new Error("GD2 not supported");if(o>=3)r.trace("running in GD 3"),new Sn(t,r,n,i,void 0,window.glue42gd.windowId).init().then(e).catch(s);else{var a=new Sn(t,r,n,i).init();Promise.race([a,(c=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),c)})))]).then(e).catch(s)}var c}))})(t,c,n,i,o).then((function(t){s=t,r=kn(t,c),e()})).catch((function(t){var e="Environment detector fails with: "+t;c.error(e),a(e)}))}));function d(){var t=bn.getIfReady(s.my());return t?t.API:void 0}function p(t){return a.add("window-added",t)}function h(t){return a.add("window-removed",t)}return bn.onReadyWindow((function(t){a.execute("window-added",t.API)})),bn.onRemoved((function(t){a.execute("window-removed",t.API)})),{my:d,open:function(t,e,n,i,o){return new Promise((function(r,a){var c=function(t){"function"==typeof o&&o(t),a(t)};s.open(t,e,n,(function(t){bn.waitFor(t).then((function(t){"function"==typeof i&&i(t.API),r(t.API),"electron"===t.API.windowType&&t.Events.handleUrlChanged(t.API.url)})).catch(c)}),c)}))},find:function(t,e,n){var i=bn.list,o=Object.keys(i).reduce((function(e,n){var o=i[n];return o&&o.API.name===t&&e.push(o.API),e}),[]);if("function"!=typeof e)return o[0];o.length>0?e(o[0]):"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var i=bn.list,o=Object.keys(i).reduce((function(e,n){var o=i[n];return void 0!==o&&o.API.id===t&&e.push(o.API),e}),[]);if("function"!=typeof e)return o[0];o.length>0?e(o[0]):"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=bn.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return u},onWindowAdded:p,windowAdded:p,onWindowRemoved:h,windowRemoved:h,onTabAttached:function(t){var e,n=!1;return u.then((function(){n||(e=s.tabAttached(t))})),function(){n=!0,e&&e()}},onTabDetached:function(t){var e,n=!1;return u.then((function(){n||(e=s.tabDetached(t))})),function(){n=!0,e&&e()}},onWindowFrameColorChanged:function(t){var e,n=!1;return u.then((function(){n||(e=s.onWindowFrameColorChanged(t))})),function(){n=!0,e&&e()}},get groups(){return r.groupsAPI},onWindowGotFocus:function(t){var e,n=!1;return u.then((function(){n||(e=s.onWindowGotFocus(t))})),function(){n=!0,e&&e()}},onWindowLostFocus:function(t){var e,n=!1;return u.then((function(){n||(e=s.onWindowLostFocus(t))})),function(){n=!0,e&&e()}},onEvent:function(t){var e,n=!1;return u.then((function(){n||(e=s.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return s.createFlydown(t,e)},showPopup:function(t,e){return s.showPopup(t,e)},configure:function(t){var e=d(),n=e?e.id:"";return An.configure(n,t)}}},Pn=new(function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}());var Mn=1;var jn,On,En,Rn={nextValue:function(){return(Mn=(9301*Mn+49297)%233280)/233280},seed:function(t){Mn=t}},Wn="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Fn(){En=!1}function Nn(t){if(t){if(t!==jn){if(t.length!==Wn.length)throw new Error("Custom alphabet for shortid must be "+Wn.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Wn.length+" unique characters. These characters were not unique: "+e.join(", "));jn=t,Fn()}}else jn!==Wn&&(jn=Wn,Fn())}function Ln(){return En||(En=function(){jn||Nn(Wn);for(var t,e=jn.split(""),n=[],i=Rn.nextValue();e.length>0;)i=Rn.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Dn={characters:function(t){return Nn(t),jn},seed:function(t){Rn.seed(t),On!==t&&(Fn(),On=t)},lookup:function(t){return Ln()[t]},shuffled:Ln},Gn="object"==typeof window&&(window.crypto||window.msCrypto);var Hn=function(){if(!Gn||!Gn.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return Gn.getRandomValues(t),48&t[0]};var Bn=function(t,e){for(var n,i=0,o="";!n;)o+=t(e>>4*i&15|Hn()),n=e<Math.pow(16,i+1),i++;return o};var qn,Un,Vn=function(t){var e=Dn.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var zn=function(t){var e="",n=Math.floor(.001*(Date.now()-1459707606518));return n===Un?qn++:(qn=0,Un=n),e+=Bn(Dn.lookup,6),e+=Bn(Dn.lookup,t),qn>0&&(e+=Bn(Dn.lookup,qn)),e+=Bn(Dn.lookup,n)};var Jn=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Dn.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},Kn=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=0;function n(){return zn(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return Dn.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&Dn.characters(t),Dn.shuffled()},t.exports.decode=Vn,t.exports.isValid=Jn})),Zn=(Kn.generate,Kn.seed,Kn.worker,Kn.characters,Kn.decode,Kn.isValid,Kn),Yn=function(){function t(t,e,n,i){this.config=t,this.activitiesGetter=e,this.callbacks=n,this.logger=i,this.interop=t.agm,this.registerRequestMethods()}return t.prototype.onSaveRequested=function(t){return this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,i=e.my.activity;return!(!i&&!n)&&i.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.interop.register("T42.HC.GetSaveContext",(function(e){var n,i,o,r=t.callbacks.execute("saveRequested",e);(null===(n=r)||void 0===n?void 0:n.length)>1&&t.logger.warn('Multiple subscriptions for "glue.layouts.onSaveRequested" - only the first one will be used');var s=r[0],a=t.config.autoSaveWindowContext;if(a)return{autoSaveWindowContext:a};var c={windowContext:null===(i=s)||void 0===i?void 0:i.windowContext,activityContext:void 0};return t.isActivityOwner()&&(c.activityContext=null===(o=s)||void 0===o?void 0:o.activityContext),c}))},t}();function Xn(t){if(!t)return t;if(Array.isArray(t))return t.map((function(t){return Xn(t)}));if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return t;return Object.keys(t).reduce((function(e,n){var i=Xn(t[n]),o=n;return n[0].toLowerCase()!==n[0]&&(o=n[0].toLowerCase()+n.substr(1)),e[o]=i,e}),{})}var Qn=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata,this.version=t.version,this.displays=t.displays},$n=function(){function t(t,e,n,i){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new Yn(t,t.activityGetter,n,i),e.subscribe()}return t.prototype.setDefaultGlobal=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:t})];case 1:return e.sent(),[2]}}))}))},t.prototype.clearDefaultGlobal=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")];case 1:return t.sent(),[2]}}))}))},t.prototype.getDefaultGlobal=function(){return i(this,void 0,void 0,(function(){var t,e;return o(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetDefaultLayout")];case 1:return t=n.sent(),(e=t.returned)?this.isSlimMode()?[2,e]:[2,this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))]:[2,void 0]}}))}))},t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var o={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var r=t.activityId;if(!r){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");r=e.appManager.myInstance.activityId}o.actIds.push(r),o.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");if(2===e.config.gdMajorVersion){var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),o)}else o.autoCollectApps=!0}e.invokeMethodAndTrack("T42.ACS.SaveLayout",o,n,i)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var o={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:t.closeRunningInstance,reuseExistingWindows:t.reuseWindows}},r={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};2===e.config.gdMajorVersion&&t.closeRunningInstance&&(r.toClose=e.getInstancesToClose(t)),t.timeout&&(r.timeout=t.timeout),r.context._t42=o,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",r,n,i,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(i,o){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var r={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",r,i,o)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),Pn.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(i,o){n.verifyNotSlimMode();var r={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",r,i,o,!0)}))},t.prototype.export=function(t){var e=this;return new Promise((function(n,i){e.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(i){var o=e.getObjectValues(i.Layouts).map((function(t){return new Qn(Xn(t))}));t&&(o=o.filter((function(e){return e.type=t}))),n(o)}),i,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(i,o){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var r={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",r,i,o)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,i){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var o={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",o,n,i,!0)}))},t.prototype.hibernate=function(t,e){var n=this;return new Promise((function(i,o){if(!t)return o("name cannot be empty");var r={name:t,type:"Global",context:(e=e||{}).context||{},metadata:e.metadata||{}};n.invokeMethodAndTrack("T42.ACS.HibernateLayout",r,i,o,!0)}))},t.prototype.resume=function(t,e,i){var o=this;return new Promise((function(r,s){if(!t)return s("name cannot be empty");var a=n({name:t,type:"Global",context:e},i);o.invokeMethodAndTrack("T42.ACS.ResumeLayout",a,r,s,!0)}))},t.prototype.getCurrentLayout=function(){return i(this,void 0,void 0,(function(){var t,e;return o(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})];case 1:return t=n.sent(),(e=t.returned.layout)?(this.isSlimMode()||(e=this.list().find((function(t){return t.name===e.name&&t.type===e.type}))),[2,e]):[2,void 0]}}))}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return Pn.all.length>0&&Pn.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRestored=function(t){return this.callbacks.add("restored",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.updateAppContextInCurrent=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var o={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",o,n,i,!0)}))},t.prototype.updateDefaultContext=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var o={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateDefaultContext",o,n,i,!0)}))},t.prototype.get=function(t,e){var n=this.list().find((function(n){return n.name===t&&n.type===e}));return n?Promise.resolve(n):Promise.reject("can not find layout with name="+t+" and type="+e)},t.prototype.getAll=function(t){var e=this.list().filter((function(e){return t===e.type}));return Promise.resolve(e)},t.prototype.isSlimMode=function(){return"slim"===this.config.mode},t.prototype.verifyNotSlimMode=function(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,i,o){var r,s=o,a=Zn();e.token=a;var c=function(){s&&r&&n(r)};o||this.stream.waitFor(a).then((function(){s=!0,c()})).catch((function(t){i(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||i("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&i(e.returned),r=e.returned,c()})).catch((function(t){return i(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],i=this.appManager.applications().filter((function(t){return t.isShell}))[0],o=i?i.name:"AppManager";return this.appManager.instances().forEach((function(i){e.appManager.myInstance&&i.id===e.appManager.myInstance.id||i.application.name!==o&&e.isVisibleWindow(i)&&("Activity"===t.type&&i.activityId!==t.activityIdToJoin||n.push({application:i.application.name,instance:i.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}(),ti=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return Xn(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var i=t.data;i.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(i.OnLayoutAdded)),e.removeLayouts(n(i.OnLayoutRemoved)),e.changeLayouts(n(i.OnLayoutChanged)),e.renameLayouts(n(i.OnLayoutRenamed)),e.restoredLayout(n(i.OnLayoutRestored)),e.callbacks.execute("streamEvent",i)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(i,o){var r=!1,s=n.onEvent((function(e){e.Token===t&&(r=!0,s(),i())}));setTimeout((function(){r||o("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new Qn(t);Pn.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){Pn.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){Pn.removeWhere((function(n){return!e.compareLayouts(n,t)})),Pn.add(new Qn(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=Pn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t.prototype.restoredLayout=function(t){var e=this;t&&t.forEach((function(t){var n=Pn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.name})}));e.callbacks.execute("restored",n)}))},t}();function ei(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim";var e,n=t.logger,i=un();return t.mode,e=new ti(t.agm,i),new $n(t,e,i,n)}var ni,ii,oi,ri=function(t,e){var r=this;this._agm=t,this._logger=e,this.all=function(){return i(r,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.callGD(ni.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return i(r,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,this.callGD(ni.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.getPrimary=function(){return i(r,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.all()];case 1:return[2,t.sent().find((function(t){return t.isPrimary}))]}}))}))},this.capture=function(t){return i(r,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.callGD(ni.Capture,n({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return i(r,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.callGD(ni.CaptureAll,n({},t))];case 1:return[2,e.sent()]}}))}))},this.getMousePosition=function(){return i(r,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.callGD(ni.GetMousePosition)];case 1:return[2,t.sent()]}}))}))},this.callGD=function(t,e){return i(r,void 0,void 0,(function(){return o(this,(function(i){switch(i.label){case 0:return[4,this._agm.invoke("T42.Displays.Command",{options:n({},e),command:t})];case 1:return[2,i.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return n(n({},t),{capture:function(e){return r.capture({id:t.id,size:e})}})}};function si(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){return ii.invoke("T42.Channels.Announce",{swId:null!=e?e:oi,command:"switchChannel",data:{newChannel:t}}),[2]}))}))}!function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get",t.GetMousePosition="getMousePosition"}(ni||(ni={}));var ai="___channel___",ci=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,i,o,r){var s;e(t.data,t,null===(s=r)||void 0===s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return i(this,void 0,void 0,(function(){var e,n,i=this;return o(this,(function(o){switch(o.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,o,r){var s;i.callback&&i.callback(t.data,t,null===(s=r)||void 0===s?void 0:s.updaterId)}))];case 1:return n.unsubscribeFunc=o.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(ai)})).map((function(t){return t.substr(ai.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var o=e.createContextName(t);e.contexts.subscribe(o,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var i=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,i)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return ai+t},t}(),ui=function(){function t(t){this.shared=t,this.subsKey="subs",this.changedKey="changed",this.registry=un(),this.shared.subscribe(this.handler.bind(this))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");return this.shared.isChannel(e)?[2,this.shared.updateData(e,t)]:[2,Promise.reject(new Error("A channel with name: "+e+" doesn't exist!"))]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return i(this,void 0,void 0,(function(){var t,e=this;return o(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){return[2,this.joinCore(t)]}))}))},t.prototype.joinNoSelectorSwitch=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){return[2,this.joinCore(t,!1)]}))}))},t.prototype.leave=function(){return this.leaveCore()},t.prototype.leaveNoSelectorSwitch=function(){return this.leaveCore(!1)},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t.prototype.joinCore=function(t,e){return void 0===e&&(e=!0),i(this,void 0,void 0,(function(){var n,i=this;return o(this,(function(o){switch(o.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return t===this.currentContext?[2]:(n=function(t){return i.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(e,i){var o,r=setInterval((function(){n(t)&&(clearTimeout(o),clearInterval(r),e())}),100);o=setTimeout((function(){return clearInterval(r),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:o.sent(),o.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return o.sent(),e&&si(t),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leaveCore=function(t){return void 0===t&&(t=!0),this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),t&&si(),Promise.resolve()},t}();function di(t,e){var n=new ci(t),r=new ui(n);return function(t,e){i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return ii=t,"undefined"!=typeof window&&window.glue42gd&&(oi=window.glue42gd.windowId),oi?[4,ii.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:i=e.current()};throw new Error("unknown command "+n)}e.leaveNoSelectorSwitch()}else{var i;if(!(i=t.channel))throw new Error("missing argument id");e.joinNoSelectorSwitch(i)}}))]:[2];case 1:return n.sent(),ii.invoke("T42.Channels.Announce",{swId:oi,instance:ii.instance.instance}),[2]}}))}))}(e,r),{subscribe:r.subscribe.bind(r),subscribeFor:r.subscribeFor.bind(r),publish:r.publish.bind(r),all:r.all.bind(r),list:r.list.bind(r),get:r.get.bind(r),join:r.join.bind(r),leave:r.leave.bind(r),current:r.current.bind(r),my:r.my.bind(r),changed:r.changed.bind(r),onChanged:r.onChanged.bind(r),add:r.add.bind(r),ready:function(){return t.ready()}}}var pi="T42.Hotkeys.Command",hi=function(){function t(t){this.agm=t,this.registry=un(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(i){switch(i.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke(pi,{command:"register",hotkey:n,description:t.description})];case 3:return i.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke(pi,{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke(pi,{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),i=t.hotkeys.get(n);t.registry.execute(n,i)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();var fi="5.5.0",li=function(t){function e(t,e,n){if("boolean"!=typeof t||t){var i=function t(e,n,i){if("object"==typeof e)return t(e.mode,n,i)+"";if(void 0===e)return"boolean"!=typeof n||n?n+"":void 0;if("boolean"==typeof e)return e?(void 0===i?n:i)+"":void 0;return e+""}(t,e,n);return"object"==typeof t?(t.mode=i,t):{mode:i}}}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}},gi=function(){function t(t){this.options=t,this.callbacks=un(),this.actions=t.actions,this.body=t.body,this.badge=t.badge,this.data=t.data,this.dir=t.dir,this.icon=t.icon,this.image=t.image,this.lang=t.lang,this.renotify=t.renotify,this.requireInteraction=t.requireInteraction,this.silent=t.silent,this.tag=t.tag,this.timestamp=t.timestamp,this.title=t.title}return t.prototype.close=function(){throw new Error("Method not implemented.")},t.prototype.addEventListener=function(t,e,n){this.callbacks.add(t,e)},t.prototype.removeEventListener=function(t,e,n){},t.prototype.dispatchEvent=function(t){return this.callbacks.execute(t.type,t),!0},t}(),yi=function(){function t(t){this.interop=t,this.methodsRegistered=!1,this.methodNameRoot="T42.Notifications.Handler-"+Zn(),this.nextId=0,this.notifications={}}return Object.defineProperty(t.prototype,"maxActions",{get:function(){return 2},enumerable:!0,configurable:!0}),t.prototype.raise=function(t){var e,n;return i(this,void 0,void 0,(function(){var i,r,s,a,c,u,d,p,h,f,l;return o(this,(function(o){switch(o.label){case 0:if(!t)throw new Error("invalid options - should be an object");if(!t.title)throw new Error("invalid options - should have title");if(this.methodsRegistered)return[3,2];for(i=[],c=0;c<this.maxActions;c++)i.push(this.interop.register(this.methodNameRoot+"_"+c,this.handleNotificationAction.bind(this)));return[4,Promise.all(i)];case 1:o.sent(),this.methodsRegistered=!0,o.label=2;case 2:if(r=String(this.nextId++),s={title:t.title,severity:"Medium",description:t.body,glueRoutingDetailMethodName:this.methodNameRoot+"_0",actions:[],source:r},t.actions)for(a=t.actions.slice(0,this.maxActions),c=0,u=function(t){var i={g42notificationId:r,g42action:t.action,g42interopMethod:null===(e=t.interop)||void 0===e?void 0:e.method,g42interopTarget:null===(n=t.interop)||void 0===n?void 0:n.target},o=Object.keys(i).map((function(t){return{name:t,value:{stringValue:i[t]}}})),a={name:d.methodNameRoot+"_"+c,description:t.title,displayName:t.title,parameters:o};s.actions.push(a),c++},d=this,p=0,h=a;p<h.length;p++)f=h[p],u(f);return[4,this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:s})];case 3:return o.sent(),l=new gi(t),this.notifications[r]=l,[2,l]}}))}))},t.prototype.handleNotificationAction=function(t){if(t.g42notificationId){var e=t,n=e.g42notificationId;if(!(r=this.notifications[n]))return;var i=new Event("onaction");i.action=e.g42action,r.onaction&&r.onaction(i);var o=(r.actions||[]).find((function(t){return t.action===e.g42action})).interop;o&&this.interop.invoke(o.method,o.arguments||{},o.target||"best"),r.dispatchEvent(i)}else if(t.notification&&t.notification.source){var r;n=t.notification.source;if(!(r=this.notifications[n]))return;var s=new Event("onclick");r.onclick&&r.onclick(s);var a=r.options.clickInterop;a&&this.interop.invoke(a.method,a.arguments||{},a.target||"best"),r.dispatchEvent(s)}},t}(),vi=function(){function t(t){this.core=t,this.registry=un(),this.isSubscribed=!1,this.getConfiguration()}return t.prototype.list=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:if(t.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,t.sent().returned.all]}}))}))},t.prototype.getCurrent=function(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,(t=e.sent()).returned.all.find((function(e){return e.name===t.returned.selected}))]}}))}))},t.prototype.select=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.setMethodName)throw new Error("not supported");return[4,this.core.interop.invoke(this.setMethodName,{theme:t})];case 2:return e.sent(),[2]}}))}))},t.prototype.onChanged=function(t){return this.subscribe(),this.registry.add("changed",t)},t.prototype.getConfiguration=function(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.sharedContextName?[2]:[4,this.core.interop.invoke("T42.Themes.Configuration")];case 1:return t=e.sent(),this.sharedContextName=t.returned.sharedContextName,this.getMethodName=t.returned.getThemesMethodName,this.setMethodName=t.returned.setThemesMethodName,[3,3];case 2:return e.sent(),[2];case 3:return[2]}}))}))},t.prototype.getAll=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:return t.sent(),[4,this.core.interop.invoke(this.getMethodName)];case 2:return[2,t.sent()]}}))}))},t.prototype.subscribe=function(){return i(this,void 0,void 0,(function(){var t=this;return o(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:return e.sent(),this.isSubscribed?[2]:(this.isSubscribed=!0,this.core.contexts.subscribe(this.sharedContextName,(function(e){e&&e.all&&e.selected&&t.registry.execute("changed",e.all.find((function(t){return t.name===e.selected})))})),[2])}}))}))},t}();var mi,wi="Tick42.FDC3.Intents.",bi=function(){function t(t,e,n){this.interop=t,this.windows=e,this.logger=n}return t.prototype.find=function(t){return i(this,void 0,void 0,(function(){var e,n;return o(this,(function(i){switch(i.label){case 0:return[4,this.all()];case 1:if(e=i.sent(),void 0===t)return[2,e];if("string"==typeof t)return[2,e.filter((function(e){return e.name===t}))];if("object"!=typeof t)throw new Error("Please provide the intentFilter as a string or an object!");return t.contextType&&(n=t.contextType.toLowerCase(),e=e.filter((function(t){return t.handlers.some((function(t){var e;return null===(e=t.contextTypes)||void 0===e?void 0:e.some((function(t){return t.toLowerCase()===n}))}))}))),t.name&&(e=e.filter((function(e){return e.name===t.name}))),[2,e]}}))}))},t.prototype.raise=function(t){return i(this,void 0,void 0,(function(){var e,n,i,r,s,a,c,u,d;return o(this,(function(o){switch(o.label){case 0:if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");return"string"==typeof t&&(t={intent:t}),e=t.intent,[4,this.get(e)];case 1:if(void 0===(n=o.sent()))throw new Error("Intent "+e+" not found.");if(i=!n.handlers.some((function(t){return"app"===t.type})),r=t.target||(i?"reuse":"startNew"),a=n.handlers.find((function(t){return"app"===t.type})),"startNew"===r)s=a;else if("reuse"===r)c=n.handlers.find((function(t){return"instance"===t.type})),s=c||a;else if(r.instance)s=n.handlers.find((function(t){return"instance"===t.type&&t.instanceId===r.instance}));else{if(!r.app)throw new Error("Invalid intent target: "+JSON.stringify(r));s=n.handlers.find((function(t){return"app"===t.type&&t.applicationName===r.app}))}if(!s)throw new Error("Can not raise intent for request "+JSON.stringify(t)+" - can not find intent handler.");return u=s.instanceId,"app"!==s.type?[3,3]:[4,this.startApp(s.applicationName,t.options)];case 2:u=o.sent(),o.label=3;case 3:return[4,this.raiseIntentToInstance(u,e,t.context)];case 4:return(d=o.sent()).request=t,d.handler=s,[2,d]}}))}))},t.prototype.all=function(){return i(this,void 0,void 0,(function(){var t,e,n,r,s,a,c,u,d,p,h,f,l,g,y,v,m,w,b,_,I,A=this;return o(this,(function(C){switch(C.label){case 0:return C.trys.push([0,2,,3]),[4,this.interop.invoke("T42.ACS.GetApplications",{withIntentsInfo:!0})];case 1:return m=C.sent(),t=m.returned.applications,[3,3];case 2:return e=C.sent(),this.logger.error("Failed to get the applications!",e),[2,[]];case 3:for(n={},r=t.filter((function(t){return t.intents&&t.intents.length>0})),s=0,a=r;s<a.length;s++)for(c=a[s],u=0,d=c.intents;u<d.length;u++)p=d[u],(h=n[p.name])||(h={name:p.name,handlers:[]},n[p.name]=h),f={applicationName:c.name,applicationTitle:c.title,applicationDescription:c.caption,displayName:p.displayName,contextTypes:p.contexts,applicationIcon:c.icon,type:"app"},h.handlers.push(f);if(l=this.interop.servers(),g=l.map((function(t){return t.windowId})).filter((function(t){return void 0!==t})),y="T42.Wnd.GetInfo",!this.interop.methods().some((function(t){return t.name===y})))return[3,7];C.label=4;case 4:return C.trys.push([4,6,,7]),[4,this.interop.invoke(y,{ids:g})];case 5:return m=C.sent(),v=m.returned.windows,[3,7];case 6:return C.sent(),[3,7];case 7:w=function(e){return o(this,(function(r){switch(r.label){case 0:return[4,Promise.all(e.getMethods().filter((function(t){return t.name.startsWith(wi)})).map((function(r){return i(A,void 0,void 0,(function(){var i,s,a,c,u,d,p,h,f,l,g,y;return o(this,(function(o){switch(o.label){case 0:return i=r.name.replace(wi,""),(s=n[i])||(s={name:i,handlers:[]},n[i]=s),a=r.flags,(c=t.find((function(t){return t.name===e.application})))&&c.intents&&(u=c.intents.find((function(t){return t.name===i}))),[4,this.windowsIdToTitle(e.windowId,v)];case 1:return d=o.sent(),p={instanceId:e.instance,applicationName:e.application,applicationIcon:a.icon||(null===(h=c)||void 0===h?void 0:h.icon),applicationTitle:null===(f=c)||void 0===f?void 0:f.title,applicationDescription:a.description||(null===(l=c)||void 0===l?void 0:l.caption),displayName:a.displayName||(null===(g=u)||void 0===g?void 0:g.displayName),contextTypes:a.contextTypes||(null===(y=u)||void 0===y?void 0:y.contexts),instanceTitle:d,type:"instance"},s.handlers.push(p),[2]}}))}))})))];case 1:return r.sent(),[2]}}))},b=0,_=l,C.label=8;case 8:return b<_.length?(I=_[b],[5,w(I)]):[3,11];case 9:C.sent(),C.label=10;case 10:return b++,[3,8];case 11:return[2,Object.values(n)]}}))}))},t.prototype.addIntentListener=function(t,e){var n=this;if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");if("function"!=typeof e)throw new Error("Please provide the handler as a function!");var i={unsubscribe:function(){return console.log("Could not unsubscribe!")}},o="Tick42.FDC3.Intents."+("string"==typeof t?t:t.intent),r="string"==typeof t?{intent:t}:t;return this.interop.register({name:o,flags:r},(function(t){return e(t)})).then((function(){i.unsubscribe=function(){n.interop.unregister(o)}})),i},t.prototype.get=function(t){return i(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.all()];case 1:return[2,e.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.startApp=function(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,this.interop.invoke("T42.ACS.StartApplication",{Name:t,options:e})];case 1:return[2,n.sent().returned.Id]}}))}))},t.prototype.raiseIntentToInstance=function(t,e,n){return i(this,void 0,void 0,(function(){var i,r,s=this;return o(this,(function(o){switch(o.label){case 0:return i="Tick42.FDC3.Intents."+e,(r=this.interop.servers().find((function(e){return e.instance===t})))?[3,2]:[4,new Promise((function(e,n){var i,o=s.interop.serverAdded((function(n){n.instance===t&&(r=n,e(),clearTimeout(i),o())}));i=setTimeout((function(){o(),n(new Error("Can not find interop server for instance "+t))}),3e4)}))];case 1:o.sent(),o.label=2;case 2:return r.getMethods().find((function(t){return t.name===i}))?[3,4]:[4,new Promise((function(e,n){var o,r=s.interop.methodAdded((function(t){t.name===i&&(e(),clearTimeout(o),r())}));o=setTimeout((function(){r(),n(new Error("Can not find interop method "+i+" for instance "+t))}),1e4)}))];case 3:o.sent(),o.label=4;case 4:return[4,this.interop.invoke(i,n,{instance:t})];case 5:return[2,{result:o.sent().returned}]}}))}))},t.prototype.windowsIdToTitle=function(t,e){var n,r,s;return i(this,void 0,void 0,(function(){var i;return o(this,(function(o){switch(o.label){case 0:return void 0!==e?[2,null===(n=e.find((function(e){return e.id===t})))||void 0===n?void 0:n.title]:(i=null===(r=this.windows)||void 0===r?void 0:r.findById(t),[4,null===(s=i)||void 0===s?void 0:s.getTitle()]);case 1:return[2,o.sent()]}}))}))},t}(),_i=function(){function t(){var t=this;this.numberOfCalls=0,this.numberOfCalls=1,this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))}return t.prototype.getPromise=function(){return this.numberOfCalls++,this.promise},t.prototype.done=function(t){this.resolve(t)},t.prototype.error=function(t){this.reject(t)},t}(),Ii=function(t){return i(void 0,void 0,void 0,(function(){var e,n,i;return o(this,(function(o){switch(o.label){case 0:if(e="undefined"!=typeof window&&window.glue42gd){if(mi)return[2,mi.getPromise()];mi=new _i}return[4,Ai(t,e)];case 1:return n=o.sent(),null===(i=mi)||void 0===i||i.resolve(n),[2,n]}}))}))},Ai=function(t,e){return i(void 0,void 0,void 0,(function(){function n(t){if(y.windows){var e=f("windows",t.logger,y.windows);return l(w=xn(t.agm,e,(function(){return v}),(function(){return b}),g)),w}}function i(t){var n,i;if(y.activities&&on.checkIsUsingGW3Implementation&&on.checkIsUsingGW3Implementation(t.connection)){var o=f("activity",t.logger,y.activities);return l(m=new on({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:o,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"exit",announcementInfo:null,windows:w,appManagerGetter:function(){return v},mode:y.activities.mode,typesToTrack:y.activities.typesToTrack,activityId:null===(i=null===(n=e)||void 0===n?void 0:n.activityInfo)||void 0===i?void 0:i.activityId,gdMajorVersion:g}).api),m}}function r(t){if(y.appManager){var e=f("appManager",t.logger,y.appManager);return l(v=wn({agm:t.agm,windows:w,logger:e,activities:m,mode:y.appManager.mode,gdMajorVersion:g})),v}}function s(t){var e;if(y.layouts){var n=f("layouts",t.logger,y.layouts),i=y.layouts,o=ei({agm:t.agm,appManager:v,activityGetter:function(){return m},logger:n,mode:i.mode,autoSaveWindowContext:(e=i.autoSaveWindowContext,null!=e&&e),gdMajorVersion:g});return l(o),o}}function a(t){if(y.channels&&t.contexts){var e=di(t.contexts,t.agm);return l(e),e}}function c(t){var e,n,i=(e=t.agm,{register:(n=new hi(e)).register.bind(n),unregister:n.unregister.bind(n),unregisterAll:n.unregisterAll.bind(n),isRegistered:n.isRegistered.bind(n),ready:function(){return Promise.resolve()}});return l(i),i}function u(t){var e=new bi(t.agm,w,t.logger.subLogger("intents"));return l(e),e}function d(t){var e=new yi(t.interop);return l(e),e}function p(t){if(y.displays){var e=f("displays",t.logger,y.displays);return l(b=new ri(t.agm,e)),b}}function h(t){if(t.contexts){var e=function(t){var e=new vi(t);return{list:e.list.bind(e),getCurrent:e.getCurrent.bind(e),select:e.select.bind(e),onChanged:e.onChanged.bind(e),ready:function(){return Promise.resolve()}}}(t);return l(e),e}}function f(t,e,n){var i=e.subLogger(t);if(n&&n.logger){var o=n.logger;o.console&&i.consoleLevel(o.console),o.publish&&i.publishLevel(o.publish)}return i}function l(t){I.push(t)}var g,y,v,m,w,b,_,I,A,C;return o(this,(function(e){switch(e.label){case 0:return g=_n.getGDMajorVersion(),y=li(t=t||{}),t.gateway=t.gateway||{},_={libs:[{name:"windows",create:n},{name:"activities",create:i},{name:"appManager",create:r},{name:"layouts",create:s},{name:"channels",create:a},{name:"hotkeys",create:c},{name:"displays",create:p},{name:"intents",create:u},{name:"notifications",create:d},{name:"themes",create:h}],version:fi,enrichGlue:function(t){t.config.activities=y.activities,t.config.windows=y.windows,t.config.appManager=y.appManager,t.config.layouts=y.layouts,t.config.channels=y.channels,t.config.displays=y.displays}},I=[],"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(I)),[4,he(t,_)];case 1:return A=e.sent(),Array.isArray(null===(C=t)||void 0===C?void 0:C.libraries)&&t.libraries.length?[4,Promise.all(t.libraries.map((function(e){return e(A,t)})))]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2,A]}}))}))};Ii.coreVersion=he.version,Ii.version=fi,Ii.initInfo=mi;var Ci=Ii,Si=!0;if("undefined"!=typeof window){var Ti=window.glue42gd;Ti&&Ti.autoInjected&&(Ci=window.Glue,Si=!1),Si&&(window.Glue=Ci),delete window.GlueCore}return Ci.default=Ci,Ci}));
//# sourceMappingURL=desktop.umd.min.js.map
